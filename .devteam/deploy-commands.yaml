# Arquivo mantido pelo Deployer
# Contém TODOS os comandos aprendidos para deploy
# Atualizado sempre que um novo comando é descoberto

version: 9
last_updated: "2026-02-22T03:15:00"
updated_by: "devteam-deployer"

services:
  supabase:
    description: "Backend e banco de dados (Supabase - projeto poizgglzdjqwrhsnhkke)"
    region: "South America (Sao Paulo)"

    setup:
      - name: "Linkar projeto"
        command: "supabase link --project-ref $PROJECT_REF"
        when: "Primeira vez ou trocar de projeto"
        notes: "PROJECT_REF=poizgglzdjqwrhsnhkke"

    migrations:
      - name: "Aplicar migrations (via CLI)"
        command: "supabase db push"
        when: "Apos criar/alterar migrations em supabase/migrations/"
        notes: "Requer conexao direta ao PostgreSQL na porta 5432 ou 6543"

      - name: "Aplicar migrations (via Management API)"
        command: |
          TOKEN_RAW=$(security find-generic-password -s "Supabase CLI" -w)
          TOKEN=$(echo "$TOKEN_RAW" | sed 's/go-keyring-base64://' | base64 -d)
          curl -s -X POST "https://api.supabase.com/v1/projects/poizgglzdjqwrhsnhkke/database/query" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query": "<SQL_HERE>"}'
        when: "Quando porta 5432/6543 estiver bloqueada pelo firewall (ex: sandbox)"
        notes: "Usa HTTPS (porta 443) via Management API. Token fica no macOS Keychain."

      - name: "Verificar SECURITY DEFINER em funcao"
        command: |
          SQL="SELECT proname, prosecdef FROM pg_proc WHERE proname = '<FUNCTION_NAME>';"
        when: "Validar que migration de SECURITY DEFINER foi aplicada"
        notes: "prosecdef=true significa SECURITY DEFINER ativo"

      - name: "Verificar triggers de uma tabela"
        command: |
          SQL="SELECT trigger_name, event_manipulation, action_statement FROM information_schema.triggers WHERE trigger_name = '<TRIGGER_NAME>';"
        when: "Validar que trigger esta corretamente associado"

      - name: "Verificar constraints de uma tabela"
        command: |
          SQL="SELECT conname, contype, pg_get_constraintdef(oid) as definition FROM pg_constraint WHERE conrelid = '<TABLE>'::regclass ORDER BY conname;"
        when: "Validar que migration de constraint foi aplicada"

      - name: "Verificar search_path de funcoes"
        command: |
          SQL="SELECT proname, pronamespace::regnamespace AS schema, proconfig FROM pg_proc WHERE proname IN ('<FUNC1>', '<FUNC2>');"
        when: "Validar que SET search_path foi aplicado a funcoes"
        notes: "proconfig deve conter search_path=\"\" (vazio) para funcoes seguras"

      - name: "Reset completo (dev)"
        command: "supabase db reset"
        when: "Quer resetar banco local com seed"

    functions:
      - name: "Deploy todas as functions"
        command: "supabase functions deploy"
        when: "Apos alterar qualquer edge function"

      - name: "Deploy function especifica"
        command: "supabase functions deploy <function-name>"
        when: "Alterar apenas uma function"

      - name: "Deploy function publica (sem JWT)"
        command: "supabase functions deploy <function-name> --no-verify-jwt"
        when: "Alterar function que nao requer autenticacao (ex: reset-redirect, send-reset-email)"
        notes: "Usa flag --no-verify-jwt para desabilitar verificacao de JWT. Necessario para endpoints publicos."

    auth_config:
      - name: "Ler configuracao de autenticacao"
        command: |
          TOKEN_RAW=$(security find-generic-password -s "Supabase CLI" -w)
          TOKEN=$(echo "$TOKEN_RAW" | sed 's/go-keyring-base64://' | base64 -d)
          curl -s "https://api.supabase.com/v1/projects/poizgglzdjqwrhsnhkke/config/auth" \
            -H "Authorization: Bearer $TOKEN"
        when: "Verificar site_url, uri_allow_list (redirect URLs), ou qualquer config de auth"
        notes: "Retorna JSON com todas as configuracoes de auth do projeto"

      - name: "Atualizar configuracao de autenticacao"
        command: |
          TOKEN_RAW=$(security find-generic-password -s "Supabase CLI" -w)
          TOKEN=$(echo "$TOKEN_RAW" | sed 's/go-keyring-base64://' | base64 -d)
          curl -s -X PATCH "https://api.supabase.com/v1/projects/poizgglzdjqwrhsnhkke/config/auth" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"site_url":"<NEW_URL>","uri_allow_list":"<COMMA_SEPARATED_URLS>"}'
        when: "Atualizar site_url, redirect URLs, ou qualquer config de auth"
        notes: "PATCH aceita campos parciais. Campos nao enviados nao sao alterados."

    secrets:
      - name: "Listar secrets configurados"
        command: "supabase secrets list"
        when: "Verificar quais secrets estao configurados"

      - name: "Configurar secret Resend API Key"
        command: "supabase secrets set RESEND_API_KEY=<your-resend-api-key>"
        when: "Configurar API key do Resend para envio de emails (Edge Function send-reset-email)"
        notes: "Obter API key em https://resend.com/api-keys. Necessario para Edge Function send-reset-email."

      - name: "Configurar secret Resend From Email"
        command: 'supabase secrets set RESEND_FROM_EMAIL="Sacrament Meeting Planner <noreply@yourdomain.com>"'
        when: "Configurar email remetente para emails de reset de senha"
        notes: "Dominio deve estar verificado no Resend. Para testes, usar onboarding@resend.dev."

      - name: "Configurar secrets em batch"
        command: |
          supabase secrets set RESEND_API_KEY=<key> RESEND_FROM_EMAIL="Sacrament Meeting Planner <noreply@yourdomain.com>"
        when: "Configurar multiplos secrets de uma vez"

    logs:
      - name: "Ver logs de functions"
        command: "supabase functions logs --scroll"
        when: "Debug de edge functions"

  expo:
    description: "App mobile React Native (Expo SDK 54)"
    dev:
      - name: "Iniciar dev server"
        command: "npx expo start"
        when: "Desenvolvimento local"

      - name: "Limpar cache e reiniciar"
        command: "npx expo start --clear"
        when: "Apos instalar dependencias ou problemas de cache"

    build:
      - name: "Build development"
        command: "eas build --profile development --platform all"
        when: "Criar build de desenvolvimento"

app_restart:
  expo:
    - name: "Restart dev server"
      command: "pkill -f 'expo start' && npx expo start"
      when: "Reiniciar apos mudancas de config"

    - name: "Reload no dispositivo"
      command: "Shake device ou Cmd+R (iOS) / R,R (Android)"
      when: "Testar mudancas de codigo"

env_variables:
  supabase:
    required:
      - SUPABASE_URL
      - SUPABASE_ANON_KEY
      - SUPABASE_SERVICE_ROLE_KEY
    optional:
      - PROJECT_REF
    file: ".env"

  supabase_secrets:
    required_for_send_reset_email:
      - RESEND_API_KEY
      - RESEND_FROM_EMAIL
    set_via: "supabase secrets set <KEY>=<VALUE>"
    notes: "Secrets sao variaveis de ambiente das Edge Functions, gerenciados pelo Supabase CLI"

  expo:
    required:
      - EXPO_PUBLIC_SUPABASE_URL
      - EXPO_PUBLIC_SUPABASE_ANON_KEY
    file: ".env"

health_checks:
  supabase_rest_api:
    command: |
      curl -s -o /dev/null -w "%{http_code}" "https://poizgglzdjqwrhsnhkke.supabase.co/rest/v1/" \
        -H "apikey: $SUPABASE_ANON_KEY"
    expected: "200"

troubleshooting:
  - problem: "supabase db push falha com 'operation not permitted' na porta 5432/6543"
    solution: "Firewall bloqueando conexoes TCP diretas. Usar Management API via HTTPS."
    command: "Ver secao 'Aplicar migrations (via Management API)' acima"

  - problem: "Migration falhou"
    solution: "Verificar supabase/migrations/ por erros SQL"
    command: "supabase db diff"

  - problem: "Function nao responde"
    solution: "Verificar logs e variaveis de ambiente"
    command: "supabase functions logs <function-name>"

  - problem: "Nao encontra migration history table (supabase_migrations.schema_migrations)"
    solution: "Projeto usa migrations manuais, nao tem tracking table. Migrations devem ser aplicadas manualmente e validadas com queries de verificacao."
    notes: "Tables de migration existentes: auth.schema_migrations, realtime.schema_migrations, storage.migrations"

  - problem: "SQL com $$ dollar quoting falha via JSON/curl"
    solution: "Usar python3 com raw strings (r\"\"\"...\"\"\") para gerar JSON corretamente. Evitar escaping manual de $$ em shell."
    command: "python3 -c 'import json; sql=r\"\"\"<SQL>\"\"\"; print(json.dumps({\"query\": sql}))' > /tmp/query.json && curl ... -d @/tmp/query.json"

  - problem: "CREATE OR REPLACE FUNCTION em schema auth falha com 'permission denied for schema auth'"
    solution: "Management API nao tem permissao para alterar schema auth. Se a funcao ja existe em public (verificar com pg_proc), aplicar no schema public em vez de auth."
    notes: "Funcao auth.ward_id() foi originalmente aplicada em public schema pelo Supabase Dashboard"

  - problem: "Edge Function send-reset-email retorna 'Email service not configured'"
    solution: "Secrets RESEND_API_KEY e RESEND_FROM_EMAIL nao estao configurados. Executar: supabase secrets set RESEND_API_KEY=<key> RESEND_FROM_EMAIL=<email>"
    notes: "Criar conta em https://resend.com, gerar API key, verificar dominio. Para testes usar onboarding@resend.dev como FROM."

  - problem: "Resend API retorna erro 403 ou 'domain not verified'"
    solution: "Dominio do email remetente (FROM) nao esta verificado no Resend. Ir em https://resend.com/domains e verificar o dominio, ou usar onboarding@resend.dev para testes."

  - problem: "Deep link scheme incorreto no Supabase (site_url ou redirect URLs)"
    solution: "Usar Management API PATCH para atualizar site_url e/ou uri_allow_list"
    command: |
      TOKEN_RAW=$(security find-generic-password -s "Supabase CLI" -w)
      TOKEN=$(echo "$TOKEN_RAW" | sed 's/go-keyring-base64://' | base64 -d)
      curl -s -X PATCH "https://api.supabase.com/v1/projects/poizgglzdjqwrhsnhkke/config/auth" \
        -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d '{"site_url":"sacrmeetplan://home","uri_allow_list":"sacrmeetplan://invite/*,sacrmeetplan://reset-password"}'
    notes: "Verificar com GET antes de PATCH. uri_allow_list e comma-separated."

  - problem: "Botao de email nao clicavel (custom URL scheme bloqueado por email clients)"
    solution: "Usar Edge Function intermediaria HTTPS (reset-redirect) que faz redirect para deep link. Email aponta para URL HTTPS, que redireciona para app."
    notes: "Email clients como Gmail, Outlook bloqueiam links com custom URL schemes (sacrmeetplan://, wardmanager://, etc) por seguranca."

deploy_history:
  - date: "2026-02-18"
    action: "Migration 012_drop_members_phone_unique_constraint.sql"
    method: "Management API (HTTPS)"
    reason: "Porta 5432 bloqueada por firewall no ambiente de execucao"
    result: "Sucesso - constraint members_ward_id_country_code_phone_key removida"
    verified: true
    cr: "CR-78"

  - date: "2026-02-18"
    action: "Migration 013_fix_notification_trigger_security_definer.sql"
    method: "Management API (HTTPS) via python3 JSON encoding"
    reason: "Porta 5432 bloqueada por firewall no ambiente de execucao"
    result: "Sucesso - enqueue_speech_notification() agora usa SECURITY DEFINER (prosecdef=true)"
    verified: true
    cr: "CR-91"
    verification:
      - "pg_proc.prosecdef = true para enqueue_speech_notification"
      - "Trigger speech_notification_trigger ainda ativo em INSERT e UPDATE"
      - "REST API health check: HTTP 200"

  - date: "2026-02-18"
    action: "Migration 014_add_speaker_overrides.sql"
    method: "Management API (HTTPS) via python3 JSON encoding"
    reason: "Porta 5432 bloqueada por firewall no ambiente de execucao"
    result: "Sucesso - colunas speaker_1_override, speaker_2_override, speaker_3_override adicionadas a sunday_agendas"
    verified: true
    cr: "CR-100"
    verification:
      - "information_schema.columns confirma 3 colunas TEXT nullable"
      - "Column comments aplicados corretamente"
      - "REST API health check: HTTP 200"

  - date: "2026-02-20"
    action: "Migration 015_fix_function_search_path.sql"
    method: "Management API (HTTPS) via python3 JSON encoding (2 requests: public functions + ward_id)"
    reason: "Porta 5432 bloqueada por firewall no ambiente de execucao"
    result: "Sucesso - SET search_path = '' adicionado a 7 funcoes (update_updated_at_column, ward_id, list_ward_users, create_weekly_reminders, enqueue_speech_notification, delete_old_activity_log, import_members)"
    verified: true
    cr: "CR-144"
    verification:
      - "pg_proc.proconfig = [search_path=\"\"] para todas as 7 funcoes"
      - "SECURITY DEFINER mantido em enqueue_speech_notification, list_ward_users, import_members"
      - "Trigger speech_notification_trigger ainda ativo em INSERT e UPDATE"
      - "REST API health check: HTTP 200"
    notes: "ward_id() aplicada em public schema (nao auth) pois Management API nao tem permissao para schema auth. Funcao ja existia em public conforme pg_proc."

  - date: "2026-02-20"
    action: "Migration 016_add_has_intermediate_hymn.sql"
    method: "Management API (HTTPS) via python3 JSON encoding"
    reason: "Porta 5432 bloqueada por firewall no ambiente de execucao"
    result: "Sucesso - coluna has_intermediate_hymn BOOLEAN NOT NULL DEFAULT true adicionada a sunday_agendas"
    verified: true
    cr: "CR-152"
    verification:
      - "information_schema.columns confirma coluna boolean, NOT NULL, default true"
      - "REST API health check: HTTP 200"

  - date: "2026-02-21"
    action: "Deploy Edge Function send-reset-email"
    method: "supabase functions deploy send-reset-email (executado pelo orquestrador)"
    reason: "Nova Edge Function para envio de emails de reset de senha multilinguais via Resend API"
    result: "Sucesso - Function deployada e ACTIVE (version 1)"
    verified: true
    cr: "Batch 15 Phase 2"
    verification:
      - "supabase functions list mostra send-reset-email como ACTIVE"
      - "POST com email inexistente retorna {success:true} (anti-enumeration)"
    notes: "Function requer secrets RESEND_API_KEY e RESEND_FROM_EMAIL para envio efetivo de emails"

  - date: "2026-02-21"
    action: "Configurar secrets RESEND_API_KEY e RESEND_FROM_EMAIL"
    method: "supabase secrets set"
    reason: "Edge Function send-reset-email precisa de credenciais Resend para enviar emails"
    result: "PENDENTE - Requer acao manual do usuario"
    verified: false
    cr: "Batch 15 Phase 2"
    pending_actions:
      - "Criar conta em https://resend.com (se necessario)"
      - "Gerar API key em https://resend.com/api-keys"
      - "Verificar dominio em https://resend.com/domains (ou usar onboarding@resend.dev para testes)"
      - "Executar: supabase secrets set RESEND_API_KEY=<key>"
      - 'Executar: supabase secrets set RESEND_FROM_EMAIL="Sacrament Meeting Planner <noreply@yourdomain.com>"'
      - "Testar com email de usuario real no banco"

  - date: "2026-02-22"
    action: "Deploy Edge Function reset-redirect (nova)"
    method: "supabase functions deploy reset-redirect --no-verify-jwt"
    reason: "Nova Edge Function intermediaria HTTPS para deep links de reset de senha (email clients bloqueiam custom URL schemes)"
    result: "Sucesso - Function deployada e ACTIVE (version 1)"
    verified: true
    cr: "Batch 18 (CR-175 to CR-177)"
    verification:
      - "supabase functions list mostra reset-redirect como ACTIVE v1"
      - "GET com token=test123&type=recovery retorna HTML 200 com deep link sacrmeetplan://reset-password"
      - "REST API health check: HTTP 200"

  - date: "2026-02-22"
    action: "Redeploy Edge Function send-reset-email"
    method: "supabase functions deploy send-reset-email --no-verify-jwt"
    reason: "Atualizada para usar HTTPS redirect (reset-redirect) em vez de deep link direto no email"
    result: "Sucesso - Function redeployada e ACTIVE (version 4)"
    verified: true
    cr: "Batch 18 (CR-175 to CR-177)"
    verification:
      - "supabase functions list mostra send-reset-email como ACTIVE v4"
      - "POST com email inexistente retorna {success:true} (anti-enumeration)"
      - "REST API health check: HTTP 200"

  - date: "2026-02-22"
    action: "Redeploy Edge Function create-invitation"
    method: "supabase functions deploy create-invitation"
    reason: "Atualizada com deep link scheme corrigido (sacrmeetplan:// em vez de wardmanager://)"
    result: "Sucesso - Function redeployada e ACTIVE (version 7)"
    verified: true
    cr: "Batch 18 (CR-175 to CR-177)"
    verification:
      - "supabase functions list mostra create-invitation como ACTIVE v7"
      - "REST API health check: HTTP 200"

  - date: "2026-02-22"
    action: "Atualizar site_url de sacrmeetman:// para sacrmeetplan://"
    method: "Management API PATCH /config/auth"
    reason: "site_url ainda usava scheme antigo sacrmeetman://home"
    result: "Sucesso - site_url atualizado para sacrmeetplan://home"
    verified: true
    cr: "Batch 18 (CR-175 to CR-177)"
    verification:
      - "GET /config/auth confirma site_url=sacrmeetplan://home"
      - "GET /config/auth confirma uri_allow_list=sacrmeetplan://invite/*,sacrmeetplan://reset-password"

  - date: "2026-02-22"
    action: "Backup meeting_actors table (pre-migration 017)"
    method: "Management API SELECT query"
    reason: "Migration 017 is destructive (drops can_music column). Backup before applying."
    result: "Sucesso - 11 rows backed up to /tmp/meeting_actors_backup_20260222.json"
    verified: true
    cr: "Batch 19 Phase 1 (F117)"
    notes: "2 actors had can_music=true (Patricia Dalmora, Rafael Zacharias) - migrated to can_pianist=true"

  - date: "2026-02-22"
    action: "Migration 017_split_music_actor.sql"
    method: "Management API (HTTPS) via python3 JSON encoding"
    reason: "Split can_music boolean into can_pianist and can_conductor with mutual exclusivity constraint"
    result: "Sucesso - can_music dropped, can_pianist/can_conductor added, data migrated, CHECK constraint applied"
    verified: true
    cr: "Batch 19 Phase 1 (F117, CR-180)"
    verification:
      - "information_schema.columns: can_pianist BOOLEAN NOT NULL DEFAULT false"
      - "information_schema.columns: can_conductor BOOLEAN NOT NULL DEFAULT false"
      - "information_schema.columns: can_music NOT present (dropped)"
      - "pg_constraint: chk_pianist_conductor_exclusive CHECK ((NOT ((can_pianist = true) AND (can_conductor = true))))"
      - "Data migration: 2 actors with can_music=true correctly migrated to can_pianist=true"
      - "REST API health check: HTTP 200"

  - date: "2026-02-22"
    action: "Migration 018_add_has_second_speech.sql"
    method: "Management API (HTTPS) via python3 JSON encoding"
    reason: "Add has_second_speech boolean toggle to sunday_agendas"
    result: "Sucesso - coluna has_second_speech BOOLEAN NOT NULL DEFAULT true adicionada a sunday_agendas"
    verified: true
    cr: "Batch 19 Phase 1 (F118, CR-181)"
    verification:
      - "information_schema.columns: has_second_speech BOOLEAN NOT NULL DEFAULT true"
      - "REST API health check: HTTP 200"

  - date: "2026-02-22"
    action: "Redeploy Edge Function reset-redirect"
    method: "supabase functions deploy reset-redirect --no-verify-jwt"
    reason: "F119 (CR-191): Fixed charset + Cache-Control headers for plain-text HTML rendering bug"
    result: "Sucesso - Function redeployada e ACTIVE (version 2)"
    verified: true
    cr: "Batch 19 Phase 1 (F119, CR-191)"
    verification:
      - "supabase functions list mostra reset-redirect como ACTIVE v2"
      - "GET com token=test123&type=recovery retorna HTML 200 com deep link e charset=utf-8"
      - "REST API health check: HTTP 200"

  - date: "2026-02-22"
    action: "Redeploy Edge Function create-invitation"
    method: "supabase functions deploy create-invitation"
    reason: "Updated to use can_pianist/can_conductor instead of can_music (F117)"
    result: "Sucesso - Function redeployada e ACTIVE (version 8)"
    verified: true
    cr: "Batch 19 Phase 1 (F117, CR-180)"
    verification:
      - "supabase functions list mostra create-invitation como ACTIVE v8"
      - "REST API health check: HTTP 200"

  - date: "2026-02-22"
    action: "Redeploy Edge Function update-user-role"
    method: "supabase functions deploy update-user-role"
    reason: "Updated to use can_pianist/can_conductor instead of can_music (F117)"
    result: "Sucesso - Function redeployada e ACTIVE (version 7)"
    verified: true
    cr: "Batch 19 Phase 1 (F117, CR-180)"
    verification:
      - "supabase functions list mostra update-user-role como ACTIVE v7"
      - "REST API health check: HTTP 200"

  - date: "2026-02-22"
    action: "Redeploy Edge Function register-first-user"
    method: "supabase functions deploy register-first-user --no-verify-jwt"
    reason: "Updated to use can_pianist/can_conductor instead of can_music (F117)"
    result: "Sucesso - Function redeployada e ACTIVE (version 7)"
    verified: true
    cr: "Batch 19 Phase 1 (F117, CR-180)"
    verification:
      - "supabase functions list mostra register-first-user como ACTIVE v7"
      - "REST API health check: HTTP 200"
