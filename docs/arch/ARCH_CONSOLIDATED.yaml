# =============================================================================
# ARCH_CONSOLIDATED.yaml
# Fonte unica de verdade da arquitetura do projeto Sacrament Meeting Planner
# Gerado: 2026-02-18
# =============================================================================

metadata:
  project: Sacrament Meeting Planner
  last_updated: "2026-02-19"
  last_updated_by: "batch-9-phase-2"
  total_modules: 8
  total_adrs: 36
  total_crs_implemented: 82
  pending_arch: "none"
  source_documents:
    - docs/arch/history/ARCH_INDEX.md
    - docs/arch/history/ARCH_M001.md through ARCH_M008.md
    - docs/arch/history/ARCH_CR001.md through ARCH_CR81.md
    - docs/arch/history/ARCH_BUG401.md
    - docs/arch/ARCH_M011.yaml
    - docs/arch/ARCH_M012.yaml
    - docs/arch/ARCH_M013.yaml
    - docs/arch/ARCH_M014.yaml
    - docs/arch/ARCH_M015.yaml
    - docs/arch/ARCH_M016.yaml
    - docs/arch/ARCH_M017.yaml
    - docs/arch/ARCH_M018.yaml

# =============================================================================
# TECH STACK
# =============================================================================

tech_stack:
  runtime: "React Native + Expo SDK 54"
  language: "TypeScript"
  routing: "Expo Router (file-based, src/app/)"
  server_state: "TanStack Query v5"
  local_state: "React Context (theme, auth, locale)"
  backend: "Supabase"
  database: "PostgreSQL with RLS"
  auth: "Supabase Auth (email/password)"
  realtime: "Supabase Realtime channels"
  edge_functions: "Supabase Edge Functions (Deno runtime)"
  i18n: "react-i18next (pt-BR, en, es)"
  testing: "Vitest + React Testing Library"
  gestures: "react-native-gesture-handler ~2.28.0 + react-native-reanimated"
  file_system: "expo-file-system v19 (new File/Paths API)"
  notifications: "Expo Push Notifications"
  storage: "AsyncStorage (offline queue, theme preference)"
  deep_links: "expo-linking (sacrmeetman://invite/{token})"
  csv: "expo-document-picker + expo-file-system + expo-sharing"

# =============================================================================
# SYSTEM DIAGRAM (ASCII)
# =============================================================================

system_diagram: |
  ┌─────────────────────────────────────────────────────────────────┐
  │                   React Native + Expo SDK 54                     │
  │                                                                  │
  │  ┌──────────────────────────────────────────────────────────┐   │
  │  │  UIShell (M008) - GestureHandlerRootView wrapper          │   │
  │  │  Expo Router: (auth)/ | (tabs)/Home,Agenda,Speeches,Set   │   │
  │  │  ThemeContext | I18nProvider | ErrorBoundary               │   │
  │  └──────────────────────────────────────────────────────────┘   │
  │                                                                  │
  │  ┌──────────┐  ┌──────────────┐  ┌────────────┐  ┌──────────┐  │
  │  │ Auth     │  │ SpeechModule │  │  Agenda    │  │ WardData │  │
  │  │ Module   │  │ (M003)       │  │  Module    │  │ Module   │  │
  │  │ (M001)   │  │ Speech CRUD  │  │  (M004)    │  │ (M002)   │  │
  │  │ Login    │  │ Status cycle │  │  Agenda    │  │ Members  │  │
  │  │ Signup   │  │ WhatsApp     │  │  Form      │  │ Topics   │  │
  │  │ Reset    │  │ LEDs         │  │  Present.  │  │ Actors   │  │
  │  │ Users    │  │              │  │  Accordion │  │ Hymns    │  │
  │  │ Perms    │  │              │  │            │  │ Log      │  │
  │  └──────────┘  └──────────────┘  └────────────┘  │ Sundays  │  │
  │                                                   └──────────┘  │
  │  ┌──────────────┐  ┌───────────────┐  ┌───────────────┐        │
  │  │ Notification │  │  SyncEngine   │  │ OfflineManager│        │
  │  │ Module (M005)│  │  (M006)       │  │ (M007)        │        │
  │  │ Push queue   │  │  Realtime WS  │  │ MutationQueue │        │
  │  │ Expo Push    │  │  Poll fallback│  │ Optimistic UI │        │
  │  └──────────────┘  └───────────────┘  │ Connection    │        │
  │                                        └───────────────┘        │
  │  ┌──────────────────────────────────────────────────────────┐   │
  │  │  TanStack Query (server state cache + mutations)         │   │
  │  └──────────────────────────┬───────────────────────────────┘   │
  └─────────────────────────────┼───────────────────────────────────┘
                                │
                           Supabase Client
                                │
  ┌─────────────────────────────┼───────────────────────────────────┐
  │                     Supabase Backend                              │
  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────────────┐  │
  │  │   Auth   │  │ PostgREST│  │ Realtime │  │ Edge Functions │  │
  │  │  (JWT)   │  │  (CRUD)  │  │  (WS)    │  │ 8 functions    │  │
  │  └──────────┘  └──────────┘  └──────────┘  │ 1 push cron    │  │
  │                                             └────────────────┘  │
  │  ┌──────────────────────────────────────────────────────────┐   │
  │  │  PostgreSQL (RLS on ward_id, triggers, migrations)       │   │
  │  │  wards | members | speeches | sunday_agendas             │   │
  │  │  ward_topics | meeting_actors | hymns | sunday_exceptions│   │
  │  │  general_collections | general_topics                    │   │
  │  │  ward_collection_config | invitations                    │   │
  │  │  activity_log | device_push_tokens | notification_queue  │   │
  │  └──────────────────────────────────────────────────────────┘   │
  └─────────────────────────────────────────────────────────────────┘

# =============================================================================
# PROVIDER STACK (rendering order)
# =============================================================================

provider_stack:
  order:
    - "ErrorBoundary"
    - "GestureHandlerRootView (style={{ flex: 1 }})"
    - "QueryClientProvider"
    - "I18nextProvider"
    - "ThemeProvider"
    - "AuthProvider"
    - "SyncProvider (useConnection + useRealtimeSync + useNotifications + OfflineBanner)"
    - "NavigationGuard (redirects based on auth state)"
    - "StatusBar"
    - "Slot (Expo Router)"
  file: "src/app/_layout.tsx"
  notes:
    - "GestureHandlerRootView wraps the entire app tree inside ErrorBoundary (CR-82)"
    - "SyncProvider orchestrates connection monitoring, realtime sync, push notifications"
    - "OfflineBanner renders above Slot when device is offline"

# =============================================================================
# MODULES
# =============================================================================

modules:
  - id: M001
    name: AuthModule
    responsibility: "Autenticacao, sessao, gerenciamento de usuarios, permissoes"
    spec_features: [F001, F018, F023]
    key_files:
      - src/app/(auth)/login.tsx
      - src/app/(auth)/register.tsx
      - src/app/(auth)/forgot-password.tsx
      - src/app/(auth)/invite/[token].tsx
      - src/app/(tabs)/settings/users.tsx
      - src/contexts/AuthContext.tsx
      - src/lib/permissions.ts
      - src/lib/supabase.ts
    hooks: [useAuth]
    screens:
      - LoginScreen (login.tsx)
      - RegisterScreen (register.tsx)
      - ForgotPasswordScreen (forgot-password.tsx)
      - InviteRegistrationScreen (invite/[token].tsx)
      - UserManagementScreen (users.tsx)
    edge_functions:
      - register-first-user
      - register-invited-user
      - create-invitation
      - list-users
      - update-user-role
      - update-user-name
      - delete-user
    modified_by_crs: [2, 11, 23, 64, 67, 76, 80, 81]
    notes: |
      CR-67 adicionou forgot password. CR-64 corrigiu acesso do secretario a EFs.
      CR-76 removeu Authorization header manual (regression CR-64).
      BUG-401 adicionou session guard e desabilitou gateway JWT verification.
      CR-81 adicionou campo full_name no registro e edicao de nome.
      CR-80 adicionou back button na tela Users.
      AuthContext expoe: session, user, role, wardId, userName, loading, signIn, signOut, hasPermission.

  - id: M002
    name: WardDataModule
    responsibility: "Dados mestres da ala: membros, topicos, colecoes, tipos de domingo, atores, hinos, log de atividades"
    spec_features: [F002, F003, F004, F005, F006, F007, F013, F014, F015, F019]
    key_files:
      - src/app/(tabs)/settings/members.tsx
      - src/app/(tabs)/settings/topics.tsx
      - src/app/(tabs)/settings/history.tsx
      - src/hooks/useMembers.ts
      - src/hooks/useTopics.ts
      - src/hooks/useActors.ts
      - src/hooks/useHymns.ts
      - src/hooks/useActivityLog.ts
      - src/hooks/useSundayTypes.ts
      - src/lib/csvUtils.ts
      - src/lib/activityLog.ts
      - src/components/ActorSelector.tsx
      - src/components/MemberSelectorModal.tsx
      - src/components/TopicSelectorModal.tsx
    hooks:
      - useMembers
      - useTopics
      - useActors
      - useHymns
      - useActivityLog
      - useSundayTypes
    screens:
      - MemberManagementScreen (members.tsx)
      - TopicManagementScreen (topics.tsx)
      - ActivityLogScreen (history.tsx)
    modified_by_crs: [6, 8, 18, 20, 21, 22, 24, 39, 42, 54, 55, 66, 70, 71, 72, 77, 78, 79, 80, 83, 84, 85, 86, 88, 89, 90, 117]
    notes: |
      CR-42 implementou CSV import/export com expo-file-system + expo-sharing.
      CR-54/55/66 corrigiram edge cases de CSV e header spacer.
      CR-77/78 corrigiram export vazio e i18n de erros CSV com error codes.
      CR-71 tornou can_conduct e can_preside independentes.
      CR-72 adicionou auto-criacao de atores para bishopric.
      CR-70 aumentou icones do ActorSelector.
      CR-79 adicionou secao informativa na tela Members.
      CR-78 removeu unique constraint de phone dos members (migration 012).
      CR-80 adicionou textos explicativos na tela Members (description + CSV help, i18n).
      CR-83 Save/Cancel explicito em MemberEditor e TopicEditor (remove onBlur auto-save).
      CR-84 SearchInput reutilizavel com botao X para limpar busca (10 campos migrados).
      CR-85 countryCodes.ts como single source of truth (~200 paises, extracto de members.tsx + csvUtils.ts).
      CR-86 Alert.alert de confirmacao antes de importar CSV.
      CR-88 texto explicativo na tela Topics (description + collection toggle explanation).
      CR-89 expand/collapse inline para ver temas de colecao (hook useCollectionTopics, accordion pattern).
      CR-90 Fix botao Delete no SwipeableCard (pointerEvents='box-none').
      CR-96/F041: SearchInput fixo no topo em members.tsx e topics.tsx (fora do ScrollView).
      CR-117/F057: USA reordenado antes de Canada em countryCodes.ts. members.tsx usa label para highlight no dropdown.

  - id: M003
    name: SpeechModule
    responsibility: "Ciclo de vida de discursos (designacao, status, remocao) e integracao WhatsApp"
    spec_features: [F008, F010, F024, F051]
    key_files:
      - src/app/(tabs)/speeches.tsx
      - src/hooks/useSpeeches.ts
      - src/hooks/useSundayList.ts
      - src/components/SundayCard.tsx
      - src/components/SpeechSlot.tsx
      - src/components/StatusLED.tsx
      - src/components/StatusChangeModal.tsx
      - src/lib/whatsapp.ts
      - src/lib/whatsappUtils.ts
      - src/lib/speechUtils.ts
    hooks:
      - useSpeeches
      - useSundayList
    screens:
      - SpeechesTab (speeches.tsx)
    modified_by_crs: [4, 5, 7, 22, 29, 35, 106, 112, 114, 116, 119]
    notes: |
      Cada domingo tem exatamente 3 slots de discurso (1o, 2o, 3o).
      Lazy creation: registros criados ao expandir o card.
      Snapshot pattern: nome/telefone do orador e titulo/link do topico copiados como texto.
      Status lifecycle: not_assigned -> assigned_not_invited -> assigned_invited -> assigned_confirmed | gave_up.
      CR-95: Speech slots condicionados a tipo === 'speeches' (nao usa mais isExcludedFromAgenda).
      CR-94/F040: Templates padrao de WhatsApp por idioma (DEFAULT_TEMPLATE_EN, DEFAULT_TEMPLATE_ES).
      buildWhatsAppUrl aceita parametro 'language' para selecionar template do idioma da ala.
      CR-101/F045: LEDs condicionados a isSpeechesType no SundayCard (ocultos para domingos sem discursos).
      CR-104+108/F048: Templates padrao com aspas ao redor de {titulo}; {colecao} e {link} passados em WhatsAppVariables.
      CR-106/F051: Transicao reversa assigned_invited -> assigned_not_invited adicionada a VALID_TRANSITIONS.
      CR-112/F055: buildWhatsAppConversationUrl(phone) para abrir conversa sem mensagem. Usado em handleDropdownWhatsApp.
      CR-122/F058: getPositionLabel() retorna t('speeches.lastSpeech') quando position===3.
      CR-114/F060: Botao X para remover atribuicao de tema. onClearTopic prop no SpeechSlot.
      CR-116/F062: StatusChangeModal recebe allowedStatuses prop. LED click em assigned_invited filtra para confirmed/gave_up.
      CR-119/F063: Layout reordenado [LED][Speaker][X]. topicField marginLeft 28px para alinhamento.

  - id: M004
    name: AgendaModule
    responsibility: "Formulario da agenda sacramental e Modo Apresentacao"
    spec_features: [F012, F016]
    key_files:
      - src/app/(tabs)/agenda.tsx
      - src/app/presentation.tsx
      - src/hooks/useAgenda.ts
      - src/hooks/usePresentationMode.ts
      - src/components/AgendaForm.tsx
      - src/components/AccordionCard.tsx
      - src/components/HymnSelector.tsx
      - src/components/PrayerSelector.tsx
      - src/components/DebouncedTextInput.tsx
      - src/lib/dateUtils.ts
    hooks:
      - useAgenda
      - usePresentationMode
    screens:
      - AgendaTab (agenda.tsx)
      - PresentationMode (presentation.tsx)
    modified_by_crs: [3, 25, 26, 27, 28, 29, 30, 38, 73, 74, 75, 122, 125, 121]
    notes: |
      Lazy creation: registro da agenda criado ao expandir domingo.
      Auto-save em cada mudanca de campo (debounced para text inputs, CR-27).
      CR-73 mudou Recognizing para usar ActorSelector com can_recognize.
      CR-74 adicionou nomes customizados para oracoes via MemberSelectorModal.
      CR-75 domingos excluidos aparecem como cards nao-expandiveis.
      CR-98 PrayerSelector recebe visible/onClose (padrao ActorSelector) para auto-abrir modal.
      CR-97/F042: Multi-select para 'Reconhecendo a Presenca' (toggle add/remove, ActorSelector com multiSelect prop).
      CR-99/F043: Labels 'speeches.speaker' alterados de 'Orador' para 'Discurso' (i18n only).
      CR-100/F044: SpeakerField reescrito para read-only + lapis + TextInput + X. Override em speaker_*_override.
      CR-102/F046: exceptionLabel oculto para domingos com reason === 'speeches' na aba Agenda.
      Modo Apresentacao: read-only, accordion com 4 secoes (normal) ou 3 (especial).
      CR-122/F058: Label do SpeakerField posicao 3 usa t('speeches.lastSpeech'). Presentation mode idem.
      CR-125/F059: PrayerSelector recebe modalOnly={true} no AgendaForm para nao duplicar botao inline.
      CR-121/F064: SpeakerField mostra label "(Designacao de ultima hora)" quando hasOverride=true e !isEditing.

  - id: M005
    name: NotificationModule
    responsibility: "Push notifications via fila no banco, Expo Push API e Edge Function cron"
    spec_features: [F017]
    key_files:
      - src/hooks/useNotifications.ts
      - src/lib/notificationUtils.ts
      - supabase/functions/process-notifications/index.ts
      - supabase/migrations/003_notification_triggers.sql
      - supabase/migrations/004_weekly_reminder_function.sql
    hooks:
      - useRegisterPushToken
      - useNotificationHandler
    edge_functions:
      - process-notifications (cron every 1 minute)
    modified_by_crs: [52, 53]
    notes: |
      5 casos de notificacao: designation (delayed 5min), weekly_assignment,
      weekly_confirmation, speaker_confirmed (immediate), speaker_withdrew (immediate).
      DB triggers enfileiram em notification_queue; cron EF processa e envia via Expo Push API.
      Observers nao recebem push. Token registrado no login/abertura do app.
      CR-91: enqueue_speech_notification() usa SECURITY DEFINER para bypass RLS (ADR-035).

  - id: M006
    name: SyncEngine
    responsibility: "Sincronizacao em tempo real via Supabase Realtime com fallback de polling"
    spec_features: [F011]
    key_files:
      - src/hooks/useRealtimeSync.ts
      - src/lib/sync.ts
    hooks:
      - useRealtimeSync
    synced_tables:
      - members
      - ward_topics
      - ward_collection_config
      - sunday_exceptions
      - speeches
      - sunday_agendas
      - meeting_actors
    modified_by_crs: [52]
    notes: |
      WebSocket (Supabase Realtime) e o mecanismo primario.
      Polling fallback (2.5s) quando WebSocket indisponivel.
      Invalidacao granular via TABLE_TO_QUERY_KEY mapping em lib/sync.ts.
      Conectado ao app via SyncProvider em _layout.tsx.

  - id: M007
    name: OfflineManager
    responsibility: "Uso offline com UI otimista, fila de mutacoes e processamento ao reconectar"
    spec_features: [F022]
    key_files:
      - src/hooks/useConnection.ts
      - src/hooks/useOfflineQueueProcessor.ts
      - src/lib/offlineQueue.ts
      - src/lib/offlineGuard.ts
      - src/lib/connectionUtils.ts
      - src/components/OfflineBanner.tsx
    hooks:
      - useConnection
      - useOfflineQueueProcessor
    modified_by_crs: [52]
    notes: |
      MutationQueue persistida em AsyncStorage (max 100 entries, FIFO).
      Last-write-wins conflict resolution via updated_at timestamps.
      Edge Function operations bloqueadas offline com mensagem "Requires connection".
      OfflineBanner renderizado acima de todo conteudo (incluindo telas de auth).
      offlineQueue integration com mutation hooks DEFERRED (code existe mas nao usado).

  - id: M008
    name: UIShell
    responsibility: "App shell (tabs, navegacao, tema, i18n), Home tab com secoes role-aware"
    spec_features: [F009, F020, F021, F050, F052, F053, F054]
    key_files:
      - src/app/_layout.tsx
      - src/app/(tabs)/_layout.tsx
      - src/app/(tabs)/index.tsx
      - src/app/(tabs)/settings/_layout.tsx
      - src/app/(tabs)/settings/index.tsx
      - src/app/(tabs)/settings/theme.tsx
      - src/app/(tabs)/settings/about.tsx
      - src/app/(tabs)/settings/whatsapp.tsx
      - src/app/(tabs)/settings/timezone.tsx
      - src/contexts/ThemeContext.tsx
      - src/i18n/index.ts
      - src/i18n/locales/pt-BR.json
      - src/i18n/locales/en.json
      - src/i18n/locales/es.json
      - src/providers/SyncProvider.tsx
      - src/components/ErrorBoundary.tsx
      - src/components/ExitConfirmation.tsx
      - src/components/NextSundaysSection.tsx
      - src/components/NextAssignmentsSection.tsx
      - src/components/InviteManagementSection.tsx
      - src/components/InviteActionDropdown.tsx
      - src/components/SwipeableCard.tsx
      - src/components/QueryErrorView.tsx
    hooks:
      - useTheme
    screens:
      - HomeTab (index.tsx)
      - SettingsIndex (settings/index.tsx)
      - ThemeScreen (settings/theme.tsx)
      - AboutScreen (settings/about.tsx)
      - WhatsAppScreen (settings/whatsapp.tsx)
      - TimezoneScreen (settings/timezone.tsx)
    modified_by_crs: [1, 9, 10, 12, 13, 14, 15, 16, 17, 19, 32, 33, 43, 82, 84, 87, 90, 105, 106, 107, 110, 111, 112, 113, 122, 114, 115]
    notes: |
      4 tabs: Home, Agenda, Speeches, Settings.
      Home sections: NextSundays (todos), NextAssignments (bishopric), InviteManagement (secretary + bishopric).
      Presentation Mode button aparece no Home aos domingos.
      CR-82 adicionou GestureHandlerRootView wrapper no root layout.
      Tema: system detection + manual toggle (automatic/light/dark).
      i18n: ward language setting -> device locale (fallback).
      Per-screen back buttons (ADR-018).
      CR-84 adicionou SearchInput reutilizavel com botao X (usado em 10 campos de busca).
      CR-87 substituiu texto por icones Unicode nos botoes de swipe do SwipeableCard (pencil/trash).
      CR-90 fix botao Delete no SwipeableCard (pointerEvents='box-none', ADR-032).
      CR-99/F043: i18n key speeches.speaker alterada de 'Orador'/'Speaker' para 'Discurso'/'Speech'.
      CR-103/F047: Settings WhatsApp usa getDefaultTemplate(language) como fallback quando DB e null.
      CR-104+108/F048: InviteManagementSection passa collection/link e usa formatDateHumanReadable para {data}.
      CR-109/F049: NextSundaysSection corrige condicao de SpeechSlots para incluir reason === 'speeches'.
      CR-105/F050: InviteManagementSection botoes de acao trocam texto por icones (WhatsApp SVG + U+22EE tres pontinhos).
      CR-106/F051: InviteManagementSection troca Alert por InviteActionDropdown customizado com 5 opcoes.
      CR-107/F052: InviteManagementSection segunda linha mostra '{N}o Discurso - <LED> <status name>'.
      CR-110/F053: Bishopric agora ve InviteManagementSection (permissao home:invite_mgmt adicionada).
      CR-111/F054: SpeechSlot gap 8->12 e removeButton fontSize 20->24.
      CR-112/F055: handleDropdownWhatsApp usa buildWhatsAppConversationUrl (sem ?text=) ao inves de buildWhatsAppUrl.
      CR-113/F056: InviteActionDropdown titulo usa t('speeches.changeStatus') ao inves de speaker_name.
      CR-122/F058: InviteManagementSection segunda linha usa t('speeches.lastSpeech') para position===3.
      CR-114/F060: NextSundaysSection wiring de onClearTopic para SpeechSlot.
      CR-115/F061: SundayCard.SundayTypeDropdown confirmacao Alert.alert ao mudar tipo com atribuicoes existentes.

# =============================================================================
# MODULE DEPENDENCIES
# =============================================================================

module_dependencies:
  - from: M008
    to: M001
    reason: "session, role, permissions"
  - from: M008
    to: M003
    reason: "Home tab sections (NextSundays, InviteManagement)"
  - from: M008
    to: M004
    reason: "Presentation Mode button"
  - from: M003
    to: M002
    reason: "members, topics, sunday types"
  - from: M004
    to: M002
    reason: "actors, hymns, members"
  - from: M004
    to: M003
    reason: "speech assignment from Agenda"
  - from: M005
    to: M003
    reason: "speech events trigger notifications"
  - from: M005
    to: M001
    reason: "device tokens, role targeting"
  - from: M006
    to: M002
    reason: "cache invalidation for all tables"
  - from: M007
    to: M006
    reason: "reconnect triggers queue processing"

# =============================================================================
# ADRs (Architecture Decision Records)
# =============================================================================

adrs:
  - id: ADR-001
    title: "Store role in app_metadata instead of separate profiles table"
    context: "Need role-based access; profiles table adds complexity and sync issues"
    decision: "Use Supabase app_metadata for role, ward_id, and full_name"
    decided_in: "M001"
    consequences:
      - "Simpler: no extra table, role available in JWT"
      - "Role changes require Edge Function (admin API only)"

  - id: ADR-002
    title: "Edge Functions for all user management operations"
    context: "Creating users and changing roles requires admin API; cannot be done via PostgREST"
    decision: "8 Edge Functions for user lifecycle"
    decided_in: "M001"
    consequences:
      - "Secure: client never touches auth admin API"
      - "Requires Supabase Edge Functions deployment"

  - id: ADR-003
    title: "Snapshot pattern for denormalized speaker/topic data in speeches"
    context: "Deleting a member or topic must not break historical speech records"
    decision: "Store speaker_name, speaker_phone, topic_title as text snapshots alongside FK"
    decided_in: "M002"
    consequences:
      - "Historical data preserved after deletion"
      - "Name edits do NOT propagate to existing speeches (by design)"

  - id: ADR-004
    title: "CSV import overwrites entire member list"
    context: "Merge logic adds complexity; users expect CSV to be source of truth"
    decision: "DELETE all + INSERT new within transaction (import_members RPC)"
    decided_in: "M002"
    consequences:
      - "Simple and predictable"
      - "Speech snapshots preserved (snapshot pattern)"

  - id: ADR-005
    title: "Lazy creation of speech records"
    context: "Pre-creating speeches for all visible sundays would create thousands of unused records"
    decision: "Create 3 speech records when card is first expanded"
    decided_in: "M003"
    consequences:
      - "No orphan records for unexpanded sundays"
      - "First expand has a small write latency"

  - id: ADR-006
    title: "Speeches referenced by date JOIN instead of FK in agenda"
    context: "Speeches can be assigned from both Speeches tab and Agenda tab"
    decision: "JOIN speeches via (ward_id, sunday_date) instead of storing speech FKs in agenda"
    decided_in: "M004"
    consequences:
      - "Single source of truth for speeches"
      - "Changes in either tab automatically reflected"

  - id: ADR-007
    title: "Queue-based push notifications via DB triggers"
    context: "Need delayed/grouped notifications and timezone-aware scheduling"
    decision: "notification_queue table with DB triggers for enqueue and cron Edge Function for dequeue/send"
    decided_in: "M005"
    consequences:
      - "Reliable: survives Edge Function restarts"
      - "Grouping/delay logic is simple SQL"

  - id: ADR-008
    title: "Last-write-wins conflict resolution"
    context: "App is not designed for simultaneous multi-user editing; conflicts are rare"
    decision: "Use updated_at timestamp comparison; latest write wins"
    decided_in: "M007"
    consequences:
      - "Simple implementation, no merge logic"
      - "Acceptable for single-active-user-per-ward model"

  - id: ADR-009
    title: "Expo Router file-based routing"
    context: "Need cross-platform navigation with deep link support for invitations"
    decision: "Expo Router with file-based routing"
    decided_in: "M008"
    consequences:
      - "Convention over configuration for routes"
      - "Deep link support built-in for sacrmeetman://invite/{token} (changed from wardmanager:// in CR-93)"

  - id: ADR-010
    title: "Replace sunday type enum with corrected list"
    context: "Original enum had incorrect values (e.g., missing speeches as default)"
    decision: "New enum: speeches, testimony_meeting, general_conference, stake_conference, ward_conference, primary_presentation, other"
    decided_in: "CR-06"

  - id: ADR-011
    title: "ScrollView wrapper for Topics screen"
    context: "Collections section could overflow on smaller screens"
    decision: "Wrap Topics screen content in ScrollView"
    decided_in: "CR-08"

  - id: ADR-012
    title: "Debounced auto-save for AgendaForm text inputs"
    context: "Keystroke-level mutations caused text input bugs and excessive writes"
    decision: "DebouncedTextInput component with configurable delay"
    decided_in: "CR-27"

  - id: ADR-013
    title: "Inline actor management via bottom-sheet dialog"
    context: "Separate Actors screen was unintuitive; actors should be managed in context"
    decision: "ActorSelector component with create/edit/delete inline in agenda form"
    decided_in: "CR-26"

  - id: ADR-017
    title: "Static imports for Expo SDK modules in CSV handlers"
    context: "Dynamic imports of expo-file-system and expo-sharing caused issues"
    decision: "Use static imports at top of file"
    decided_in: "CR-42"

  - id: ADR-018
    title: "Per-screen back buttons instead of global headerLeft"
    context: "Settings sub-screens need consistent back navigation"
    decision: "Each settings sub-screen renders its own back button via Pressable + router.back()"
    decided_in: "CR-33"

  - id: ADR-019
    title: "Use Supabase built-in password reset flow"
    context: "Need forgot password feature"
    decision: "Use supabase.auth.resetPasswordForEmail. User resets via web browser."
    decided_in: "CR-67"
    consequences:
      - "Simple implementation -- one API call"
      - "No custom email templates needed"

  - id: ADR-020
    title: "Independent can_conduct and can_preside actor fields"
    context: "Old rule 'can_conduct implies can_preside' did not match real ward practices"
    decision: "Remove enforceActorRules logic. Fields are independent."
    decided_in: "CR-71"
    consequences:
      - "More flexible actor configuration"
      - "No data migration needed"

  - id: ADR-021
    title: "Auto-create actors for bishopric users in Edge Functions"
    context: "Bishopric users always need actor records for presiding/conducting"
    decision: "Edge Functions auto-insert meeting_actor when role is bishopric (SELECT+INSERT pattern)"
    decided_in: "CR-72"
    consequences:
      - "Better UX: actors created automatically"
      - "Name derived from full_name (or email fallback)"

  - id: ADR-022
    title: "Extract server-side error details from FunctionsHttpError"
    context: "supabase.functions.invoke returns generic error messages"
    decision: "Parse error.context.json() in callEdgeFunction to extract server error message"
    decided_in: "CR-76"

  - id: ADR-023
    title: "Disable gateway-level 'Verify JWT with legacy secret' for Edge Functions"
    context: "Gateway rejects valid user JWTs signed with current secret (not legacy)"
    decision: "Turn OFF 'Verify JWT with legacy secret' in Supabase Dashboard. EFs handle own auth."
    decided_in: "BUG-401"
    consequences:
      - "Immediately fixes all 401 errors on authenticated EFs"
      - "No security regression -- EFs validate JWT via auth.getUser()"

  - id: ADR-024
    title: "Validate session before Edge Function invoke to prevent ANON key fallback"
    context: "SDK silently falls back to ANON key when session is null"
    decision: "Add getSession() check in callEdgeFunction. Throw if null instead of sending ANON key."
    decided_in: "BUG-401"

  - id: ADR-025
    title: "Guard useQuery with enabled: !!session for authenticated queries"
    context: "useQuery fires on mount regardless of auth state"
    decision: "Add enabled: !!session to useQuery hooks calling authenticated Edge Functions"
    decided_in: "BUG-401"

  - id: ADR-026
    title: "Use error codes in csvUtils.ts instead of English strings"
    context: "parseCsv returned hardcoded English error messages bypassing i18n"
    decision: "Return error code strings; UI layer maps codes to i18n keys"
    decided_in: "CR-78"
    consequences:
      - "csvUtils.ts remains pure (no i18n dependency)"
      - "All error messages are translatable"

  - id: ADR-028
    title: "Use full_name in app_metadata and a separate update-user-name EF"
    context: "Need to store user display name without renaming update-user-role"
    decision: "Keep update-user-role unchanged. Create new update-user-name EF for self-name-update. Use app_metadata key 'full_name'."
    decided_in: "CR-81"
    supersedes: "ADR-027 (rename to update-user, from CR-80 -- not implemented)"
    consequences:
      - "Simpler deployment: no function renaming"
      - "Clear separation: role changes (admin) vs name edits (self-service)"

  - id: ADR-029
    title: "Auto-create actor in register-first-user for bishopric role"
    context: "First bishopric user should get an actor auto-created with their real name"
    decision: "Best-effort auto-actor creation in register-first-user using fullName"
    decided_in: "CR-81"
    consequences:
      - "Bishopric users get Preside/Conduct actor immediately after registration"
      - "Actor uses real name, not email prefix"

  - id: ADR-030
    title: "SearchInput as drop-in replacement with internal theming"
    context: "10 search fields across the app all follow the same pattern. QA PRE recommended a reusable component."
    decision: "SearchInput uses useTheme() internally and does not accept colors prop. Accepts all TextInput props via spread."
    decided_in: "CR-84"
    consequences:
      - "Simpler API: no colors prop needed at call sites"
      - "Consistent with existing standalone component patterns (ActorSelector, HymnSelector)"

  - id: ADR-031
    title: "Shared countryCodes.ts as single source of truth"
    context: "Country codes duplicated between members.tsx (21 entries) and csvUtils.ts regex."
    decision: "Create src/lib/countryCodes.ts exporting COUNTRY_CODES, getFlagForCode, and splitPhoneNumber. csvUtils.ts re-exports splitPhoneNumber for backward compatibility."
    decided_in: "CR-85"
    consequences:
      - "Single place to add/modify country codes"
      - "splitPhoneNumber uses COUNTRY_CODES array for matching instead of hardcoded regex"

  - id: ADR-032
    title: "pointerEvents='box-none' to fix gesture/button touch overlap in SwipeableCard"
    context: "Animated.View (zIndex:1) covers action buttons even after translation. Delete button blocked."
    decision: "Use pointerEvents='box-none' on Animated.View. Move backgroundColor to inner wrapper View."
    decided_in: "CR-90"
    consequences:
      - "Delete button receives touch events correctly"
      - "Edit button continues to work (no regression)"
      - "Pan gesture unaffected (GestureDetector handles its own touch management)"

  - id: ADR-033
    title: "Unicode icons for swipe action buttons instead of icon library"
    context: "User wants pencil/trash icons for swipe buttons. App has no icon library dependency."
    decision: "Use Unicode characters U+270F (Pencil) and U+1F5D1 (Wastebasket) as icon content. editLabel/deleteLabel props kept for accessibilityLabel only."
    decided_in: "CR-87"
    consequences:
      - "Zero new dependencies"
      - "Consistent with app's no-icon-library approach"
      - "accessibilityLabel preserved for screen readers"

  - id: ADR-034
    title: "Accordion pattern for collection topics (one expanded at a time)"
    context: "F034 shows collection topics inline. Multiple expanded collections could cause excessive scrolling."
    decision: "Use expandedCollectionId (string | null) for accordion pattern. Lazy-load topics via useCollectionTopics hook with TanStack Query caching."
    decided_in: "CR-89"
    consequences:
      - "Cleaner UX: one list visible at a time"
      - "Consistent with SwipeableCard one-at-a-time pattern"
      - "TanStack Query caching makes re-expansion instant"

  - id: ADR-035
    title: "SECURITY DEFINER para trigger enqueue_speech_notification"
    context: "Trigger tenta INSERT em notification_queue no contexto do usuario autenticado, mas notification_queue tem RLS sem policies para authenticated users."
    decision: "Adicionar SECURITY DEFINER a funcao enqueue_speech_notification() via nova migracao (013). Precedente: list_ward_users RPC ja usa SECURITY DEFINER."
    decided_in: "CR-91"
    consequences:
      - "Trigger funciona sem erro de RLS"
      - "notification_queue permanece inacessivel a clientes"
      - "Padrao consistente com list_ward_users RPC"

  - id: ADR-036
    title: "PrayerSelector com props visible/onClose (padrao ActorSelector)"
    context: "PrayerSelector gerencia seu proprio estado de modal (modalVisible=false). AgendaForm renderiza PrayerSelector condicionalmente mas nao tem como auto-abrir o modal."
    decision: "Adicionar props opcionais visible e onClose ao PrayerSelector. useEffect sincroniza modalVisible com visible. AgendaForm passa visible={true} e onClose."
    decided_in: "CR-98"
    consequences:
      - "Clicar no campo de oracao abre modal imediatamente"
      - "Padrao consistente com ActorSelector e HymnSelectorModal"
      - "Backward compatible (props opcionais)"

  - id: ADR-037
    title: "Multi-select mode no ActorSelector via props opcionais"
    context: "Campo 'Reconhecendo a Presenca' precisa de selecao multipla, mas todos os outros campos de ator sao single-select."
    decision: "Adicionar props opcionais multiSelect (boolean) e selectedNames (string[]) ao ActorSelector. Quando multiSelect=true, modal nao fecha apos selecao e renderiza checkmark nos selecionados."
    decided_in: "CR-97"
    consequences:
      - "Usos existentes de ActorSelector nao precisam de mudanca (backward compatible)"
      - "Toggle logic (add/remove) fica no AgendaForm, nao no ActorSelector"

  - id: ADR-038
    title: "Speaker override como campos nullable na sunday_agendas"
    context: "F044 precisa persistir override de nome do discursante para troca de ultima hora. Opcoes: campos individuais, JSON field, ou estado local."
    decision: "3 campos TEXT nullable (speaker_1_override, speaker_2_override, speaker_3_override) na tabela sunday_agendas. Quando null, exibe speech.speaker_name."
    decided_in: "CR-100"
    consequences:
      - "Tipo simples e direto, sem parsing de JSON"
      - "Segue padrao da tabela (campos individuais)"
      - "Backward compatible: null = comportamento atual"

  - id: ADR-039
    title: "Replicar padrao de condicao de speeches.tsx para NextSundaysSection"
    context: "Apos CR-56, todos os domingos tem registro de excecao. NextSundaysSection usa !entry.exception que e sempre false."
    decision: "Replicar condicao de speeches.tsx:276: (!exception || exception.reason === 'speeches')."
    decided_in: "CR-109"
    consequences:
      - "Consistencia entre speeches.tsx e NextSundaysSection.tsx"
      - "Padrao ja testado e validado"
      - "RLS existente cobre automaticamente (mesma tabela)"

  - id: ADR-040
    title: "SVG inline para icone WhatsApp ao inves de Unicode ou icon library"
    context: "F050 precisa de icone reconhecivel do WhatsApp. Nao existe glifo Unicode padrao. App segue DD-25 (sem icon library)."
    decision: "Usar SVG inline minimo do logo WhatsApp via react-native-svg (dependencia transitiva do Expo). Zero instalacao."
    decided_in: "CR-105"
    consequences:
      - "Icone reconhecivel e profissional"
      - "Zero dependencias novas (react-native-svg ja presente)"
      - "Consiste com DD-25 (sem icon library)"

  - id: ADR-041
    title: "InviteActionDropdown como componente separado do StatusChangeModal"
    context: "F051 precisa de dropdown customizado. StatusChangeModal tem padrao similar mas opcoes diferentes (inclui 'Ver conversa')."
    decision: "Criar novo componente InviteActionDropdown.tsx com padrao visual do StatusChangeModal mas logica propria. Importar STATUS_INDICATOR_COLORS para consistencia."
    decided_in: "CR-106"
    consequences:
      - "Separacao de responsabilidades clara"
      - "StatusChangeModal permanece inalterado"
      - "Padrao visual consistente via mesmas cores"

  - id: ADR-042
    title: "buildWhatsAppConversationUrl separada de buildWhatsAppUrl"
    context: "F055 precisa abrir conversa WhatsApp sem mensagem. buildWhatsAppUrl sempre anexa ?text=."
    decision: "Funcao separada buildWhatsAppConversationUrl(phone) em whatsappUtils.ts. Responsabilidade clara: abrir conversa vs enviar mensagem."
    decided_in: "CR-112"
    consequences:
      - "Zero risco de regressao em envio de convite"
      - "Duplica limpeza de telefone (trivial, 3 linhas)"

  - id: ADR-043
    title: "Country label como chave de selecao para resolver ambiguidade de +1"
    context: "Canada e USA compartilham +1. getFlagForCode usa .find() retornando primeiro match."
    decision: "Reordenar USA antes de Canada E usar label como chave de selecao no dropdown. Estado local countryLabel resolve ambiguidade na UI sem alterar schema."
    decided_in: "CR-117"
    consequences:
      - "Resolve ambiguidade visual sem migracao de dados"
      - "Se usuario selecionou Canada, reabrir edicao mostrara USA (tradeoff aceito)"

  - id: ADR-044
    title: "Reutilizar mutation assignTopic com valores null para clear topic"
    context: "F060 precisa limpar atribuicao de tema. Opcoes: (a) criar mutation separada clearTopic, (b) reutilizar assignTopic passando null."
    decision: "Reutilizar assignTopic.mutate com topicTitle=null, topicLink=null, topicCollection=null. A mutation existente ja faz update parcial no speech."
    decided_in: "CR-114"
    consequences:
      - "Zero codigo novo no hook useSpeeches"
      - "Semanticamente 'assign null' pode confundir, mas padrao claro no contexto"

  - id: ADR-045
    title: "Confirmacao de mudanca de tipo com Alert.alert nativo"
    context: "F061 precisa de dialogo de confirmacao ao mudar tipo de domingo com atribuicoes existentes. Opcoes: (a) Alert.alert nativo, (b) modal customizado."
    decision: "Usar Alert.alert nativo. Padrao consistente com delete member, import CSV, remove speech assignment."
    decided_in: "CR-115"
    consequences:
      - "Consistencia com padroes existentes do app"
      - "Estilo nativo varia entre iOS e Android (aceito)"

# =============================================================================
# DATABASE SCHEMA
# =============================================================================

database_schema:
  tables:
    # --- Ward-scoped tables (RLS on ward_id) ---
    - name: wards
      description: "Alas (multi-tenant root entity)"
      columns: [id, name, stake_name, language, timezone, whatsapp_template, created_at, updated_at]
      unique: ["(stake_name, name)"]
      rls: "id = auth.jwt().app_metadata.ward_id"

    - name: members
      description: "Membros da ala"
      columns: [id, ward_id, full_name, country_code, phone, created_at, updated_at]
      rls: "ward_id = auth.jwt().app_metadata.ward_id"
      notes: "phone unique constraint dropped (CR-78, migration 012)"

    - name: ward_topics
      description: "Topicos da ala (criados pelo usuario)"
      columns: [id, ward_id, title, link, created_at, updated_at]
      rls: "ward_id = auth.jwt().app_metadata.ward_id"

    - name: meeting_actors
      description: "Atores que podem presidir/conduzir/reconhecer/musica"
      columns: [id, ward_id, name, can_preside, can_conduct, can_recognize, can_music, created_at, updated_at]
      rls: "ward_id = auth.jwt().app_metadata.ward_id"
      notes: "can_conduct e can_preside sao independentes (CR-71, ADR-020)"

    - name: speeches
      description: "Discursos designados (3 slots por domingo)"
      columns: [id, ward_id, sunday_date, position, member_id, speaker_name, speaker_phone, topic_title, topic_link, topic_collection, status, created_at, updated_at]
      unique: ["(ward_id, sunday_date, position)"]
      rls: "ward_id = auth.jwt().app_metadata.ward_id"
      notes: "Snapshot pattern: speaker_name/phone e topic_title/link copiados como texto"

    - name: sunday_exceptions
      description: "Tipos de domingo (testimony_meeting, general_conference, etc.)"
      columns: [id, ward_id, date, reason, custom_reason]
      unique: ["(ward_id, date)"]
      rls: "ward_id = auth.jwt().app_metadata.ward_id"
      enum_values: [speeches, testimony_meeting, general_conference, stake_conference, ward_conference, primary_presentation, other]

    - name: sunday_agendas
      description: "Agenda completa da reuniao sacramental por domingo"
      columns: [id, ward_id, sunday_date, presiding_name, presiding_actor_id, conducting_name, conducting_actor_id, recognized_names, announcements, pianist_name, pianist_actor_id, conductor_name, conductor_actor_id, opening_hymn_id, opening_prayer_member_id, opening_prayer_name, sustaining_releasing, has_baby_blessing, baby_blessing_names, has_baptism_confirmation, baptism_confirmation_names, has_stake_announcements, sacrament_hymn_id, has_special_presentation, special_presentation_description, intermediate_hymn_id, closing_hymn_id, closing_prayer_member_id, closing_prayer_name, speaker_1_override, speaker_2_override, speaker_3_override, created_at, updated_at]
      unique: ["(ward_id, sunday_date)"]
      rls: "ward_id = auth.jwt().app_metadata.ward_id"
      notes: "speaker_*_override added by CR-100/F044 (migration 014) for last-minute speaker swap"

    - name: ward_collection_config
      description: "Configuracao de colecoes ativas por ala"
      columns: [id, ward_id, collection_id, active]
      rls: "ward_id = auth.jwt().app_metadata.ward_id"

    - name: invitations
      description: "Convites para novos usuarios"
      columns: [id, ward_id, email, role, token, expires_at, used_at, created_by, created_at]
      unique: [token]
      rls: "ward_id = auth.jwt().app_metadata.ward_id"

    - name: activity_log
      description: "Log de atividades dos usuarios"
      columns: [id, ward_id, user_id, user_email, user_name, action_type, description, created_at]
      rls: "ward_id = auth.jwt().app_metadata.ward_id; INSERT only"
      retention: "2 years (cron job, migration 005)"
      notes: "user_name column added by CR-81 (migration 011)"

    - name: device_push_tokens
      description: "Tokens de push notification por dispositivo"
      columns: [id, user_id, ward_id, expo_push_token, created_at, updated_at]
      unique: ["(user_id, expo_push_token)"]
      rls: "user_id = auth.uid()"

    - name: notification_queue
      description: "Fila de notificacoes push"
      columns: [id, ward_id, type, sunday_date, speech_position, speaker_name, target_role, status, send_after, created_at]
      rls: "INSERT via DB triggers only (SECURITY DEFINER, ADR-035)"

    # --- Global tables (SELECT only for authenticated) ---
    - name: hymns
      description: "Catalogo de hinos (global, multi-idioma)"
      columns: [id, language, number, title, is_sacramental]
      unique: ["(language, number)"]
      rls: "SELECT for all authenticated users"

    - name: general_collections
      description: "Colecoes de topicos globais (ex: Conferencia Geral)"
      columns: [id, name, language]
      rls: "SELECT for all authenticated users"

    - name: general_topics
      description: "Topicos dentro de colecoes globais"
      columns: [id, collection_id, title, link]
      rls: "SELECT for all authenticated users"

    # --- Auth table (managed by Supabase) ---
    - name: auth.users
      description: "Usuarios do app (gerenciado pelo Supabase Auth)"
      app_metadata_fields:
        ward_id: "uuid"
        role: "bishopric | secretary | observer"
        full_name: "string (added CR-81)"

  rpc_functions:
    - name: import_members
      description: "Atomically replaces all members (DELETE + INSERT)"
      params: [target_ward_id, new_members]
      migration: "007_import_members_rpc.sql"

    - name: list_ward_users
      description: "Lists all users in a ward (queries auth.users)"
      params: [target_ward_id]
      returns: [id, email, role, full_name, created_at]
      migration: "006_list_ward_users_rpc.sql (updated in 011)"
      security: DEFINER

  migrations:
    - "001_initial_schema.sql"
    - "002_rls_policies.sql"
    - "003_notification_triggers.sql"
    - "004_weekly_reminder_function.sql"
    - "005_activity_log_retention.sql"
    - "006_list_ward_users_rpc.sql"
    - "007_import_members_rpc.sql"
    - "008_fix_sunday_type_enum.sql"
    - "009_add_speeches_to_reason_enum.sql"
    - "010_enable_realtime_publication.sql"
    - "011_add_user_name_support.sql"
    - "012_drop_members_phone_unique_constraint.sql"
    - "013_fix_notification_trigger_security_definer.sql"
    - "014_add_speaker_overrides.sql"

  key_relationships:
    - "members.ward_id -> wards.id"
    - "speeches.ward_id -> wards.id"
    - "speeches.member_id -> members.id (nullable, ON DELETE SET NULL)"
    - "sunday_agendas.ward_id -> wards.id"
    - "sunday_agendas.opening_prayer_member_id -> members.id (nullable)"
    - "sunday_agendas.closing_prayer_member_id -> members.id (nullable)"
    - "sunday_agendas.*_hymn_id -> hymns.id (nullable)"
    - "sunday_agendas.*_actor_id -> meeting_actors.id (nullable)"
    - "meeting_actors.ward_id -> wards.id"
    - "ward_topics.ward_id -> wards.id"
    - "ward_collection_config.ward_id -> wards.id"
    - "ward_collection_config.collection_id -> general_collections.id"
    - "general_topics.collection_id -> general_collections.id"
    - "sunday_exceptions.ward_id -> wards.id"
    - "invitations.ward_id -> wards.id"
    - "activity_log.ward_id -> wards.id"
    - "device_push_tokens.ward_id -> wards.id"
    - "notification_queue.ward_id -> wards.id"

# =============================================================================
# EDGE FUNCTIONS
# =============================================================================

edge_functions:
  - name: register-first-user
    auth: "None (called before login)"
    input: "{email, password, stakeName, wardName, role, language, timezone, fullName}"
    behavior: "Creates ward + user with app_metadata (ward_id, role, full_name). Auto-creates actor for bishopric."
    verify_jwt: false

  - name: register-invited-user
    auth: "None (called before login)"
    input: "{token, password, fullName}"
    behavior: "Validates invitation token, creates user with app_metadata, marks invitation used."
    verify_jwt: false

  - name: create-invitation
    auth: "JWT (bishopric or secretary)"
    input: "{email, role}"
    behavior: "Creates invitation record with token and deep link. Auto-creates actor for bishopric invitees."

  - name: list-users
    auth: "JWT (bishopric or secretary)"
    input: "{}"
    behavior: "Calls list_ward_users RPC. Returns [{id, email, role, full_name, created_at}]."

  - name: update-user-role
    auth: "JWT (bishopric or secretary)"
    input: "{targetUserId, newRole}"
    behavior: "Updates user role in app_metadata. Auto-creates actor when role -> bishopric."

  - name: update-user-name
    auth: "JWT (any authenticated user)"
    input: "{fullName}"
    behavior: "Self-name-update only. Updates caller's own app_metadata.full_name."
    added_in: "CR-81"

  - name: delete-user
    auth: "JWT (bishopric or secretary)"
    input: "{targetUserId}"
    behavior: "Deletes user. Cannot delete self."

  - name: process-notifications
    auth: "Service role (cron)"
    trigger: "Cron every 1 minute"
    behavior: "Processes pending notification_queue entries, groups designations by sunday, sends via Expo Push API."

# =============================================================================
# ROLES AND PERMISSIONS
# =============================================================================

roles:
  bishopric:
    description: "Bispado -- acesso total"
    permissions:
      - "speech:assign, speech:unassign, speech:change_status"
      - "member:read, member:write, member:import"
      - "topic:write, collection:toggle"
      - "sunday_type:write"
      - "settings:access, settings:language, settings:whatsapp, settings:timezone, settings:users"
      - "invite:manage, invitation:create"
      - "home:next_assignments, home:invite_mgmt"
      - "agenda:read, agenda:write, agenda:assign_speaker"
      - "presentation:start"
      - "push:receive"
      - "history:read"

  secretary:
    description: "Secretario -- acesso amplo, sem designar discursos"
    permissions:
      - "speech:change_status"
      - "member:read, member:write, member:import"
      - "topic:write, collection:toggle"
      - "sunday_type:write"
      - "settings:access, settings:language, settings:whatsapp, settings:timezone, settings:users"
      - "invite:manage, invitation:create"
      - "home:invite_mgmt"
      - "agenda:read, agenda:write, agenda:assign_speaker"
      - "presentation:start"
      - "push:receive"
      - "history:read"
    notes: "CR-23 added settings:users. CR-64 fixed server-side access."

  observer:
    description: "Observador -- somente leitura"
    permissions:
      - "member:read"
      - "agenda:read"
      - "presentation:start"
    notes: "Sem acesso a Settings. Nao recebe push notifications."

# =============================================================================
# SECURITY MODEL
# =============================================================================

security:
  authentication:
    provider: "Supabase Auth (email/password)"
    session: "JWT with app_metadata (role, ward_id, full_name)"
    token_refresh: "Automatic via Supabase SDK (autoRefreshToken: true)"
    password_reset: "Supabase built-in resetPasswordForEmail (CR-67)"

  authorization:
    rls: "All ward-scoped tables filtered by ward_id from JWT app_metadata"
    permissions: "Central role-to-permission map in lib/permissions.ts"
    edge_functions: "Verify JWT via auth.getUser(token); validate role + ward_id"

  data_isolation:
    mechanism: "PostgreSQL Row-Level Security"
    policy: "Users can only access rows where ward_id matches their app_metadata.ward_id"
    global_tables: "hymns, general_collections, general_topics (SELECT only for authenticated)"

  gateway:
    verify_jwt_legacy: "OFF (ADR-023, BUG-401)"
    notes: "EFs handle their own auth validation. Gateway check was redundant and harmful."

  client_guards:
    session_validation: "callEdgeFunction validates session before invoke (ADR-024)"
    query_guard: "useQuery enabled: !!session for authenticated queries (ADR-025)"

# =============================================================================
# CROSS-CUTTING CONCERNS
# =============================================================================

cross_cutting:
  multi_tenancy:
    mechanism: "PostgreSQL RLS on ward_id; ward_id in auth.users app_metadata"
    scope: "All ward-specific data isolated per ward"

  i18n:
    framework: "react-i18next"
    languages: ["pt-BR", "en", "es"]
    locale_files: "src/i18n/locales/{pt-BR,en,es}.json"
    initialization: "Device locale -> ward language override on login (CR-11)"

  permissions:
    file: "src/lib/permissions.ts"
    pattern: "Central role-to-permission map; hasPermission(role, perm) checked in UI and hooks"

  theme:
    context: "src/contexts/ThemeContext.tsx"
    modes: ["automatic", "light", "dark"]
    persistence: "AsyncStorage"
    pattern: "System detection + manual toggle"

  error_handling:
    boundary: "src/components/ErrorBoundary.tsx (root level)"
    query_errors: "src/components/QueryErrorView.tsx"
    mutation_errors: "Global MutationCache.onError with Alert"
    edge_function_errors: "callEdgeFunction extracts server error message (ADR-022)"

  gestures:
    wrapper: "GestureHandlerRootView in root layout (CR-82)"
    swipe: "SwipeableCard component for edit/delete actions (CR-87: Unicode icons, CR-90: pointerEvents='box-none' fix for Delete button)"
    animations: "react-native-reanimated for accordion, LED, presentation transitions"

  deep_links:
    scheme: "sacrmeetman://invite/{token}"
    handler: "expo-linking routes to (auth)/invite/[token].tsx"
    notes: "Changed from wardmanager:// to sacrmeetman:// (CR-93, ADR-009 updated)"

  activity_logging:
    utility: "src/lib/activityLog.ts"
    pattern: "createLogger(wardId, userId, userEmail, userName?) returns logger function"
    storage: "activity_log table with 2-year retention"
    display: "history.tsx shows user_name with email fallback"

# =============================================================================
# FILE STRUCTURE
# =============================================================================

file_structure:
  "src/app/":
    "_layout.tsx": "Root layout com providers (ErrorBoundary, GestureHandlerRootView, QueryClient, I18n, Theme, Auth, Sync)"
    "(auth)/":
      "_layout.tsx": "Auth group layout"
      "login.tsx": "Tela de login"
      "register.tsx": "Auto-registro (cria ala + usuario)"
      "forgot-password.tsx": "Recuperacao de senha via email"
      "invite/[token].tsx": "Registro via convite (deep link)"
    "(tabs)/":
      "_layout.tsx": "Tab navigator (Home, Agenda, Speeches, Settings)"
      "index.tsx": "Home tab (3 sundays, next assignments, invite mgmt)"
      "agenda.tsx": "Agenda tab (lista de domingos expandiveis)"
      "speeches.tsx": "Speeches tab (scroll infinito)"
      "settings/":
        "_layout.tsx": "Settings stack navigator"
        "index.tsx": "Settings menu (links para sub-telas)"
        "members.tsx": "CRUD membros + CSV import/export + info section + explanatory texts (CR-80) + Save/Cancel (CR-83) + SearchInput (CR-84) + import countryCodes (CR-85) + import confirm (CR-86) + SearchInput fixo no topo (CR-96)"
        "topics.tsx": "CRUD topicos da ala + colecoes gerais + Save/Cancel (CR-83) + SearchInput (CR-84) + description text (CR-88) + collection expand/collapse (CR-89) + SearchInput fixo no topo (CR-96)"
        "users.tsx": "Gerenciamento de usuarios (convite, role, nome, delete)"
        "history.tsx": "Log de atividades com busca e paginacao"
        "whatsapp.tsx": "Editor de template WhatsApp com preview"
        "theme.tsx": "Toggle de tema (automatic/light/dark)"
        "about.tsx": "Info do app, creditos, disclaimer"
        "timezone.tsx": "Seletor de timezone da ala"
    "presentation.tsx": "Modo Apresentacao (modal, read-only)"

  "src/providers/":
    "SyncProvider.tsx": "Orquestrador de sync, offline e notificacoes"

  "src/contexts/":
    "AuthContext.tsx": "Sessao, role, wardId, userName, permissoes"
    "ThemeContext.tsx": "Tema dark/light com system detection"

  "src/hooks/":
    "useMembers.ts": "CRUD membros via TanStack Query"
    "useTopics.ts": "CRUD topicos + toggle colecoes + useCollectionTopics (CR-89)"
    "useSpeeches.ts": "CRUD discursos + status lifecycle"
    "useAgenda.ts": "CRUD agenda + lazy creation"
    "useActors.ts": "CRUD atores (inline no AgendaForm)"
    "useSundayTypes.ts": "Auto-assign + override tipos de domingo"
    "useHymns.ts": "Busca de hinos (read-only)"
    "useActivityLog.ts": "Log paginado com busca"
    "usePresentationMode.ts": "Dados do modo apresentacao. CR-100: usa speaker_*_override quando existir."
    "useSundayList.ts": "Lista de domingos com scroll infinito"
    "useRealtimeSync.ts": "Subscricao Supabase Realtime"
    "useConnection.ts": "Monitor de conexao (NetInfo)"
    "useNotifications.ts": "Registro de token + handler de tap"
    "useOfflineQueueProcessor.ts": "Processa fila offline ao reconectar"

  "src/components/":
    "AgendaForm.tsx": "Formulario completo da agenda (4 secoes normal, 3 especial). CR-97: multi-select recognizing. CR-100: SpeakerField read-only + override. CR-121/F064: label '(Designacao de ultima hora)' quando hasOverride."
    "ActorSelector.tsx": "Bottom-sheet para selecao/CRUD de atores. CR-97: multiSelect + selectedNames props."
    "MemberSelectorModal.tsx": "Modal de selecao de membro com busca + custom name"
    "TopicSelectorModal.tsx": "Modal de selecao de topico (ward + general)"
    "HymnSelector.tsx": "Seletor de hinos por numero/titulo"
    "PrayerSelector.tsx": "Seletor de membro para oracoes. CR-125/F059: modalOnly prop suprime botao inline."
    "SundayCard.tsx": "Card expandivel por domingo. CR-115/F061: SundayTypeDropdown recebe speeches[] para confirmacao antes de mudar tipo."
    "SpeechSlot.tsx": "Slot de discurso (orador, topico, status). CR-114/F060: onClearTopic + botao X no tema. CR-116/F062: allowedStatuses para LED filtrado. CR-119/F063: layout [LED][Field][X]."
    "StatusLED.tsx": "LED 3D animado de status de discurso"
    "StatusChangeModal.tsx": "Modal de mudanca de status. CR-116/F062: prop allowedStatuses para filtrar opcoes."
    "AccordionCard.tsx": "Card expandivel para apresentacao (1 aberto por vez)"
    "SwipeableCard.tsx": "Card com swipe-to-reveal para edit/delete (CR-87: Unicode icons, CR-90: pointerEvents fix)"
    "DebouncedTextInput.tsx": "TextInput com auto-save debounced"
    "SearchInput.tsx": "TextInput de busca reutilizavel com botao X para limpar (CR-84)"
    "OfflineBanner.tsx": "Banner vermelho de offline"
    "ErrorBoundary.tsx": "Error boundary do React"
    "QueryErrorView.tsx": "View de erro para queries"
    "ExitConfirmation.tsx": "Confirmacao ao sair do app"
    "NextSundaysSection.tsx": "Secao Home: proximos 3 domingos. CR-114/F060: wiring de onClearTopic."
    "NextAssignmentsSection.tsx": "Secao Home: proximas designacoes (bishopric)"
    "InviteManagementSection.tsx": "Secao Home: gerenciamento de convites (secretary)"
    "InviteActionDropdown.tsx": "Dropdown customizado para acoes de convite (CR-106/F051). CR-113/F056: titulo usa t('speeches.changeStatus')."

  "src/lib/":
    "supabase.ts": "Cliente Supabase (anon key, resilientStorage)"
    "permissions.ts": "Mapa central de permissoes por role"
    "csvUtils.ts": "Parse/generate CSV com error codes i18n (ADR-026). splitPhoneNumber re-exportado de countryCodes.ts (CR-85)"
    "activityLog.ts": "Utility para logging de acoes (com userName)"
    "whatsapp.ts": "Construcao de URL WhatsApp. CR-94: re-exports templates i18n."
    "whatsappUtils.ts": "Template placeholders e resolucao. CR-94: templates DEFAULT_TEMPLATE_{EN,ES}, getDefaultTemplate(). CR-112/F055: buildWhatsAppConversationUrl(phone) para abrir conversa sem mensagem."
    "dateUtils.ts": "Formatacao de datas localizadas"
    "speechUtils.ts": "Utilitarios de discursos"
    "theme.ts": "Paleta de cores para dark/light"
    "sync.ts": "Mapping table -> query keys para cache invalidation"
    "connectionUtils.ts": "Utilitarios de conexao"
    "offlineQueue.ts": "Fila de mutacoes offline (AsyncStorage)"
    "offlineGuard.ts": "Guard para operacoes online-only"
    "notificationUtils.ts": "Utilitarios de notificacoes"
    "countryCodes.ts": "Lista completa de codigos internacionais (~200 paises), getFlagForCode, getCountryByLabel (CR-117), splitPhoneNumber (CR-85, ADR-031, ADR-043)"

  "src/types/":
    "database.ts": "Tipos TypeScript para todas as tabelas do banco"

  "src/i18n/":
    "index.ts": "Configuracao react-i18next"
    "locales/pt-BR.json": "Traducoes portugues (padrao)"
    "locales/en.json": "Traducoes ingles"
    "locales/es.json": "Traducoes espanhol"

  "supabase/":
    "config.toml": "Configuracao local do Supabase"
    "migrations/": "14 migrations SQL"
    "functions/":
      "register-first-user/": "Registro do primeiro usuario (cria ala)"
      "register-invited-user/": "Registro via convite"
      "create-invitation/": "Cria convite com token"
      "list-users/": "Lista usuarios da ala"
      "update-user-role/": "Altera role de usuario"
      "update-user-name/": "Auto-edicao de nome (CR-81)"
      "delete-user/": "Remove usuario"
      "process-notifications/": "Cron: processa fila de push"

  "scripts/":
    "import-hymns.ts": "CLI script para importar hinos de CSV (CR-51)"

# =============================================================================
# KEY FLOWS
# =============================================================================

key_flows:
  self_registration:
    steps:
      - "User preenche: Nome, Email, Password, Stake, Ward, Role, Language, Timezone"
      - "Client chama register-first-user EF com { fullName, email, password, ... }"
      - "EF valida, cria ward, cria user com app_metadata (ward_id, role, full_name)"
      - "Se role=bishopric: auto-cria meeting_actor (can_preside=true, can_conduct=true)"
      - "EF retorna session; client armazena via setSession()"
      - "AuthContext pega full_name de app_metadata"
      - "changeLanguage(ward.language) alinha i18n"
      - "NavigationGuard redireciona para (tabs)"

  invite_registration:
    steps:
      - "User abre deep link sacrmeetman://invite/{token}"
      - "Expo Router rota para (auth)/invite/[token].tsx"
      - "Screen valida token via EF, mostra campos read-only (stake, ward, role)"
      - "User preenche Nome e Password"
      - "Client chama register-invited-user EF"
      - "EF cria user, marca invitation used, retorna session"

  speech_assignment:
    steps:
      - "Bishopric expande SundayCard -> lazy creation de 3 speech records"
      - "Seleciona Speaker via MemberSelectorModal -> mutation seta member_id, snapshot name/phone, status=assigned_not_invited"
      - "Seleciona Topic via TopicSelectorModal -> mutation seta snapshot topic_title/link/collection"
      - "DB trigger enfileira notification (designation, send_after=now+5min)"
      - "Realtime atualiza todos os clients"

  agenda_configuration:
    steps:
      - "User abre Agenda tab -> scroll infinito de domingos"
      - "Domingos Gen Conf/Stake Conf aparecem como cards nao-expandiveis (CR-75)"
      - "User clica domingo -> lazy creation de sunday_agendas record"
      - "Formulario renderiza baseado no tipo: 4 secoes (normal) ou 3 (especial)"
      - "Cada mudanca auto-salva via mutation (debounced para text inputs)"

  presentation_mode:
    steps:
      - "No domingo, Home mostra 'Iniciar Reuniao Sacramental'"
      - "User toca -> PresentationMode abre (full-screen, read-only)"
      - "Header mostra data formatada localizada"
      - "Accordion cards: 1 expandido por vez, Welcome aberto por padrao"

  csv_import_export:
    steps_export:
      - "User toca Export CSV em Members"
      - "generateCsv(members) cria CSV com BOM + header (funciona mesmo com lista vazia)"
      - "expo-file-system escreve arquivo; expo-sharing apresenta share sheet"
    steps_import:
      - "User toca Import CSV"
      - "Alert.alert de confirmacao exibido (CR-86): avisa que lista sera substituida, designacoes nao afetadas"
      - "Cancelar: fecha dialogo, nada acontece"
      - "Confirmar: abre file picker via expo-document-picker"
      - "parseCsv retorna error codes (nao strings English) para i18n"
      - "Se valido: import_members RPC faz DELETE all + INSERT new"
      - "Erros mostrados com line numbers traduzidos (max 5, com '...and N more')"

  sync_flow:
    steps:
      - "SyncProvider monta useConnection -> NetInfo monitoring"
      - "useRealtimeSync subscreve canal Supabase para 7 tabelas ward-scoped"
      - "On event: CacheInvalidator mapeia table -> TanStack Query keys -> invalidateQueries"
      - "On WebSocket disconnect: fallback polling (2.5s interval)"
      - "On reconnect: refetch all, disable polling, resume Realtime"

# =============================================================================
# CHANGE REQUESTS HISTORY (summary)
# =============================================================================

change_requests_history:
  batch_1:
    crs: "CR-01 to CR-10"
    scope: "Bug fixes (home title, language mismatch, empty agenda, exception display, speech labels, sunday type enum, collection scroll, settings flash, theme/about screens)"
    doc: "ARCH_CR001.md"

  batch_2:
    crs: "CR-11 to CR-30"
    scope: "Language on start, WhatsApp fixes, activity log, secretary permissions, sunday dropdown, actors redesign (inline), debounced text inputs, agenda section labels"
    doc: "ARCH_CR002.md"

  batch_3:
    crs: "CR-31 to CR-43"
    scope: "Spec corrections, CSV import/export fix (CRITICAL), About screen, logout button, back buttons convention, WhatsApp template fixes, presentation date, topics search"
    doc: "ARCH_CR003.md"

  batch_4_features:
    groups:
      - crs: "CR-51"
        scope: "Import hymns CLI script"
        doc: "ARCH_CR4_F009.md"
      - crs: "CR-52, CR-53"
        scope: "Infrastructure integration (SyncProvider, OfflineBanner, notifications wiring)"
        doc: "ARCH_CR4_F003.md"
      - crs: "CR-54, CR-55, CR-66"
        scope: "CSV error handling, header spacer, empty export"
        doc: "ARCH_CR4_F005.md"
      - crs: "CR-64, CR-67"
        scope: "Users screen server fix, forgot password"
        doc: "ARCH_CR4_F007.md"
      - crs: "CR-71, CR-72, CR-73, CR-74, CR-75"
        scope: "Actor independence, auto-create actors, recognizing selector, custom prayers, non-expandable cards"
        doc: "ARCH_CR4_F008.md"

  bug_fix_cr76:
    crs: "CR-76"
    scope: "Fix Users screen HTTP 401 regression -- remove manual Auth header, extract server error"
    doc: "ARCH_CR76.md"

  bug_fix_401:
    crs: "BUG-401"
    scope: "Systemic 401 on all authenticated EFs -- disable gateway JWT verification + session guards"
    doc: "ARCH_BUG401.md"

  batch_5:
    crs: "CR-70, CR-77, CR-78, CR-79, CR-80"
    scope: "Actor icon size, CSV empty export fix, CSV error codes i18n, members info section, users back button + name field"
    doc: "ARCH_CR5.md"

  cr_79:
    crs: "CR-79"
    scope: "Users screen back button (per-screen pattern)"
    doc: "ARCH_CR79.md"

  cr_81:
    crs: "CR-81"
    scope: "User name field: registration, display, edit, activity log, auto-actor with real name"
    doc: "ARCH_CR81.md"

  cr_82:
    crs: "CR-82"
    scope: "GestureHandlerRootView wrapper no root layout"
    notes: "Commit ee9d84d. react-native-gesture-handler v2.x requer wrapper."

  f026_cr80:
    crs: "CR-80"
    scope: "Members screen explanatory texts with i18n (description + CSV help)"
    doc: "ARCH_M010.yaml"

  batch_6_phase_1:
    crs: "CR-83, CR-84, CR-85, CR-86, CR-90"
    scope: "Save/Cancel buttons (F027), SearchInput with X clear (F028), country codes expansion (F029), CSV import confirm dialog (F030), Delete button fix (F031)"
    doc: "ARCH_M011.yaml"
    status: "pending implementation"
    adrs: [ADR-030, ADR-031, ADR-032]
    new_files:
      - "src/components/SearchInput.tsx"
      - "src/lib/countryCodes.ts"

  batch_6_phase_2:
    crs: "CR-87, CR-88, CR-89"
    scope: "Swipe Unicode icons (F032), Topics explanatory text (F033), Collection topics expand/collapse view (F034)"
    doc: "ARCH_M012.yaml"
    status: "pending implementation"
    adrs: [ADR-033, ADR-034]
    new_files: []

  batch_7_phase_1:
    crs: "CR-91, CR-92, CR-93, CR-95, CR-98"
    scope: "Bug fixes: RLS policy on notification trigger (F035), duplicate key in country dropdown (F036), deep link protocol change (F037), speech fields visibility (F038), prayer fields clickable (F039)"
    doc: "ARCH_M013.yaml"
    status: "pending implementation"
    adrs: [ADR-035, ADR-036]
    new_files:
      - "supabase/migrations/013_fix_notification_trigger_security_definer.sql"

  batch_7_phase_2:
    crs: "CR-94, CR-96, CR-97, CR-99, CR-100"
    scope: "UX & Features: WhatsApp template i18n (F040), search fields fixed at top (F041), multi-select recognizing (F042), speech label change (F043), last-minute speaker swap (F044)"
    doc: "ARCH_M014.yaml"
    status: "pending implementation"
    adrs: [ADR-037, ADR-038]
    new_files:
      - "supabase/migrations/014_add_speaker_overrides.sql"

  batch_8_phase_1:
    crs: "CR-101, CR-102, CR-103, CR-104, CR-108, CR-109"
    scope: "Display fixes & WhatsApp: LED visibility (F045), agenda label filter (F046), WhatsApp template settings fallback (F047), WhatsApp message variables + date format + quotes (F048), speech slots in Home (F049)"
    doc: "ARCH_M015.yaml"
    status: "pending implementation"
    adrs: [ADR-039]
    new_files: []

  batch_8_phase_2:
    crs: "CR-105, CR-106, CR-107, CR-110, CR-111"
    scope: "Invite Management UX: icon buttons (F050), custom dropdown (F051), enhanced second line (F052), bishopric visibility (F053), SpeechSlot spacing (F054)"
    doc: "ARCH_M016.yaml"
    status: "pending implementation"
    adrs: [ADR-040, ADR-041]
    new_files:
      - "src/components/InviteActionDropdown.tsx"

  batch_9_phase_1:
    crs: "CR-112, CR-113, CR-117, CR-122, CR-125"
    scope: "Bug fixes & Quick UI: WhatsApp conversation without resending (F055), dropdown title i18n (F056), +1 country code fix (F057), last speech label (F058), prayer field duplication fix (F059)"
    doc: "ARCH_M017.yaml"
    status: "pending implementation"
    adrs: [ADR-042, ADR-043]
    new_files: []

  batch_9_phase_2:
    crs: "CR-114, CR-115, CR-116, CR-119, CR-121"
    scope: "Speech Cards & Agenda: remove topic X button (F060), type change confirmation (F061), LED filtered options (F062), speech card layout reorder (F063), last-minute assignment label (F064)"
    doc: "ARCH_M018.yaml"
    status: "pending implementation"
    adrs: [ADR-044, ADR-045]
    new_files: []

# =============================================================================
# OBSERVABILITY
# =============================================================================

observability:
  activity_log:
    table: "activity_log"
    scope: "Ward-scoped, 2-year retention"
    logged_actions: "Member CRUD, topic CRUD, actor CRUD, speech assign/status, agenda changes, sunday type changes"
    not_logged: "Auto-assignments, lazy creation, push processing, token registration"
    display: "history.tsx with search, pagination, user_name fallback to email"

  push_queue:
    table: "notification_queue"
    statuses: ["pending", "sent", "cancelled"]

  connection_monitoring:
    component: "useConnection hook"
    tracks: "NetInfo status, WebSocket connected state"
    display: "OfflineBanner (red bar above all content)"

  error_reporting:
    query_errors: "console.error via QueryCache.onError"
    mutation_errors: "Alert via MutationCache.onError (suppressible per mutation)"
    edge_function_errors: "Server error extraction via error.context.json() (ADR-022)"
