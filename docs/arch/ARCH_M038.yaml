# =============================================================================
# ARCH_M038.yaml
# Architecture for Batch 23 Phase 1: F140, F141, F142
# CR-205 (Invite Error Handling), CR-206 (Language Switch Collections/Template),
# CR-207 (WhatsApp Template Disconnect)
# Created: 2026-02-22
# =============================================================================

type: arch
version: 1
status: complete

# =============================================================================
# OVERVIEW
# =============================================================================

overview:
  goal: "Fix three critical bugs: invite error messages swallowed (CR-205), language switch breaks collections and WhatsApp template (CR-206), WhatsApp send ignores custom template (CR-207)"
  principles:
    - "Minimal surgical fixes: change only the broken lines, no refactoring"
    - "Reuse existing patterns: suppressGlobalError meta flag, ward query key, useAuth() context"
    - "Data completeness: seed en/es collections so language switch does not result in empty state"
    - "Single source of truth: ward template from DB used everywhere, not hardcoded empty string"

# =============================================================================
# DIAGRAM
# =============================================================================

diagram: |
  F140 (Invite Error Handling):
    callEdgeFunction() -> throws Error(serverMessage || error.message) [NO CHANGE]
    inviteMutation.onError(err) -> Alert.alert(err.message || t('users.inviteFailed')) [FIX]
    inviteMutation.meta.suppressGlobalError = true -> MutationCache skips [FIX]

  F141 (Language Switch Collections + WhatsApp Template):
    Migration 019: INSERT general_collections + general_topics for 'en' and 'es' [NEW]
    wardLanguageChangeMutation:
      .update({ language, whatsapp_template: null }) [FIX]
      .onSuccess: invalidateQueries(['ward', wardId]) [FIX]
    whatsapp.tsx:
      useEffect: reset initialized when wardLanguage changes [FIX]

  F142 (WhatsApp Template Disconnect):
    InviteManagementSection:
      useQuery(['ward', wardId]) -> fetch whatsapp_template [FIX]
      useAuth() -> wardLanguage [FIX]
      buildWhatsAppUrl(phone, '', wardTemplate, vars, wardLanguage) [FIX]

# =============================================================================
# COMPONENTS
# =============================================================================

components:
  - name: "InviteMutationErrorFix"
    responsibility: "Show actual server error message in invite error alert and suppress duplicate global error"
    file: "src/app/(tabs)/settings/users.tsx"
    changes:
      - "inviteMutation.onError: change from ignoring err to showing err.message with fallback to t('users.inviteFailed')"
      - "inviteMutation options: add meta: { suppressGlobalError: true } to prevent MutationCache duplicate alert"
    dependencies: []

  - name: "CollectionsSeedMigration"
    responsibility: "Provide general_collections and general_topics seed data for 'en' and 'es' languages"
    file: "supabase/migrations/019_seed_en_es_collections.sql (NEW)"
    changes:
      - "INSERT general_collections rows for 'en' language (mirroring pt-BR structure with English names)"
      - "INSERT general_collections rows for 'es' language (mirroring pt-BR structure with Spanish names)"
      - "INSERT general_topics rows for each 'en' collection with English titles and links"
      - "INSERT general_topics rows for each 'es' collection with Spanish titles and links"
      - "Use uuid_generate_v4() for all IDs (auto-generated by DEFAULT)"
      - "Use DO $$ block with variables to link topics to their parent collection IDs"
    dependencies: []

  - name: "WardLanguageTemplateReset"
    responsibility: "Reset whatsapp_template to NULL and invalidate ward cache when ward language changes"
    file: "src/app/(tabs)/settings/index.tsx"
    changes:
      - "wardLanguageChangeMutation.mutationFn: add whatsapp_template: null to the wards update query alongside language"
      - "wardLanguageChangeMutation.onSuccess: add queryClient.invalidateQueries({ queryKey: ['ward', wardId] }) to invalidate the ward cache"
    dependencies: []

  - name: "WhatsAppTemplateInitReset"
    responsibility: "Reset the initialized flag when wardLanguage changes so template re-evaluates"
    file: "src/app/(tabs)/settings/whatsapp.tsx"
    changes:
      - "Add useEffect that watches wardLanguage and resets initialized to false when it changes"
    dependencies: ["WardLanguageTemplateReset (must invalidate ward cache so whatsapp.tsx refetches)"]

  - name: "InviteManagementTemplateFix"
    responsibility: "Fetch ward whatsapp_template from DB and use wardLanguage instead of app language"
    file: "src/components/InviteManagementSection.tsx"
    changes:
      - "Add useQuery(['ward', wardId]) to fetch wards.whatsapp_template"
      - "Replace getCurrentLanguage() with wardLanguage from useAuth() for locale"
      - "Pass fetched whatsapp_template (or '' if null/loading) to buildWhatsAppUrl instead of hardcoded ''"
      - "Use wardLanguage in formatDateHumanReadable and buildWhatsAppUrl language parameter"
      - "Remove getCurrentLanguage import (no longer needed)"
    dependencies: []

# =============================================================================
# CONTRACTS
# =============================================================================

contracts:
  - name: "invite_mutation_error_contract"
    component: "InviteMutationErrorFix"
    methods:
      - name: "onError(err)"
        input: "Error object from callEdgeFunction (err.message contains server error or generic Supabase error)"
        output: "Alert.alert(t('common.error'), err.message || t('users.inviteFailed')). Single alert only (no MutationCache duplicate)."

  - name: "ward_language_change_contract"
    component: "WardLanguageTemplateReset"
    methods:
      - name: "mutationFn(newLanguage)"
        input: "SupportedLanguage ('en' | 'es' | 'pt-BR')"
        output: "Updates wards row: { language: newLanguage, whatsapp_template: null }. Deactivates old language collections. Activates new language collections."
      - name: "onSuccess"
        input: "Mutation completed successfully"
        output: "Calls setWardLanguage(newLanguage). Invalidates topicKeys.all. Invalidates ['ward', wardId] query."

  - name: "whatsapp_template_init_contract"
    component: "WhatsAppTemplateInitReset"
    methods:
      - name: "useEffect [wardLanguage]"
        input: "wardLanguage changes (from AuthContext)"
        output: "Sets initialized to false. On next render, the existing useEffect [ward, initialized, wardLanguage] will re-run and load the correct default template for the new language."

  - name: "invite_management_template_contract"
    component: "InviteManagementTemplateFix"
    methods:
      - name: "useQuery ['ward', wardId]"
        input: "wardId from useAuth()"
        output: "{ whatsapp_template: string | null } from wards table"
      - name: "handleNotInvitedAction"
        input: "Speech object with speaker data"
        output: "Calls buildWhatsAppUrl with: phone=speech.speaker_phone, countryCode='', template=ward.whatsapp_template ?? '', variables={...}, language=wardLanguage. Uses wardLanguage for formatDateHumanReadable."

  - name: "seed_migration_contract"
    component: "CollectionsSeedMigration"
    methods:
      - name: "019_seed_en_es_collections.sql"
        input: "Empty general_collections for 'en' and 'es' languages"
        output: "Collections and topics seeded for both languages. pt-BR data untouched. Idempotent (uses uuid_generate_v4 with DO block that checks language existence before INSERT)."

# =============================================================================
# DATA MODEL
# =============================================================================

data_model:
  entities: []
  changes:
    - table: "general_collections"
      change: "New seed rows for languages 'en' and 'es' (INSERT only, no schema change)"
    - table: "general_topics"
      change: "New seed rows linked to 'en' and 'es' collections (INSERT only, no schema change)"
    - table: "wards"
      change: "whatsapp_template field set to NULL on language switch (existing column, no schema change)"
  notes: "No schema changes. No new tables. No new columns. Only data inserts and runtime behavior changes."

# =============================================================================
# SECURITY
# =============================================================================

security:
  notes: |
    - F140: No security impact. Error messages from server are already sanitized by the Edge Function.
      The server controls what error text is returned. No user input is reflected in error messages.
    - F141: Migration uses INSERT only. No DELETE/UPDATE on existing data. RLS policies on
      general_collections and general_topics already allow SELECT for all authenticated users.
    - F142: Ward query uses existing RLS policy (wards table SELECT for authenticated users in ward).
      wardId comes from useAuth() (server-verified via JWT app_metadata). No new data exposure.

# =============================================================================
# OBSERVABILITY
# =============================================================================

observability:
  notes: |
    - F140: Error messages now visible to user (previously swallowed). No new logging needed.
    - F141: Ward language change mutation already logs via activity log. No additional logging needed.
    - F142: Ward template query uses standard TanStack Query. Errors visible via QueryCache.onError.

# =============================================================================
# ADRs
# =============================================================================

adrs:
  - id: ADR-091
    title: "Use err.message with i18n fallback for invite mutation error display"
    context: >
      inviteMutation.onError in users.tsx discards the error object and always shows
      t('users.inviteFailed'). The actual server error (e.g., "User already exists") is
      available in err.message because callEdgeFunction already extracts it from
      error.context.json().error. Additionally, the global MutationCache.onError fires a
      second generic alert because inviteMutation lacks the suppressGlobalError meta flag.
    decision: >
      Show err.message in the Alert (with t('users.inviteFailed') as fallback for empty/null).
      Add meta: { suppressGlobalError: true } to inviteMutation. This is the same pattern
      used by the MutationCache.onError handler (line 22 in _layout.tsx) and requires no
      changes to _layout.tsx.
    decided_in: "CR-205"
    consequences:
      - "Users see actual server error messages (e.g., 'User already exists', 'Invalid email')"
      - "Single error alert instead of duplicate (inviteMutation + MutationCache)"
      - "Fallback to generic i18n message if err.message is empty"

  - id: ADR-092
    title: "Reset whatsapp_template to NULL and initialized flag on ward language change"
    context: >
      When ward language changes, whatsapp_template retains the old language text and the
      whatsapp.tsx initialized flag prevents re-evaluation. The template screen shows the
      old language template, and sending WhatsApp messages uses the old template.
    decision: >
      In wardLanguageChangeMutation (settings/index.tsx), update wards with both
      { language: newLanguage, whatsapp_template: null } in a single update call.
      Invalidate ['ward', wardId] query in onSuccess. In whatsapp.tsx, add a separate
      useEffect watching wardLanguage that resets initialized to false. This triggers
      the existing useEffect to re-run and load the default template for the new language.
    decided_in: "CR-206"
    consequences:
      - "Custom templates are lost on language switch (intentional: old language template not useful)"
      - "Template screen shows correct default for new language immediately"
      - "Two useEffects in whatsapp.tsx: one for init, one for language change reset"

  - id: ADR-093
    title: "Fetch ward template via useQuery in InviteManagementSection instead of hardcoded empty string"
    context: >
      InviteManagementSection passes template='' to buildWhatsAppUrl, which always falls back
      to the default template. The user's custom template from Settings > WhatsApp Template
      is never used when actually sending WhatsApp messages. Additionally, getCurrentLanguage()
      returns the app display language instead of the ward language for template/date formatting.
    decision: >
      Add useQuery(['ward', wardId]) to InviteManagementSection to fetch wards.whatsapp_template.
      This reuses the same query key as whatsapp.tsx, benefiting from TanStack Query's cache.
      Pass the fetched template to buildWhatsAppUrl (falling back to '' if null/loading, which
      causes buildWhatsAppUrl to use getDefaultTemplate). Use wardLanguage from useAuth() for
      both buildWhatsAppUrl language param and formatDateHumanReadable, replacing getCurrentLanguage().
    decided_in: "CR-207"
    consequences:
      - "WhatsApp messages sent from Home match template configured in Settings"
      - "Shared query key ['ward', wardId] means template updates propagate via cache"
      - "Date formatting in WhatsApp messages uses ward language (correct for recipient)"
      - "Loading state: if ward query not yet loaded, template is '' and default is used (acceptable fallback)"

# =============================================================================
# FILES IMPACTED
# =============================================================================

files_impacted:
  - file: src/app/(tabs)/settings/users.tsx
    feature: F140
    changes:
      - "Line 108: inviteMutation.onError: change from `() =>` to `(err: Error) =>`, show err.message || t('users.inviteFailed')"
      - "Line 101-111: Add meta: { suppressGlobalError: true } to inviteMutation useMutation options"

  - file: supabase/migrations/019_seed_en_es_collections.sql (NEW)
    feature: F141
    changes:
      - "New migration file with DO $$ block"
      - "INSERT general_collections for 'en' (mirroring pt-BR collection names in English)"
      - "INSERT general_collections for 'es' (mirroring pt-BR collection names in Spanish)"
      - "INSERT general_topics for each 'en' collection with English titles/links"
      - "INSERT general_topics for each 'es' collection with Spanish titles/links"
      - "Topics cover LDS/Church sacrament meeting themes: Faith, Repentance, Service, Family, etc."

  - file: src/app/(tabs)/settings/index.tsx
    feature: F141
    changes:
      - "Line 63-64: wardLanguageChangeMutation.mutationFn: change .update({ language: newLanguage }) to .update({ language: newLanguage, whatsapp_template: null })"
      - "Line 102-107: wardLanguageChangeMutation.onSuccess: add queryClient.invalidateQueries({ queryKey: ['ward', wardId] })"

  - file: src/app/(tabs)/settings/whatsapp.tsx
    feature: F141
    changes:
      - "Add new useEffect watching wardLanguage that sets initialized to false when wardLanguage changes"
      - "useEffect uses a ref to track previous wardLanguage to avoid resetting on initial mount"

  - file: src/components/InviteManagementSection.tsx
    feature: F142
    changes:
      - "Add wardId and wardLanguage from useAuth() destructuring"
      - "Add supabase import for ward query"
      - "Add useQuery(['ward', wardId]) to fetch wards.whatsapp_template"
      - "Replace `const locale = getCurrentLanguage()` with `const locale = wardLanguage as SupportedLanguage || getCurrentLanguage()`"
      - "In handleNotInvitedAction: change template param from '' to `ward?.whatsapp_template ?? ''`"
      - "In handleNotInvitedAction: ensure formatDateHumanReadable uses wardLanguage"
      - "Add wardTemplate to useCallback dependency array"
      - "Remove getCurrentLanguage import if no longer needed"

files_not_modified:
  - src/app/_layout.tsx
  - supabase/functions/create-invitation/index.ts
  - src/lib/whatsappUtils.ts
  - src/lib/whatsapp.ts
  - src/hooks/useTopics.ts
  - src/app/(tabs)/settings/topics.tsx

# =============================================================================
# CROSS-FEATURE INTERACTIONS
# =============================================================================

cross_feature_interactions:
  - features: [F141, F142]
    interaction: >
      F141 resets whatsapp_template to NULL on language switch and invalidates ['ward', wardId].
      F142 adds a useQuery(['ward', wardId]) in InviteManagementSection. After F141's language
      switch, the invalidation causes F142's query to refetch, getting the new NULL template.
      buildWhatsAppUrl then correctly falls back to getDefaultTemplate(wardLanguage) for the
      new language. These features are complementary and work together seamlessly via the
      shared query key.

  - features: [F141, F141]
    interaction: >
      Within F141 itself, the settings/index.tsx change (reset template + invalidate cache) and
      the whatsapp.tsx change (reset initialized flag) work together. The cache invalidation
      causes whatsapp.tsx's useQuery to refetch the ward record (with template=null). The
      initialized reset causes the useEffect to re-run and set the default template for the
      new language. Order: onSuccess fires -> setWardLanguage + invalidateQueries -> AuthContext
      updates wardLanguage -> whatsapp.tsx useEffect[wardLanguage] fires -> initialized=false ->
      useEffect[ward, initialized, wardLanguage] fires -> loads default template.

# =============================================================================
# VALIDATION GATE
# =============================================================================

validation_gate:
  GATE-01_read_arch_consolidated: true
  GATE-02_single_responsibility: true    # Each component has exactly one fix responsibility
  GATE-03_contracts_defined: true        # Contracts defined for all integrations
  GATE-04_adrs_recorded: true           # ADR-091, ADR-092, ADR-093
  GATE-05_arch_saved: true              # ARCH_M038.yaml saved
  GATE-06_arch_consolidated_updated: true   # ARCH_CONSOLIDATED updated with ADR-091/092/093, M001/M002/M003/M008 modules
  GATE-07_arch_summary_filled: true     # Summary in message to team lead
  GATE-08_max_components: true          # 5 components, under 10 limit
