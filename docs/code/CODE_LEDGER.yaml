# =============================================================================
# CODE_LEDGER.yaml
# Tracks commits made for CR-82, CR-80, CR-83, CR-84, CR-85, CR-86, CR-90,
# CR-87, CR-88, CR-89, CR-91, CR-92, CR-93, CR-95, CR-98
# Generated: 2026-02-18
# =============================================================================

metadata:
  project: Sacrament Meeting Planner
  change_requests: [CR-82, CR-80, CR-83, CR-84, CR-85, CR-86, CR-90, CR-87, CR-88, CR-89, CR-91, CR-92, CR-93, CR-95, CR-98]
  plan_ref: plans/PLAN_P013.yaml
  arch_ref: arch/ARCH_M013.yaml
  spec_ref: specs/SPEC_F035_F039.yaml

commits:

  # --- CR-82 commits ---

  - step: 1
    cr: CR-82
    hash: ee9d84d
    message: "fix(layout): add GestureHandlerRootView wrapper to root layout (CR-82)"
    files_changed:
      - src/app/_layout.tsx
    changes:
      - id: CHG-01
        description: "Added import { GestureHandlerRootView } from 'react-native-gesture-handler'"
      - id: CHG-02
        description: "Wrapped provider tree with <GestureHandlerRootView style={{ flex: 1 }}> inside ErrorBoundary"
    acs_covered: [AC-001, AC-002, AC-003, AC-004, AC-005, AC-006]
    ecs_covered: [EC-001]

  - step: 2
    cr: CR-82
    hash: 37e880b
    message: "test(layout): add tests for GestureHandlerRootView wrapper (CR-82)"
    files_changed:
      - src/__tests__/cr082-gesture-handler-root.test.ts
    tests_added: 9
    test_ids: [T-001, T-002, T-003, T-004, T-005, T-006, T-007, T-008, T-009]
    acs_covered: [AC-001, AC-002, AC-003, AC-004, AC-005, AC-006]
    ecs_covered: [EC-001, EC-002]

  # --- CR-80 commits ---

  - step: 1
    cr: CR-80
    plan_ref: plans/PLAN_P010.yaml
    plan_step: STEP-01
    hash: 9359348
    message: "feat(i18n): add members.description and members.csvHelp keys in pt-BR/en/es (CR-80)"
    files_changed:
      - src/i18n/locales/en.json
      - src/i18n/locales/pt-BR.json
      - src/i18n/locales/es.json
    changes:
      - id: CHG-03
        description: "Added members.description key with English text to en.json"
      - id: CHG-04
        description: "Added members.csvHelp key with English text to en.json"
      - id: CHG-05
        description: "Added members.description key with Portuguese text to pt-BR.json"
      - id: CHG-06
        description: "Added members.csvHelp key with Portuguese text to pt-BR.json"
      - id: CHG-07
        description: "Added members.description key with Spanish text to es.json"
      - id: CHG-08
        description: "Added members.csvHelp key with Spanish text to es.json"
    acs_covered: [AC-4, AC-5, AC-6]
    ecs_covered: [EC-2]

  - step: 2
    cr: CR-80
    plan_ref: plans/PLAN_P010.yaml
    plan_step: STEP-02
    hash: 84bea70
    message: "feat(members): add description and csvHelp explanatory texts (CR-80)"
    files_changed:
      - src/app/(tabs)/settings/members.tsx
    changes:
      - id: CHG-09
        description: "Added <Text> with t('members.description') between header and searchContainer"
      - id: CHG-10
        description: "Added <Text> with t('members.csvHelp') inside canImport block after csvActions"
      - id: CHG-11
        description: "Added description style (fontSize 13, textAlign center, paddingHorizontal 16, marginBottom 8)"
      - id: CHG-12
        description: "Added csvHelp style (fontSize 12, paddingHorizontal 16, marginBottom 8)"
      - id: CHG-13
        description: "Wrapped canImport block content with React Fragment to include csvHelp text"
    acs_covered: [AC-1, AC-2, AC-3]
    ecs_covered: [EC-1, EC-3]

  - step: 3
    cr: CR-80
    plan_ref: plans/PLAN_P010.yaml
    plan_step: STEP-03
    hash: null
    message: "Regression verification (no code changes)"
    files_changed: []
    changes: []
    acs_covered: [AC-7]
    ecs_covered: [EC-2]

  # --- Batch 6, Phase 1: CR-83, CR-84, CR-85, CR-86, CR-90 ---

  - step: STEP-01
    cr: CR-90
    plan_ref: plans/PLAN_P011.yaml
    plan_step: STEP-01
    hash: 298258c
    message: "fix(swipeable): add pointerEvents box-none to fix Delete button touch (CR-90)"
    files_changed:
      - src/components/SwipeableCard.tsx
    changes:
      - id: CHG-14
        description: "Added pointerEvents='box-none' to Animated.View wrapping card content"
      - id: CHG-15
        description: "Moved backgroundColor from Animated.View style to inner <View> wrapper"
    acs_covered: [AC-F031-01, AC-F031-02, AC-F031-03, AC-F031-04]

  - step: STEP-02
    cr: CR-83
    plan_ref: plans/PLAN_P011.yaml
    plan_step: STEP-02
    hash: 89b5dc9
    message: "feat(members): replace onBlur auto-save with Save/Cancel buttons (CR-83)"
    files_changed:
      - src/app/(tabs)/settings/members.tsx
    changes:
      - id: CHG-16
        description: "Removed onBlur={handleSave} from name and phone TextInputs"
      - id: CHG-17
        description: "Made onCancel required in MemberEditorProps"
      - id: CHG-18
        description: "Added Save/Cancel Pressable buttons below phone row"
      - id: CHG-19
        description: "Added editorButtons, cancelButton, saveButton styles"
      - id: CHG-20
        description: "Updated MemberRow to pass onCancel to MemberEditor"
    acs_covered: [AC-F027-01, AC-F027-02, AC-F027-03, AC-F027-04, AC-F027-08]

  - step: STEP-03
    cr: CR-83
    plan_ref: plans/PLAN_P011.yaml
    plan_step: STEP-03
    hash: 1970e71
    message: "feat(topics): replace onBlur auto-save with Save/Cancel buttons (CR-83)"
    files_changed:
      - src/app/(tabs)/settings/topics.tsx
    changes:
      - id: CHG-21
        description: "Removed onBlur={handleSave} from title and link TextInputs"
      - id: CHG-22
        description: "Added onCancel prop to TopicEditorProps (required)"
      - id: CHG-23
        description: "Added Save/Cancel buttons below link input"
      - id: CHG-24
        description: "Updated TopicRow to pass onCancel to TopicEditor"
    acs_covered: [AC-F027-05, AC-F027-06, AC-F027-07, AC-F027-08]

  - step: STEP-04
    cr: CR-85
    plan_ref: plans/PLAN_P011.yaml
    plan_step: STEP-04
    hash: 8d0f6c4
    message: "feat(lib): create countryCodes.ts with ~200 country codes and splitPhoneNumber (CR-85)"
    files_changed:
      - src/lib/countryCodes.ts
    changes:
      - id: CHG-25
        description: "Created countryCodes.ts with CountryCode interface, 172 entries, getFlagForCode, splitPhoneNumber"
    acs_covered: [AC-F029-01, AC-F029-02, AC-F029-04, AC-F029-05]

  - step: STEP-05
    cr: CR-85
    plan_ref: plans/PLAN_P011.yaml
    plan_step: STEP-05
    hash: 59eaba7
    message: "refactor(members,csv): use shared countryCodes.ts as single source of truth (CR-85)"
    files_changed:
      - src/app/(tabs)/settings/members.tsx
      - src/lib/csvUtils.ts
    changes:
      - id: CHG-26
        description: "Removed local CountryCode, COUNTRY_CODES, getFlagForCode from members.tsx"
      - id: CHG-27
        description: "Added import from countryCodes.ts in members.tsx"
      - id: CHG-28
        description: "Removed local splitPhoneNumber from csvUtils.ts, re-exported from countryCodes"
    acs_covered: [AC-F029-03]

  - step: STEP-06
    cr: CR-86
    plan_ref: plans/PLAN_P011.yaml
    plan_step: STEP-06
    hash: 5d65fb1
    message: "feat(i18n): add members.importConfirmTitle and importConfirmMessage keys (CR-86)"
    files_changed:
      - src/i18n/locales/en.json
      - src/i18n/locales/pt-BR.json
      - src/i18n/locales/es.json
    changes:
      - id: CHG-29
        description: "Added importConfirmTitle and importConfirmMessage keys in en, pt-BR, es"
    acs_covered: [AC-F030-05]

  - step: STEP-07
    cr: CR-86
    plan_ref: plans/PLAN_P011.yaml
    plan_step: STEP-07
    hash: 5837628
    message: "feat(members): add confirmation dialog before CSV import (CR-86)"
    files_changed:
      - src/app/(tabs)/settings/members.tsx
    changes:
      - id: CHG-30
        description: "Renamed handleImport to performImport (file picker logic)"
      - id: CHG-31
        description: "Created new handleImport with Alert.alert confirmation before import"
    acs_covered: [AC-F030-01, AC-F030-02, AC-F030-03, AC-F030-04]

  - step: STEP-08
    cr: CR-84
    plan_ref: plans/PLAN_P011.yaml
    plan_step: STEP-08
    hash: 8f2b42a
    message: "feat(components): create SearchInput component with clear X button (CR-84)"
    files_changed:
      - src/components/SearchInput.tsx
    changes:
      - id: CHG-32
        description: "Created SearchInput with useTheme internally, clear X button, paddingRight 36"
    acs_covered: [AC-F028-01, AC-F028-02, AC-F028-03, AC-F028-04, AC-F028-05]

  - step: STEP-09
    cr: CR-84
    plan_ref: plans/PLAN_P011.yaml
    plan_step: STEP-09
    hash: 27daf39
    message: "feat(settings): migrate search fields to SearchInput in 4 settings screens (CR-84)"
    files_changed:
      - src/app/(tabs)/settings/members.tsx
      - src/app/(tabs)/settings/topics.tsx
      - src/app/(tabs)/settings/history.tsx
      - src/app/(tabs)/settings/timezone.tsx
    changes:
      - id: CHG-33
        description: "Replaced search TextInput with SearchInput in members, topics, history, timezone"
      - id: CHG-34
        description: "Removed unused searchInput styles and TextInput imports where applicable"
    acs_covered: [AC-F028-06]

  - step: STEP-10
    cr: CR-84
    plan_ref: plans/PLAN_P011.yaml
    plan_step: STEP-10
    hash: ede8904
    message: "feat(components): migrate search fields to SearchInput in 6 modal/selector components (CR-84)"
    files_changed:
      - src/components/HymnSelector.tsx
      - src/components/MemberSelectorModal.tsx
      - src/components/TopicSelectorModal.tsx
      - src/components/PrayerSelector.tsx
      - src/components/ActorSelector.tsx
      - src/components/AgendaForm.tsx
    changes:
      - id: CHG-35
        description: "Replaced search TextInput with SearchInput in 6 modal/selector components"
      - id: CHG-36
        description: "Removed unused TextInput imports where applicable"
    acs_covered: [AC-F028-06]

  # --- Regression fixes from Phase 1 review ---

  - step: R-B6P1-01
    cr: CR-84
    hash: ac4b489
    message: "fix(tests): update CR-39 tests for SearchInput migration in topics.tsx (R-B6P1-01)"
    files_changed:
      - src/__tests__/cr003-qa.test.ts
    changes:
      - id: CHG-37
        description: "Updated AC-39.1 test to check for 'SearchInput' instead of 'searchInput' style"
      - id: CHG-38
        description: "Updated AC-39.5 test to verify SearchInput import and component styles"

  - step: R-B6P1-02
    cr: CR-86
    hash: 27a4383
    message: "fix(tests): update CSV import test to reference performImport after CR-86 refactor (R-B6P1-02)"
    files_changed:
      - src/__tests__/cr004-f005-csv-members.test.ts
    changes:
      - id: CHG-39
        description: "Updated test to extract performImport body instead of handleImport for error handling check"

  - step: R-B6P1-03
    cr: CR-84
    hash: 3b780d4
    message: "fix(tests): update CR-80 regression test for SearchInput migration in members.tsx (R-B6P1-03)"
    files_changed:
      - src/__tests__/cr080-f026-members-explanatory-texts.test.ts
    changes:
      - id: CHG-40
        description: "Updated AC-7 regression test to check for 'SearchInput' instead of 'searchInput'"

  # --- Batch 6, Phase 2: CR-87, CR-88, CR-89 ---

  - step: STEP-01
    cr: CR-87
    plan_ref: plans/PLAN_P012.yaml
    plan_step: STEP-01
    hash: 4e0fbb7
    message: "feat(swipeable): replace Edit/Delete text with Unicode icons pencil/trash (CR-87)"
    files_changed:
      - src/components/SwipeableCard.tsx
    changes:
      - id: CHG-41
        description: "Replaced Edit button Text content from editLabel to pencil Unicode character (U+270F)"
      - id: CHG-42
        description: "Replaced Delete button Text content from deleteLabel to wastebasket Unicode character (U+1F5D1)"
      - id: CHG-43
        description: "Changed both Text styles from styles.actionText to styles.actionIcon"
      - id: CHG-44
        description: "Added actionIcon style with fontSize 20 and textAlign center"
    acs_covered: [AC-F032-01, AC-F032-02, AC-F032-03, AC-F032-04, AC-F032-05]

  - step: STEP-02
    cr: CR-88
    plan_ref: plans/PLAN_P012.yaml
    plan_step: STEP-02
    hash: 98dbee2
    message: "feat(i18n): add topics.description and topics.noTopics keys in 3 locales (CR-88)"
    files_changed:
      - src/i18n/locales/en.json
      - src/i18n/locales/pt-BR.json
      - src/i18n/locales/es.json
    changes:
      - id: CHG-45
        description: "Added topics.description key with explanatory text in en.json"
      - id: CHG-46
        description: "Added topics.noTopics key ('No topics in this collection') in en.json"
      - id: CHG-47
        description: "Added topics.description key with Portuguese text in pt-BR.json"
      - id: CHG-48
        description: "Added topics.noTopics key ('Nenhum tema nesta colecao') in pt-BR.json"
      - id: CHG-49
        description: "Added topics.description key with Spanish text in es.json"
      - id: CHG-50
        description: "Added topics.noTopics key ('No hay temas en esta coleccion') in es.json"
    acs_covered: [AC-F033-03, AC-F033-06]

  - step: STEP-03
    cr: CR-88
    plan_ref: plans/PLAN_P012.yaml
    plan_step: STEP-03
    hash: 8431360
    message: "feat(topics): add explanatory description text below header (CR-88)"
    files_changed:
      - src/app/(tabs)/settings/topics.tsx
    changes:
      - id: CHG-51
        description: "Added <Text> with t('topics.description') between header and Ward Topics section"
      - id: CHG-52
        description: "Added description style (fontSize 13, textAlign center, paddingHorizontal 16, marginBottom 8)"
    acs_covered: [AC-F033-01, AC-F033-02, AC-F033-04, AC-F033-05]

  - step: STEP-04
    cr: CR-89
    plan_ref: plans/PLAN_P012.yaml
    plan_step: STEP-04
    hash: 445f7b7
    message: "feat(hooks): add useCollectionTopics hook for lazy-loading collection topics (CR-89)"
    files_changed:
      - src/hooks/useTopics.ts
    changes:
      - id: CHG-53
        description: "Added collectionTopics key function to topicKeys"
      - id: CHG-54
        description: "Added useCollectionTopics hook that queries general_topics by collection_id, ordered by title"
    acs_covered: [AC-F034-03]

  - step: STEP-05
    cr: CR-89
    plan_ref: plans/PLAN_P012.yaml
    plan_step: STEP-05
    hash: d2c9c0a
    message: "feat(topics): make CollectionRow tappable with chevron indicator (CR-89)"
    files_changed:
      - src/app/(tabs)/settings/topics.tsx
    changes:
      - id: CHG-55
        description: "Added isExpanded and onPress props to CollectionRowProps interface"
      - id: CHG-56
        description: "Wrapped chevron + name in Pressable with onPress handler"
      - id: CHG-57
        description: "Added chevron Text showing U+25B6 (collapsed) or U+25BC (expanded)"
      - id: CHG-58
        description: "Added collectionPressable and chevron styles"
    acs_covered: [AC-F034-06, AC-F034-08]

  - step: STEP-06
    cr: CR-89
    plan_ref: plans/PLAN_P012.yaml
    plan_step: STEP-06
    hash: 9e41fec
    message: "feat(topics): add expand/collapse collection topics view with accordion pattern (CR-89)"
    files_changed:
      - src/app/(tabs)/settings/topics.tsx
    changes:
      - id: CHG-59
        description: "Added ActivityIndicator import and useCollectionTopics import"
      - id: CHG-60
        description: "Added expandedCollectionId state (string | null)"
      - id: CHG-61
        description: "Added handleCollectionPress handler with toggle logic"
      - id: CHG-62
        description: "Created CollectionTopicsList inline component with loading, empty, and topics list states"
      - id: CHG-63
        description: "Updated collections map to use React.Fragment with CollectionRow + conditional CollectionTopicsList"
      - id: CHG-64
        description: "Added 7 new styles: collectionTopicsContainer, collectionTopicItem, collectionTopicTitle, collectionTopicLink, collectionTopicsLoading, collectionTopicsEmpty, collectionTopicsEmptyText"
    acs_covered: [AC-F034-01, AC-F034-02, AC-F034-03, AC-F034-04, AC-F034-05, AC-F034-07, AC-F034-08]

test_results:
  new_tests: 106
  new_tests_passing: 106
  full_suite_tests: 2716
  full_suite_passing: 2716
  full_suite_files: 56
  regressions: 0

  # --- Batch 7, Phase 1: CR-91, CR-92, CR-93, CR-95, CR-98 ---

  - step: STEP-01
    cr: CR-91
    plan_ref: plans/PLAN_P013.yaml
    plan_step: STEP-01
    hash: bdba1aa
    message: "fix(db): add SECURITY DEFINER to enqueue_speech_notification trigger (CR-91)"
    files_changed:
      - supabase/migrations/013_fix_notification_trigger_security_definer.sql
    changes:
      - id: CHG-65
        description: "Created migration 013 with CREATE OR REPLACE FUNCTION enqueue_speech_notification() SECURITY DEFINER"
    acs_covered: [AC-F035-01, AC-F035-02, AC-F035-03, AC-F035-04]
    ecs_covered: [EC-F035-01, EC-F035-02, EC-F035-03, EC-F035-04]

  - step: STEP-02
    cr: CR-92
    plan_ref: plans/PLAN_P013.yaml
    plan_step: STEP-02
    hash: e091833
    message: "fix(members): change keyExtractor to item.label to fix duplicate key warning (CR-92)"
    files_changed:
      - src/app/(tabs)/settings/members.tsx
    changes:
      - id: CHG-66
        description: "Changed FlatList keyExtractor from item.code to item.label in country code picker"
    acs_covered: [AC-F036-01, AC-F036-02, AC-F036-03, AC-F036-04, AC-F036-05]
    ecs_covered: [EC-F036-01]

  - step: STEP-03
    cr: CR-93
    plan_ref: plans/PLAN_P013.yaml
    plan_step: STEP-03
    hash: 313dc67
    message: "fix(deeplink): change protocol from wardmanager:// to sacrmeetman:// (CR-93)"
    files_changed:
      - app.json
      - supabase/functions/create-invitation/index.ts
    changes:
      - id: CHG-67
        description: "Changed expo.scheme from 'wardmanager' to 'sacrmeetman' in app.json"
      - id: CHG-68
        description: "Changed deep link from wardmanager://invite/ to sacrmeetman://invite/ in create-invitation Edge Function"
    acs_covered: [AC-F037-01, AC-F037-02, AC-F037-03, AC-F037-04]
    ecs_covered: [EC-F037-01, EC-F037-02]

  - step: STEP-04
    cr: CR-95
    plan_ref: plans/PLAN_P013.yaml
    plan_step: STEP-04
    hash: 1420ed2
    message: "fix(speeches): hide speech slots for all non-speeches types (CR-95)"
    files_changed:
      - src/app/(tabs)/speeches.tsx
      - src/__tests__/cr002-qa.test.ts
      - src/__tests__/cr001-qa-extended.test.ts
    changes:
      - id: CHG-69
        description: "Removed import of isExcludedFromAgenda from useAgenda in speeches.tsx"
      - id: CHG-70
        description: "Changed rendering condition from !(exception && isExcludedFromAgenda(exception.reason)) to (!exception || exception.reason === 'speeches')"
      - id: CHG-71
        description: "Updated cr002-qa.test.ts to assert speeches.tsx does NOT contain isExcludedFromAgenda and contains new pattern"
      - id: CHG-72
        description: "Updated cr001-qa-extended.test.ts to verify speeches.tsx uses direct type check instead of isExcludedFromAgenda"
    acs_covered: [AC-F038-01, AC-F038-02, AC-F038-03, AC-F038-04, AC-F038-05, AC-F038-06, AC-F038-07, AC-F038-08, AC-F038-09]
    ecs_covered: [EC-F038-01, EC-F038-02]

  - step: STEP-05
    cr: CR-98
    plan_ref: plans/PLAN_P013.yaml
    plan_step: STEP-05
    hash: 7a60ea8
    message: "fix(prayer): add visible/onClose props to PrayerSelector for immediate modal open (CR-98)"
    files_changed:
      - src/components/PrayerSelector.tsx
      - src/components/AgendaForm.tsx
    changes:
      - id: CHG-73
        description: "Added useEffect import to PrayerSelector.tsx"
      - id: CHG-74
        description: "Added visible?: boolean and onClose?: () => void props to PrayerSelectorProps interface"
      - id: CHG-75
        description: "Added useEffect to sync modalVisible with visible prop"
      - id: CHG-76
        description: "Added onClose?.() calls to all modal close handlers (cancel button, onRequestClose, handleSelectMember, handleCustomName)"
      - id: CHG-77
        description: "Added visible={true} and onClose={() => setSelectorModal(null)} to PrayerSelector in AgendaForm.tsx"
    acs_covered: [AC-F039-01, AC-F039-02, AC-F039-03, AC-F039-04, AC-F039-05, AC-F039-06, AC-F039-07]
    ecs_covered: [EC-F039-01, EC-F039-02, EC-F039-03]

batch7_phase1_test_results:
  full_suite_tests: 2716
  full_suite_passing: 2716
  full_suite_files: 56
  regressions: 0
