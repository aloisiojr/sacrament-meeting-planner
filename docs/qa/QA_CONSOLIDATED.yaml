# =============================================================================
# QA_CONSOLIDATED.yaml
# Consolidated QA results for CR-82, CR-80, CR-83, CR-84, CR-85, CR-86, CR-90,
# CR-87, CR-88, CR-89, CR-91, CR-92, CR-93, CR-95, CR-98,
# CR-94, CR-96, CR-97, CR-99, CR-100 (PRE),
# CR-101, CR-102, CR-103, CR-104, CR-108, CR-109 (PRE+POST),
# CR-105, CR-106, CR-107, CR-110, CR-111 (PRE+POST),
# CR-112, CR-113, CR-117, CR-122, CR-125 (PRE+POST),
# CR-114, CR-115, CR-116, CR-119, CR-121 (PRE+POST),
# CR-118, CR-120, CR-123 (PRE+POST)
# Updated: 2026-02-19
# =============================================================================

# #############################################################################
# CR-82: GestureDetector must be used as a descendant of GestureHandlerRootView
# #############################################################################

cr_82:
  cr_id: CR-82
  title: "GestureDetector must be used as a descendant of GestureHandlerRootView"
  type: bugfix
  spec: specs/SPEC_F001.yaml
  qa_plan: qa/QA_PLAN_001.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      QA Plan validated against SPEC. All validation_checks are testable,
      root cause analysis is confirmed, affected files identified. Plan covers
      must_pass (static + runtime) and should_pass (manual) checks.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 1"
    commits:
      - hash: ee9d84d
        message: "fix(layout): add GestureHandlerRootView wrapper to root layout (CR-82)"
      - hash: 37e880b
        message: "test(layout): add tests for GestureHandlerRootView wrapper (CR-82)"
      - hash: fd4dc8f
        message: "docs: commit SPEC, ARCH, PLAN, CODE_LEDGER, REVIEW for CR-82"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 9
    tester_tests_total: 9
    tester_suite_passed: 2456
    tester_suite_total: 2456

    must_pass_results:
      - id: MP-01
        description: "GestureHandlerRootView is imported from react-native-gesture-handler in root layout"
        status: PASSED
        evidence: |
          src/app/_layout.tsx:12 contains:
            import { GestureHandlerRootView } from 'react-native-gesture-handler';

      - id: MP-02
        description: "GestureHandlerRootView wraps the app tree (Slot or equivalent) in root layout"
        status: PASSED
        evidence: |
          src/app/_layout.tsx:108-116: GestureHandlerRootView wraps QueryClientProvider >
          I18nextProvider > ThemeProvider > InnerLayout (which contains AuthProvider >
          SyncProvider > NavigationGuard > Slot). Full app tree is a descendant.

      - id: MP-03
        description: "GestureHandlerRootView has style={{ flex: 1 }} to fill screen"
        status: PASSED
        evidence: |
          src/app/_layout.tsx:108:
            <GestureHandlerRootView style={{ flex: 1 }}>

      - id: MP-04
        description: "SwipeableCard component unchanged - no workaround in child component"
        status: PASSED
        evidence: |
          src/components/SwipeableCard.tsx is unmodified. GestureDetector is used at line 180.
          No local GestureHandlerRootView wrapper was added inside the component.
          The component imports only { Gesture, GestureDetector } from react-native-gesture-handler (line 20-22).

      - id: MP-05
        description: "No duplicate GestureHandlerRootView in nested layouts"
        status: PASSED
        evidence: |
          Grep for GestureHandlerRootView in src/ returns only 3 hits, all in src/app/_layout.tsx
          (import at line 12, opening tag at line 108, closing tag at line 116).
          Verified nested layouts:
          - src/app/(tabs)/_layout.tsx: No GestureHandlerRootView (uses Tabs from expo-router)
          - src/app/(tabs)/settings/_layout.tsx: No GestureHandlerRootView (uses Stack from expo-router)
          - src/app/(auth)/_layout.tsx: No GestureHandlerRootView (uses Stack from expo-router)

      - id: MP-06
        description: "Existing tests still pass after fix"
        status: PASSED
        evidence: |
          npx vitest run: 53 test files, 2456/2456 tests passed.
          Duration: 1.22s. Zero failures, zero skipped.
          Includes 9 new CR-82 specific tests (cr082-gesture-handler-root.test.ts) all passing.

    must_pass_total: 6
    must_pass_passed: 6
    must_pass_failed: 0

    should_pass_results:
      - id: SP-01
        description: "Members screen renders without gesture handler error"
        status: PASSED_BY_ANALYSIS
        evidence: |
          With GestureHandlerRootView at root layout (line 108), all screens rendered via Slot
          are descendants. Members screen (members.tsx:225) uses SwipeableCard > GestureDetector.
          The ancestor requirement is now satisfied. The error "GestureDetector must be used as
          a descendant of GestureHandlerRootView" will no longer be thrown.

      - id: SP-02
        description: "Topics screen renders without gesture handler error"
        status: PASSED_BY_ANALYSIS
        evidence: |
          Same reasoning as SP-01. Topics screen (topics.tsx:123) uses SwipeableCard > GestureDetector.
          GestureHandlerRootView is an ancestor via the root layout wrapper.

      - id: SP-03
        description: "Swipe gesture works on MemberRow"
        status: PASSED_BY_ANALYSIS
        evidence: |
          SwipeableCard.tsx:106-131 defines Gesture.Pan() with activeOffsetX threshold,
          onUpdate handler for translateX, and onEnd handler for snap open/close behavior.
          With gesture handler root view in place, these gestures will be recognized.

      - id: SP-04
        description: "Swipe gesture works on TopicRow"
        status: PASSED_BY_ANALYSIS
        evidence: |
          Same SwipeableCard component used by TopicRow (topics.tsx:123).
          Pan gesture behavior is identical to MemberRow.

    should_pass_total: 4
    should_pass_passed: 4
    should_pass_failed: 0

  spec_compliance:
    functional_requirements:
      - id: FR-82-01
        title: "Wrap app tree with GestureHandlerRootView"
        status: SATISFIED
        evidence: |
          AC-82-01-01: GestureHandlerRootView wraps entire provider tree at _layout.tsx:108-116.
          AC-82-01-02: Members screen SwipeableCard is descendant - no error thrown.
          AC-82-01-03: Topics screen SwipeableCard is descendant - no error thrown.
          AC-82-01-04: GestureHandlerRootView with flex:1 is transparent layout wrapper.

      - id: FR-82-02
        title: "SwipeableCard pan gesture functions correctly"
        status: SATISFIED
        evidence: |
          AC-82-02-01: SwipeableCard pan gesture uses Gesture.Pan() at line 106 with
          activeOffsetX threshold at line 108. GestureDetector wraps card at line 180.
          AC-82-02-02: Same component used by Topics screen at topics.tsx:123.
          AC-82-02-03: Single-reveal managed via activeId prop (lines 83, 86-90, 99-104).

    non_functional_requirements:
      - id: NFR-82-01
        title: "Single file change only"
        status: SATISFIED
        evidence: "Only src/app/_layout.tsx was modified for the fix. Test file added separately."

      - id: NFR-82-02
        title: "No changes to existing provider order"
        status: SATISFIED
        evidence: |
          Provider chain: ErrorBoundary > GestureHandlerRootView > QueryClientProvider >
          I18nextProvider > ThemeProvider > InnerLayout (AuthProvider > SyncProvider >
          NavigationGuard > Slot). Original order preserved, GestureHandlerRootView inserted.

      - id: NFR-82-03
        title: "No visual layout changes"
        status: SATISFIED
        evidence: "GestureHandlerRootView with style={{ flex: 1 }} fills parent. Transparent wrapper."

      - id: NFR-82-04
        title: "Web platform compatibility"
        status: SATISFIED
        evidence: "GestureHandlerRootView renders as regular View on web. No platform conditionals."

      - id: NFR-82-05
        title: "No changes to SwipeableCard component"
        status: SATISFIED
        evidence: "SwipeableCard.tsx unmodified. Fix is root-level only."

  verdict: passed
  verdict_rationale: |
    All 6 must_pass checks passed. All 4 should_pass checks passed (by code analysis).
    All functional requirements (FR-82-01, FR-82-02) satisfied.
    All non-functional requirements (NFR-82-01 through NFR-82-05) satisfied.
    Reviewer approved with 0 issues. Tester approved with 9/9 tests, 2456/2456 suite.
    Full test suite passes with zero regressions.

  issues_for_coder: []


# #############################################################################
# CR-80: Tela de Membros precisa de textos explicativos (i18n pt/en/es)
# #############################################################################

cr_80:
  cr_id: CR-80
  title: "Tela de Membros precisa de textos explicativos (i18n pt/en/es)"
  type: feature_request
  spec: specs/SPEC_F026.yaml
  qa_plan: qa/QA_PLAN_CR80.yaml

  # ===========================================================================
  # PRE VALIDATION (before coding)
  # ===========================================================================

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      QA Plan validated against SPEC_F026. All 7 must_pass and 6 should_pass
      checks are defined and testable. Current state analysis confirms no
      explanatory texts exist. i18n system supports pt-BR/en/es. Feature is
      feasible with no architectural changes needed.

  # ===========================================================================
  # POST VALIDATION (after coding + review)
  # ===========================================================================

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 1"
    commits:
      - hash: "9359348"
        message: "feat(i18n): add members.description and members.csvHelp keys in pt-BR/en/es (CR-80)"
      - hash: "84bea70"
        message: "feat(members): add description and csvHelp explanatory texts (CR-80)"
      - hash: "dbd5488"
        message: "test(members): add tests for F026 explanatory texts (CR-80)"
      - hash: "2d80bda"
        message: "docs(ledger): update CODE_LEDGER with CR-80 commits (CR-80)"
      - hash: "2250706"
        message: "docs(tests): update TEST_CONSOLIDATED (CR-80)"
      - hash: "a61ec8e"
        message: "docs(cr-80): add REVIEW for F026 (CR-80)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 46
    tester_tests_total: 46
    tester_suite_passed: 2502
    tester_suite_total: 2502

    # -------------------------------------------------------------------------
    # MUST_PASS checks
    # -------------------------------------------------------------------------

    must_pass_results:

      - id: MP-80-01
        description: "New i18n keys exist in en.json members section"
        status: PASSED
        evidence: |
          en.json members section (lines 166-167) contains:
            "description": "Add, edit and remove ward members. Swipe a member to edit or delete."
            "csvHelp": "Export saves all members as a CSV file. Import loads a CSV file and replaces the entire member list. Expected format: Name, Full Phone (with country code, e.g. +5511999999999)."
          Both keys are explanatory texts matching SPEC_F026 i18n_keys.

      - id: MP-80-02
        description: "New i18n keys exist in pt-BR.json members section with Portuguese translations"
        status: PASSED
        evidence: |
          pt-BR.json members section (lines 166-167) contains:
            "description": "Adicione, edite e remova membros da ala. Deslize um membro para editar ou excluir."
            "csvHelp": "Exportar salva todos os membros em um arquivo CSV. Importar carrega um arquivo CSV e substitui toda a lista de membros. Formato esperado: Nome, Telefone Completo (com codigo do pais, ex: +5511999999999)."
          Same keys as en.json with proper Portuguese (Brazilian) translations.

      - id: MP-80-03
        description: "New i18n keys exist in es.json members section with Spanish translations"
        status: PASSED
        evidence: |
          es.json members section (lines 166-167) contains:
            "description": "Agregue, edite y elimine miembros del barrio. Deslice un miembro para editar o eliminar."
            "csvHelp": "Exportar guarda todos los miembros en un archivo CSV. Importar carga un archivo CSV y reemplaza toda la lista de miembros. Formato esperado: Nombre, Telefono Completo (con codigo de pais, ej: +5211234567890)."
          Same keys as en.json with proper Spanish translations.

      - id: MP-80-04
        description: "All three locale files have identical key structure in members section"
        status: PASSED
        evidence: |
          All 3 locale files have exactly 23 identical keys in the "members" section:
          title, addMember, fullName, phone, countryCode, importCsv, exportCsv,
          exportFailed, importFailed, importEmpty, importErrorLine, importSuccess,
          deleteConfirm, csvHeaderName, csvHeaderPhone, csvErrorEmptyFile,
          csvErrorInvalidHeader, csvErrorInsufficientColumns, csvErrorNameRequired,
          csvErrorNoData, importReadError, description, csvHelp.
          PARITY CHECK: PASS (verified via script).

      - id: MP-80-05
        description: "Members screen uses t() for new explanatory texts"
        status: PASSED
        evidence: |
          members.tsx:548 uses t('members.description') inside a <Text> element.
          members.tsx:595 uses t('members.csvHelp') inside a <Text> element.
          No hardcoded strings for explanatory texts. Both use the i18n t() function.

      - id: MP-80-06
        description: "No i18n keys removed or renamed (backward compatibility)"
        status: PASSED
        evidence: |
          All 21 pre-existing keys in the "members" section are preserved across all 3 locales.
          Verified by script: Missing existing keys in EN: NONE, PT: NONE, ES: NONE.
          Only 2 new keys added: "description" and "csvHelp". Zero removals or renames.

      - id: MP-80-07
        description: "Existing test suite passes without regressions"
        status: PASSED
        evidence: |
          npx vitest run: 54 test files, 2502/2502 tests passed.
          Duration: 1.29s. Zero failures, zero skipped.
          Includes 46 new CR-80 specific tests (cr080-f026-members-explanatory-texts.test.ts)
          all passing.

    must_pass_total: 7
    must_pass_passed: 7
    must_pass_failed: 0

    # -------------------------------------------------------------------------
    # SHOULD_PASS checks (manual - validated via code analysis)
    # -------------------------------------------------------------------------

    should_pass_results:

      - id: SP-80-01
        description: "Explanatory texts are visible on the Members screen"
        status: PASSED_BY_ANALYSIS
        evidence: |
          members.tsx:547-549: Description text rendered as:
            <Text style={[styles.description, { color: colors.textSecondary }]}>
              {t('members.description')}
            </Text>
          Placed between the header (line 525-544) and search container (line 551-562).
          Always visible, not inside any conditional.

          members.tsx:594-596: CSV help text rendered as:
            <Text style={[styles.csvHelp, { color: colors.textSecondary }]}>
              {t('members.csvHelp')}
            </Text>
          Placed after CSV buttons (line 567-593), inside the canImport conditional block.
          Both use colors.textSecondary for styling consistency.

      - id: SP-80-02
        description: "Texts are properly translated when language is changed to Portuguese"
        status: PASSED_BY_ANALYSIS
        evidence: |
          pt-BR.json contains members.description and members.csvHelp with proper
          Portuguese translations. The i18n system (i18next) handles language switching.
          Test AC-4 verifies exact text content matches SPEC.

      - id: SP-80-03
        description: "Texts are properly translated when language is changed to Spanish"
        status: PASSED_BY_ANALYSIS
        evidence: |
          es.json contains members.description and members.csvHelp with proper
          Spanish translations. The i18n system (i18next) handles language switching.
          Test AC-6 verifies exact text content matches SPEC.

      - id: SP-80-04
        description: "Texts are properly translated when language is changed to English"
        status: PASSED_BY_ANALYSIS
        evidence: |
          en.json contains members.description and members.csvHelp with proper
          English texts. The i18n system (i18next) handles language switching.
          Test AC-5 verifies exact text content matches SPEC.

      - id: SP-80-05
        description: "Explanatory texts do not break layout on small screens"
        status: PASSED_BY_ANALYSIS
        evidence: |
          styles.description: fontSize 13, textAlign 'center', paddingHorizontal 16,
          marginBottom 8. No numberOfLines or fixed width constraints -- allows text wrapping.
          styles.csvHelp: fontSize 12, paddingHorizontal 16, marginBottom 8.
          No numberOfLines or fixed width constraints. Both texts use small font sizes
          (12-13px) appropriate for secondary/helper text on mobile screens.
          Tests EC-2 verify fontSize ranges (12-14 for description, 11-13 for csvHelp).

      - id: SP-80-06
        description: "Empty state message is specific and helpful when no members exist"
        status: PASSED_BY_ANALYSIS
        evidence: |
          The existing ListEmptyComponent still renders t('common.noResults') when the list
          is empty (members.tsx:614-622). The description text (members.description) is
          always visible above the list regardless of member count, providing context even
          when the list is empty. The csvHelp text is also visible above the list when
          canImport is true. This satisfies EC-3 (texts visible regardless of list state).

    should_pass_total: 6
    should_pass_passed: 6
    should_pass_failed: 0

  # ===========================================================================
  # SPEC COMPLIANCE
  # ===========================================================================

  spec_compliance:

    acceptance_criteria:
      - id: AC-1
        title: "Description text visible below the title"
        status: SATISFIED
        evidence: |
          members.tsx:547-549 renders t('members.description') in a Text element
          with styles.description (fontSize 13, textAlign center, paddingHorizontal 16)
          and color colors.textSecondary. Placed between header and search container.

      - id: AC-2
        title: "CSV help text visible when canImport is true"
        status: SATISFIED
        evidence: |
          members.tsx:594-596 renders t('members.csvHelp') in a Text element with
          styles.csvHelp (fontSize 12, paddingHorizontal 16) and color colors.textSecondary.
          Located inside the {canImport && (...)} conditional block, after CSV buttons.

      - id: AC-3
        title: "CSV help text hidden when canImport is false"
        status: SATISFIED
        evidence: |
          The csvHelp Text element is inside the {canImport && (...)} block (lines 565-598).
          When canImport is false, the entire block including CSV buttons and csvHelp text
          is not rendered. Only one occurrence of t('members.csvHelp') exists in the file.

      - id: AC-4
        title: "pt-BR translations correct"
        status: SATISFIED
        evidence: |
          pt-BR.json members.description = "Adicione, edite e remova membros da ala. Deslize um membro para editar ou excluir."
          pt-BR.json members.csvHelp = "Exportar salva todos os membros em um arquivo CSV. Importar carrega um arquivo CSV e substitui toda a lista de membros. Formato esperado: Nome, Telefone Completo (com codigo do pais, ex: +5511999999999)."
          Both match SPEC_F026 i18n_keys exactly.

      - id: AC-5
        title: "en translations correct"
        status: SATISFIED
        evidence: |
          en.json members.description = "Add, edit and remove ward members. Swipe a member to edit or delete."
          en.json members.csvHelp = "Export saves all members as a CSV file. Import loads a CSV file and replaces the entire member list. Expected format: Name, Full Phone (with country code, e.g. +5511999999999)."
          Both match SPEC_F026 i18n_keys exactly.

      - id: AC-6
        title: "es translations correct"
        status: SATISFIED
        evidence: |
          es.json members.description = "Agregue, edite y elimine miembros del barrio. Deslice un miembro para editar o eliminar."
          es.json members.csvHelp = "Exportar guarda todos los miembros en un archivo CSV. Importar carga un archivo CSV y reemplaza toda la lista de miembros. Formato esperado: Nombre, Telefono Completo (con codigo de pais, ej: +5211234567890)."
          Both match SPEC_F026 i18n_keys exactly.

      - id: AC-7
        title: "No regressions in existing functionality"
        status: SATISFIED
        evidence: |
          Full test suite: 54 test files, 2502/2502 tests passed, zero failures.
          CR-80 tests verify existing functionality preservation: SwipeableCard import,
          SwipeableCard rendering, CSV import/export handlers, search, add member, delete
          member, MemberEditor component all confirmed present and unchanged.

  # ===========================================================================
  # OVERALL VERDICT
  # ===========================================================================

  verdict: passed
  verdict_rationale: |
    All 7 must_pass checks passed. All 6 should_pass checks passed (by code analysis).
    All 7 acceptance criteria (AC-1 through AC-7) from SPEC_F026 satisfied.
    Reviewer approved with 0 issues (P0/P1/P2).
    Tester approved with 46/46 CR-80 tests passing, 2502/2502 full suite passing.
    i18n key parity verified across all 3 locales (en, pt-BR, es): 23 identical keys.
    All 21 pre-existing keys preserved. 2 new keys (description, csvHelp) added correctly.
    No regressions detected.

  issues_for_coder: []


# #############################################################################
# CR-90: [BUG] Delete button for members and ward topics does nothing
# #############################################################################

cr_90:
  cr_id: CR-90
  title: "[BUG] Botao de excluir para membros e temas da ala nao faz nada"
  type: bugfix
  spec: specs/SPEC_F027_F031.yaml
  qa_plan: qa/QA_PLAN_batch6_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Bug confirmed via code analysis. Delete button in SwipeableCard does not fire
      for members or topics. Edit button works with identical pattern. Root cause
      identified as touch event interception by GestureDetector's Animated.View (zIndex: 1).
      Reproduction steps documented.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 1"
    commits:
      - hash: 298258c
        message: "fix(swipeable): add pointerEvents box-none to fix Delete button touch (CR-90)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_suite_passed: 2610
    tester_suite_total: 2610

    must_pass_results:
      - id: MP-90-01
        description: "Delete button in SwipeableCard fires onDelete callback when tapped"
        status: PASSED
        evidence: |
          SwipeableCard.tsx:183 now has pointerEvents="box-none" on the Animated.View.
          This allows touch events to pass through the Animated.View to the action buttons
          behind it. The handleDelete callback (line 143-147) calls onDelete?.() correctly.
          The fix ensures touch events reach the Pressable buttons in the actionsContainer.

      - id: MP-90-02
        description: "Members screen: delete button shows confirmation dialog"
        status: PASSED
        evidence: |
          members.tsx:317-346: handleDelete calls Alert.alert with t('common.confirm') and
          t('members.deleteConfirm'). The onDelete prop passes handleDelete via
          MemberRow (line 219) > SwipeableCard (line 219). With pointerEvents="box-none",
          the Pressable now receives touch events correctly.

      - id: MP-90-03
        description: "Topics screen: delete button shows confirmation dialog"
        status: PASSED
        evidence: |
          topics.tsx:268-280: handleDelete calls Alert.alert with t('common.confirm') and
          t('members.deleteConfirm'). TopicRow (line 153) passes onDelete to SwipeableCard.
          Same fix applies - pointerEvents="box-none" allows touch through.

      - id: MP-90-04
        description: "Edit button continues to work after fix"
        status: PASSED
        evidence: |
          SwipeableCard.tsx:156: Edit Pressable with onPress={handleEdit} is in the same
          actionsContainer as delete. handleEdit (line 137-141) calls onEdit?.().
          pointerEvents="box-none" does not affect edit button since it was already receiving
          touches (positioned closer to the translated card edge). Both buttons now work.

      - id: MP-90-05
        description: "SwipeableCard swipe gesture still works correctly"
        status: PASSED
        evidence: |
          GestureDetector (line 180) wraps the Animated.View. pointerEvents="box-none"
          on the Animated.View means the view itself doesn't block events, but its children
          (the inner View with backgroundColor) still receive touches normally. The
          panGesture (line 106-131) still responds to horizontal swipe on the card content.

      - id: MP-90-06
        description: "Only one card can be revealed at a time"
        status: PASSED
        evidence: |
          activeId/onReveal mechanism unchanged (lines 83, 86-90, 99-104). When a card
          is revealed, it sets activeId to its id. Other cards close via useEffect (line 86-90).
          This management is in the parent component, unaffected by the pointerEvents fix.

      - id: MP-90-07
        description: "Existing test suite passes without regressions"
        status: PASSED
        evidence: |
          npx vitest run: 55 test files, 2610/2610 tests passed.
          Duration: 1.29s. Zero failures, zero skipped.

    must_pass_total: 7
    must_pass_passed: 7
    must_pass_failed: 0

    should_pass_results:
      - id: SP-90-01
        description: "Confirming delete in dialog actually deletes the member"
        status: PASSED_BY_ANALYSIS
        evidence: |
          members.tsx:331: Alert destructive button calls deleteMember.mutate({ memberId, memberName }).
          useDeleteMember hook handles the Supabase delete operation.

      - id: SP-90-02
        description: "Confirming delete in dialog actually deletes the topic"
        status: PASSED_BY_ANALYSIS
        evidence: |
          topics.tsx:275: Alert destructive button calls deleteTopic.mutate({ topicId, topicTitle }).
          useDeleteWardTopic hook handles the Supabase delete operation.

      - id: SP-90-03
        description: "Delete button visual appearance unchanged"
        status: PASSED_BY_ANALYSIS
        evidence: |
          SwipeableCard.tsx:167: deleteButton style unchanged (backgroundColor: colors.error).
          Text color remains '#FFFFFF' (line 172). Only change is pointerEvents on parent Animated.View.

    should_pass_total: 3
    should_pass_passed: 3
    should_pass_failed: 0

  verdict: passed
  verdict_rationale: |
    All 7 must_pass checks passed. All 3 should_pass checks passed (by analysis).
    Root cause was the Animated.View with zIndex:1 intercepting touch events on action buttons.
    Fix: pointerEvents="box-none" on Animated.View allows touches to pass through to
    action buttons while maintaining gesture detection on child content.
    Single-line fix in SwipeableCard.tsx. No regressions. 2610/2610 tests passing.

  issues_for_coder: []


# #############################################################################
# CR-83: Save/Cancel buttons for members and ward topics
# #############################################################################

cr_83:
  cr_id: CR-83
  title: "Membros e temas da ala: salvar somente ao clicar Salvar, adicionar botao Cancelar"
  type: feature_request
  spec: specs/SPEC_F027_F031.yaml
  qa_plan: qa/QA_PLAN_batch6_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Current state confirmed: MemberEditor and TopicEditor save onBlur with no
      explicit Save/Cancel buttons. i18n keys common.save and common.cancel already exist.
      Feature is feasible with no architectural changes.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 1"
    commits:
      - hash: 89b5dc9
        message: "feat(members): replace onBlur auto-save with Save/Cancel buttons (CR-83)"
      - hash: 1970e71
        message: "feat(topics): replace onBlur auto-save with Save/Cancel buttons (CR-83)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_suite_passed: 2610
    tester_suite_total: 2610

    must_pass_results:
      - id: MP-83-01
        description: "MemberEditor does NOT save onBlur for name field"
        status: PASSED
        evidence: |
          members.tsx:77-88: Name TextInput has NO onBlur handler. Only onChangeText={setFullName}.
          The old onBlur={handleSave} has been removed.

      - id: MP-83-02
        description: "MemberEditor does NOT save onBlur for phone field"
        status: PASSED
        evidence: |
          members.tsx:98-107: Phone TextInput has NO onBlur handler. Only onChangeText={setPhone}.
          The old onBlur={handleSave} has been removed.

      - id: MP-83-03
        description: "TopicEditor does NOT save onBlur for title field"
        status: PASSED
        evidence: |
          topics.tsx:66-75: Title TextInput has NO onBlur handler. Only onChangeText={setTitle}.
          The old onBlur={handleSave} has been removed.

      - id: MP-83-04
        description: "TopicEditor does NOT save onBlur for link field"
        status: PASSED
        evidence: |
          topics.tsx:76-86: Link TextInput has NO onBlur handler. Only onChangeText={setLink}.
          The old onBlur={handleSave} has been removed.

      - id: MP-83-05
        description: "MemberEditor renders a Save button"
        status: PASSED
        evidence: |
          members.tsx:121-129: Pressable with onPress={handleSave} renders
          t('common.save') text. Style: saveButton with backgroundColor: colors.primary.

      - id: MP-83-06
        description: "MemberEditor renders a Cancel button"
        status: PASSED
        evidence: |
          members.tsx:112-120: Pressable with onPress={onCancel} renders
          t('common.cancel') text. Style: cancelButton with color: colors.textSecondary.

      - id: MP-83-07
        description: "TopicEditor renders a Save button"
        status: PASSED
        evidence: |
          topics.tsx:99-107: Pressable with onPress={handleSave} renders
          t('common.save') text. Style: saveButton with backgroundColor: colors.primary.

      - id: MP-83-08
        description: "TopicEditor renders a Cancel button"
        status: PASSED
        evidence: |
          topics.tsx:90-98: Pressable with onPress={onCancel} renders
          t('common.cancel') text. Style: cancelButton with color: colors.textSecondary.

      - id: MP-83-09
        description: "MemberEditor Save button calls onSave with data"
        status: PASSED
        evidence: |
          members.tsx:69-73: handleSave trims fullName, validates non-empty, and calls
          onSave({ full_name, country_code, phone }). Save button (line 123) calls handleSave.

      - id: MP-83-10
        description: "MemberEditor Cancel button calls onCancel"
        status: PASSED
        evidence: |
          members.tsx:114: Cancel button onPress={onCancel}. onCancel is a required prop
          in MemberEditorProps (line 50).

      - id: MP-83-11
        description: "TopicEditor Save button calls onSave with data"
        status: PASSED
        evidence: |
          topics.tsx:58-62: handleSave trims title, validates non-empty, and calls
          onSave({ title, link }). Save button (line 101) calls handleSave.

      - id: MP-83-12
        description: "TopicEditor Cancel button calls onCancel"
        status: PASSED
        evidence: |
          topics.tsx:92: Cancel button onPress={onCancel}. onCancel is a required prop
          in TopicEditorProps (line 42).

      - id: MP-83-13
        description: "TopicEditor accepts onCancel prop"
        status: PASSED
        evidence: |
          topics.tsx:42: TopicEditorProps interface includes "onCancel: () => void".
          TopicEditor destructures it at line 46: { topic, onSave, onCancel, colors }.

      - id: MP-83-14
        description: "Existing test suite passes without regressions"
        status: PASSED
        evidence: |
          npx vitest run: 55 test files, 2610/2610 tests passed.
          Zero failures, zero skipped.

    must_pass_total: 14
    must_pass_passed: 14
    must_pass_failed: 0

    should_pass_results:
      - id: SP-83-01
        description: "Save and Cancel buttons are positioned appropriately in MemberEditor"
        status: PASSED_BY_ANALYSIS
        evidence: |
          members.tsx:111: editorButtons View with flexDirection:'row', justifyContent:'flex-end',
          gap:8, marginTop:8. Cancel button first, Save button second (right-aligned).

      - id: SP-83-02
        description: "Save and Cancel buttons are positioned appropriately in TopicEditor"
        status: PASSED_BY_ANALYSIS
        evidence: |
          topics.tsx:89: editorButtons View with flexDirection:'row', justifyContent:'flex-end',
          gap:8, marginTop:8. Cancel button first, Save button second (right-aligned).
          Identical layout pattern as MemberEditor.

      - id: SP-83-03
        description: "New member: Cancel discards addition without creating member"
        status: PASSED_BY_ANALYSIS
        evidence: |
          members.tsx:601: onCancel={() => setIsAdding(false)}. MemberEditor Cancel button
          calls this, which hides the editor without calling createMember.mutate.

      - id: SP-83-04
        description: "Edit member: Cancel reverts to display mode without saving changes"
        status: PASSED_BY_ANALYSIS
        evidence: |
          members.tsx:511: onCancel={() => setEditingId(null)}. MemberEditor Cancel button
          calls this, which exits edit mode without calling updateMember.mutate.

      - id: SP-83-05
        description: "New topic: Cancel discards addition without creating topic"
        status: PASSED_BY_ANALYSIS
        evidence: |
          topics.tsx:339: onCancel={() => setIsAdding(false)}. TopicEditor Cancel button
          calls this, which hides the editor without calling createTopic.mutate.

      - id: SP-83-06
        description: "Edit topic: Cancel reverts to display mode without saving changes"
        status: PASSED_BY_ANALYSIS
        evidence: |
          topics.tsx:353: onCancel={() => setEditingId(null)}. TopicEditor Cancel button
          calls this, which exits edit mode without calling updateTopic.mutate.

    should_pass_total: 6
    should_pass_passed: 6
    should_pass_failed: 0

  verdict: passed
  verdict_rationale: |
    All 14 must_pass checks passed. All 6 should_pass checks passed (by analysis).
    onBlur auto-save removed from all 4 TextInputs (name, phone in MemberEditor;
    title, link in TopicEditor). Save and Cancel buttons added to both editors.
    TopicEditor now accepts onCancel prop. Both editors use consistent button layout
    (flex-end, Save on right). No regressions. 2610/2610 tests passing.

  issues_for_coder: []


# #############################################################################
# CR-84: Clear (X) button for all search fields
# #############################################################################

cr_84:
  cr_id: CR-84
  title: "Adicionar botao X para limpar campo de search em todos os campos de busca do app"
  type: feature_request
  spec: specs/SPEC_F027_F031.yaml
  qa_plan: qa/QA_PLAN_batch6_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      10 search fields identified across the app. None had a clear (X) button.
      Standard UX pattern, feasible with reusable component or inline implementation.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 1"
    commits:
      - hash: 8f2b42a
        message: "feat(components): create SearchInput component with clear X button (CR-84)"
      - hash: 27daf39
        message: "feat(settings): migrate search fields to SearchInput in 4 settings screens (CR-84)"
      - hash: ede8904
        message: "feat(components): migrate search fields to SearchInput in 6 modal/selector components (CR-84)"
      - hash: ac4b489
        message: "fix(tests): update CR-39 tests for SearchInput migration"
      - hash: 3b780d4
        message: "fix(tests): update CR-80 test for SearchInput migration"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_suite_passed: 2610
    tester_suite_total: 2610

    must_pass_results:
      - id: MP-84-01
        description: "Members screen search has clear (X) button when text present"
        status: PASSED
        evidence: |
          members.tsx:554-558: Uses <SearchInput value={search} onChangeText={setSearch} />.
          SearchInput.tsx:44-55: Renders clear button when value.length > 0.

      - id: MP-84-02
        description: "Topics screen search has clear (X) button when text present"
        status: PASSED
        evidence: |
          topics.tsx:331-335: Uses <SearchInput value={search} onChangeText={setSearch} />.

      - id: MP-84-03
        description: "History screen search has clear (X) button when text present"
        status: PASSED
        evidence: |
          history.tsx:107: Uses <SearchInput value={...} onChangeText={updateSearch} />.
          Import at line 14: import { SearchInput } from '../../../components/SearchInput'.

      - id: MP-84-04
        description: "Timezone screen search has clear (X) button when text present"
        status: PASSED
        evidence: |
          timezone.tsx:207: Uses <SearchInput value={search} onChangeText={setSearch} />.
          Import at line 16: import { SearchInput } from '../../../components/SearchInput'.

      - id: MP-84-05
        description: "HymnSelector search has clear (X) button when text present"
        status: PASSED
        evidence: |
          HymnSelector.tsx:103: Uses <SearchInput value={search} onChangeText={setSearch} />.
          Import at line 17: import { SearchInput } from './SearchInput'.

      - id: MP-84-06
        description: "MemberSelectorModal search has clear (X) button when text present"
        status: PASSED
        evidence: |
          MemberSelectorModal.tsx:63: Uses <SearchInput value={search} onChangeText={setSearch} />.
          Import at line 17: import { SearchInput } from './SearchInput'.

      - id: MP-84-07
        description: "TopicSelectorModal search has clear (X) button when text present"
        status: PASSED
        evidence: |
          TopicSelectorModal.tsx:80: Uses <SearchInput value={search} onChangeText={setSearch} />.
          Import at line 17: import { SearchInput } from './SearchInput'.

      - id: MP-84-08
        description: "PrayerSelector search has clear (X) button when text present"
        status: PASSED
        evidence: |
          PrayerSelector.tsx:114: Uses <SearchInput value={search} onChangeText={setSearch} />.
          Import at line 18: import { SearchInput } from './SearchInput'.

      - id: MP-84-09
        description: "ActorSelector search has clear (X) button when text present"
        status: PASSED
        evidence: |
          ActorSelector.tsx:199: Uses <SearchInput value={search} onChangeText={setSearch} />.
          Import at line 21: import { SearchInput } from './SearchInput'.

      - id: MP-84-10
        description: "AgendaForm search has clear (X) button when text present"
        status: PASSED
        evidence: |
          AgendaForm.tsx:702: Uses <SearchInput value={search} onChangeText={setSearch} />.
          Import at line 32: import { SearchInput } from './SearchInput'.

      - id: MP-84-11
        description: "Clear button clears search text (sets to empty string)"
        status: PASSED
        evidence: |
          SearchInput.tsx:47: onPress={() => onChangeText('')}. Calls the parent's
          onChangeText with empty string, which sets the search state to ''.

      - id: MP-84-12
        description: "Clear button is NOT visible when search field is empty"
        status: PASSED
        evidence: |
          SearchInput.tsx:44: {value.length > 0 && (<Pressable ... />)}.
          Conditional rendering: button only appears when value has text.

      - id: MP-84-13
        description: "Existing test suite passes without regressions"
        status: PASSED
        evidence: |
          npx vitest run: 55 test files, 2610/2610 tests passed.
          Zero failures, zero skipped. Includes regression fixes for CR-39 and CR-80 tests
          that were updated for SearchInput migration.

    must_pass_total: 13
    must_pass_passed: 13
    must_pass_failed: 0

    should_pass_results:
      - id: SP-84-01
        description: "X button is positioned at right side of search input"
        status: PASSED_BY_ANALYSIS
        evidence: |
          SearchInput.tsx:75-76: clearButton style has position:'absolute', right:8.
          Positioned at the right side of the input container.

      - id: SP-84-02
        description: "X button has appropriate size for touch target (>= 24px)"
        status: PASSED_BY_ANALYSIS
        evidence: |
          SearchInput.tsx:79-80: clearButton has width:24, height:24. Plus hitSlop={8}
          on the Pressable (line 48), giving an effective touch area of 40x40px.

      - id: SP-84-03
        description: "All 10 search fields use consistent X button styling"
        status: PASSED_BY_ANALYSIS
        evidence: |
          All 10 search fields use the same SearchInput component. Styling is centralized
          in SearchInput.tsx styles. Uses Unicode multiply sign (U+00D7) for the X character
          with colors.textSecondary color. Consistent across all instances.

    should_pass_total: 3
    should_pass_passed: 3
    should_pass_failed: 0

  verdict: passed
  verdict_rationale: |
    All 13 must_pass checks passed. All 3 should_pass checks passed (by analysis).
    Created reusable SearchInput component (DRY approach). All 10 search fields migrated.
    X button shows conditionally (value.length > 0), clears text on press, positioned
    at right side with 24x24 size + 8px hitSlop. Consistent styling across all instances.
    Regression fixes applied for existing CR-39 and CR-80 tests. 2610/2610 tests passing.

  issues_for_coder: []


# #############################################################################
# CR-85: Complete international country codes list
# #############################################################################

cr_85:
  cr_id: CR-85
  title: "Lista de codigos internacionais de telefone incompleta, faltam muitos paises"
  type: bugfix
  spec: specs/SPEC_F027_F031.yaml
  qa_plan: qa/QA_PLAN_batch6_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      COUNTRY_CODES array had only 21 entries. csvUtils.ts splitPhoneNumber hardcoded
      same 21 codes. User wants a more complete list of all countries.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 1"
    commits:
      - hash: 8d0f6c4
        message: "feat(lib): create countryCodes.ts with ~200 country codes (CR-85)"
      - hash: 59eaba7
        message: "refactor(members,csv): use shared countryCodes.ts (CR-85)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_suite_passed: 2610
    tester_suite_total: 2610

    must_pass_results:
      - id: MP-85-01
        description: "COUNTRY_CODES list has significantly more entries (>= 100 countries)"
        status: PASSED
        evidence: |
          src/lib/countryCodes.ts: 172 entries in COUNTRY_CODES array (lines 16-191).
          Far exceeds the minimum threshold of 100. Previously had 21.

      - id: MP-85-02
        description: "All major LDS-presence countries are included"
        status: PASSED
        evidence: |
          Verified all 44 key countries present: Brazil, United States, Mexico, Argentina,
          Chile, Colombia, Peru, Philippines, Guatemala, Honduras, Ecuador, Bolivia, Paraguay,
          Uruguay, Portugal, Angola, Mozambique, Cape Verde, United Kingdom, Spain, France,
          Germany, Italy, Japan, South Korea, Australia, New Zealand, Canada, India, Nigeria,
          Ghana, South Africa, Kenya, El Salvador, Costa Rica, Panama, Haiti, Cuba, Taiwan,
          Hong Kong, Singapore, Thailand, Fiji, Tonga. Zero missing.

      - id: MP-85-03
        description: "splitPhoneNumber in csvUtils.ts recognizes all new country codes"
        status: PASSED
        evidence: |
          csvUtils.ts:6-7: Now re-exports splitPhoneNumber from './countryCodes'.
          countryCodes.ts:204-216: CODE_SETS_BY_LENGTH is dynamically built from COUNTRY_CODES
          array, grouping by digit length. splitPhoneNumber (line 222-244) iterates longest
          codes first for correct matching. No hardcoded regex patterns - fully data-driven
          from the COUNTRY_CODES array. Any new entry in COUNTRY_CODES is automatically
          recognized by splitPhoneNumber.

      - id: MP-85-04
        description: "Each country entry has code, flag emoji, and label"
        status: PASSED
        evidence: |
          countryCodes.ts:6-10: CountryCode interface requires { code: string; flag: string; label: string }.
          All 172 entries follow this format. Example (line 18):
            { code: '+55', flag: '\u{1F1E7}\u{1F1F7}', label: 'Brazil (+55)' }
          Labels include country name and dial code in parentheses.

      - id: MP-85-05
        description: "No duplicate country codes in the list"
        status: PASSED
        evidence: |
          170 unique codes out of 172 entries. Only duplicates are:
          - +1: Canada and United States (valid - shared NANP code)
          - +7: Kazakhstan and Russia (valid - shared code)
          These are legitimate shared international dial codes.

      - id: MP-85-06
        description: "Existing test suite passes without regressions"
        status: PASSED
        evidence: |
          npx vitest run: 55 test files, 2610/2610 tests passed.
          Zero failures, zero skipped.

    must_pass_total: 6
    must_pass_passed: 6
    must_pass_failed: 0

    should_pass_results:
      - id: SP-85-01
        description: "Countries are sorted in a logical order"
        status: PASSED_BY_ANALYSIS
        evidence: |
          countryCodes.ts: Brazil listed first as default (line 17-18), then alphabetical
          by English country name from Afghanistan (line 20) to Zimbabwe (line 190).
          Comment at line 3 documents this: "Brazil (+55) listed first, then alphabetical
          by country name."

      - id: SP-85-02
        description: "Country code picker modal is usable with large list"
        status: PASSED_BY_ANALYSIS
        evidence: |
          members.tsx:144-164: FlatList renders COUNTRY_CODES in a scrollable modal
          with maxHeight:400 (line 792). FlatList is virtualized, so 172 items won't
          cause performance issues. Note: no search in picker, but scrolling works.

      - id: SP-85-03
        description: "Flag emojis are correct Unicode regional indicator symbols"
        status: PASSED_BY_ANALYSIS
        evidence: |
          All flags use Unicode Regional Indicator Symbol pairs (U+1F1E6 through U+1F1FF).
          Example: Brazil = '\u{1F1E7}\u{1F1F7}' = BR regional indicators.
          getFlagForCode (line 196-198) returns matching flag or globe fallback.

    should_pass_total: 3
    should_pass_passed: 3
    should_pass_failed: 0

  verdict: passed
  verdict_rationale: |
    All 6 must_pass checks passed. All 3 should_pass checks passed (by analysis).
    Expanded from 21 to 172 country codes. Extracted to shared countryCodes.ts module (DRY).
    splitPhoneNumber now data-driven from COUNTRY_CODES (no hardcoded regex patterns).
    csvUtils.ts re-exports from countryCodes.ts. All 44 key LDS-presence countries present.
    Only valid duplicates (+1 US/CA, +7 RU/KZ). Alphabetical ordering with Brazil first.
    2610/2610 tests passing.

  issues_for_coder: []


# #############################################################################
# CR-86: Confirmation dialog before Import CSV
# #############################################################################

cr_86:
  cr_id: CR-86
  title: "Dialogo de confirmacao antes de Importar CSV"
  type: feature_request
  spec: specs/SPEC_F027_F031.yaml
  qa_plan: qa/QA_PLAN_batch6_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      handleImport went directly to file picker without confirmation. Alert.alert pattern
      already used in codebase. New i18n keys needed for confirmation text.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 1"
    commits:
      - hash: 5d65fb1
        message: "feat(i18n): add CSV import confirmation keys (CR-86)"
      - hash: 5837628
        message: "feat(members): add confirmation dialog before CSV import (CR-86)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_suite_passed: 2610
    tester_suite_total: 2610

    must_pass_results:
      - id: MP-86-01
        description: "Import button triggers confirmation dialog before file picker"
        status: PASSED
        evidence: |
          members.tsx:488-497: handleImport calls Alert.alert with importConfirmTitle
          and importConfirmMessage. Only the confirm callback calls performImport().
          The file picker (performImport, lines 445-485) is NOT called directly anymore.

      - id: MP-86-02
        description: "Confirmation dialog warns that import replaces entire member list"
        status: PASSED
        evidence: |
          en.json:169: "importConfirmMessage": "Importing a CSV file will replace the entire
          current member list with the contents of the file. ..."
          The word "replace" and "entire" clearly warn about the destructive nature.

      - id: MP-86-03
        description: "Confirmation dialog states that assignments are not affected"
        status: PASSED
        evidence: |
          en.json:169: "...Existing speech assignments (past and present) will not be affected.
          Do you want to continue?"
          Explicitly mentions past and present assignments are unaffected.

      - id: MP-86-04
        description: "File picker only opens after user confirms"
        status: PASSED
        evidence: |
          members.tsx:494: onPress: () => performImport(). The performImport function
          (which opens DocumentPicker or web file input) is only called inside the
          confirm button's onPress callback, after the user explicitly confirms.

      - id: MP-86-05
        description: "Cancel in confirmation dialog does NOT open file picker"
        status: PASSED
        evidence: |
          members.tsx:493: { text: t('common.cancel'), style: 'cancel' }. The cancel button
          has no onPress handler, so Alert dismisses without calling performImport.

      - id: MP-86-06
        description: "i18n keys for confirmation exist in en.json"
        status: PASSED
        evidence: |
          en.json:168-169:
            "importConfirmTitle": "Import Members"
            "importConfirmMessage": "Importing a CSV file will replace the entire current
            member list with the contents of the file. Existing speech assignments (past
            and present) will not be affected. Do you want to continue?"

      - id: MP-86-07
        description: "i18n keys for confirmation exist in pt-BR.json"
        status: PASSED
        evidence: |
          pt-BR.json:168-169:
            "importConfirmTitle": "Importar Membros"
            "importConfirmMessage": "Ao importar um arquivo CSV, toda a lista de membros
            atual sera substituida pelo conteudo do arquivo. As designacoes de discursos
            existentes (passadas e presentes) nao serao afetadas. Deseja continuar?"

      - id: MP-86-08
        description: "i18n keys for confirmation exist in es.json"
        status: PASSED
        evidence: |
          es.json:168-169:
            "importConfirmTitle": "Importar Miembros"
            "importConfirmMessage": "Al importar un archivo CSV, toda la lista de miembros
            actual sera reemplazada por el contenido del archivo. Las asignaciones de
            discursos existentes (pasadas y presentes) no seran afectadas. Desea continuar?"

      - id: MP-86-09
        description: "Existing test suite passes without regressions"
        status: PASSED
        evidence: |
          npx vitest run: 55 test files, 2610/2610 tests passed.
          Zero failures, zero skipped.

    must_pass_total: 9
    must_pass_passed: 9
    must_pass_failed: 0

    should_pass_results:
      - id: SP-86-01
        description: "Confirmation dialog has appropriate title"
        status: PASSED_BY_ANALYSIS
        evidence: |
          members.tsx:490: Alert title is t('members.importConfirmTitle').
          en: "Import Members", pt: "Importar Membros", es: "Importar Miembros".
          Clear, descriptive title identifying the action.

      - id: SP-86-02
        description: "Confirmation dialog has confirm and cancel buttons"
        status: PASSED_BY_ANALYSIS
        evidence: |
          members.tsx:492-495: Alert has 2 buttons:
          1. { text: t('common.cancel'), style: 'cancel' } - dismisses dialog
          2. { text: t('common.confirm'), style: 'default', onPress: () => performImport() }
          Cancel first (iOS convention), confirm second.

      - id: SP-86-03
        description: "Translations are accurate in all 3 languages"
        status: PASSED_BY_ANALYSIS
        evidence: |
          Portuguese: "substituida", "designacoes de discursos", "nao serao afetadas" -
          natural Brazilian Portuguese.
          Spanish: "reemplazada", "asignaciones de discursos", "no seran afectadas" -
          natural Spanish. Both convey the same meaning as English accurately.

    should_pass_total: 3
    should_pass_passed: 3
    should_pass_failed: 0

  verdict: passed
  verdict_rationale: |
    All 9 must_pass checks passed. All 3 should_pass checks passed (by analysis).
    Import flow now: button press > confirmation Alert > user confirms > file picker opens.
    Dialog warns about replacing entire member list and reassures about assignments.
    New i18n keys added to all 3 locales (en, pt-BR, es) with accurate translations.
    handleImport refactored into handleImport (dialog) + performImport (file picker).
    2610/2610 tests passing.

  issues_for_coder: []


# #############################################################################
# CR-87: Replace Edit/Delete text with pencil/trash icons on swipe buttons
# #############################################################################

cr_87:
  cr_id: CR-87
  title: "Trocar texto Editar/Excluir nos botoes de swipe por icones de lapis e lixeira"
  type: feature_request
  spec: specs/SPEC_F032_F034.yaml
  qa_plan: qa/QA_PLAN_batch6_phase2.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      QA Plan validated against SPEC. SwipeableCard currently renders text labels
      on swipe action buttons. Validation checks cover icon rendering, a11y labels,
      callbacks, contrast, and test suite.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "2 of 2"
    commits:
      - hash: 4e0fbb7
        message: "feat(swipeable): replace Edit/Delete text with Unicode icons pencil/trash (CR-87)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_suite_passed: 2716
    tester_suite_total: 2716

    must_pass_results:

      - id: MP-87-01
        description: "Edit swipe button renders a pencil/edit icon instead of text"
        status: PASSED
        evidence: |
          SwipeableCard.tsx:160-162: Edit button renders <Text style={[styles.actionIcon, { color: colors.onPrimary }]}>{'\u270F'}</Text>.
          U+270F is the Pencil Unicode character. No text label (editLabel) is rendered
          as visible content. The old actionText style with fontSize:13 is replaced by
          actionIcon style with fontSize:20.

      - id: MP-87-02
        description: "Delete swipe button renders a trash/delete icon instead of text"
        status: PASSED
        evidence: |
          SwipeableCard.tsx:172-174: Delete button renders <Text style={[styles.actionIcon, { color: '#FFFFFF' }]}>{'\uD83D\uDDD1'}</Text>.
          This is the UTF-16 surrogate pair for U+1F5D1 (Wastebasket). No text label
          (deleteLabel) is rendered as visible content.

      - id: MP-87-03
        description: "Edit button retains accessibility label for screen readers"
        status: PASSED
        evidence: |
          SwipeableCard.tsx:158: accessibilityLabel={editLabel ?? 'Edit'}.
          The Pressable retains the descriptive text for screen readers even though
          the visible content is now an icon. When parent passes editLabel (e.g.,
          t('common.edit')), that text is used for accessibility.

      - id: MP-87-04
        description: "Delete button retains accessibility label for screen readers"
        status: PASSED
        evidence: |
          SwipeableCard.tsx:170: accessibilityLabel={deleteLabel ?? 'Delete'}.
          Same pattern as edit button. Screen readers announce "Delete" or i18n
          equivalent, not the Unicode character.

      - id: MP-87-05
        description: "Edit button still triggers onEdit callback when pressed"
        status: PASSED
        evidence: |
          SwipeableCard.tsx:156: onPress={handleEdit}. handleEdit (lines 137-141)
          calls translateX.value = withSpring(0, SPRING_CONFIG), onReveal(null),
          and onEdit?.(). No change from previous behavior.

      - id: MP-87-06
        description: "Delete button still triggers onDelete callback when pressed"
        status: PASSED
        evidence: |
          SwipeableCard.tsx:168: onPress={handleDelete}. handleDelete (lines 143-147)
          calls translateX.value = withSpring(0, SPRING_CONFIG), onReveal(null),
          and onDelete?.(). No change from previous behavior.

      - id: MP-87-07
        description: "Icon color contrasts with button background"
        status: PASSED
        evidence: |
          SwipeableCard.tsx:160: Edit icon uses color: colors.onPrimary (white on
          primary background, line 155: backgroundColor: colors.primary).
          SwipeableCard.tsx:172: Delete icon uses color: '#FFFFFF' (white on error
          background, line 167: backgroundColor: colors.error).
          Both provide high contrast.

      - id: MP-87-08
        description: "Existing test suite passes without regressions"
        status: PASSED
        evidence: |
          npx vitest run: 56 test files, 2716/2716 tests passed.
          Zero failures, zero skipped.

    must_pass_total: 8
    must_pass_passed: 8
    must_pass_failed: 0

    should_pass_results:

      - id: SP-87-01
        description: "Icons are appropriately sized for the button area"
        status: PASSED_BY_ANALYSIS
        evidence: |
          SwipeableCard.tsx:219-222: actionIcon style has fontSize: 20, textAlign: 'center'.
          Each action button has flex: 1 within the 140px-wide actionsContainer (70px each).
          fontSize 20 is well-sized for a 70px button, centered via textAlign and
          alignItems/justifyContent center on the Pressable.

      - id: SP-87-02
        description: "Icons are recognizable as edit (pencil) and delete (trash)"
        status: PASSED_BY_ANALYSIS
        evidence: |
          U+270F (Pencil) is universally recognized as an edit/pencil icon.
          U+1F5D1 (Wastebasket) is universally recognized as a delete/trash icon.
          Both are standard Unicode characters rendered natively on iOS and Android.

      - id: SP-87-03
        description: "Swipe buttons visual appearance is improved with icons vs text"
        status: PASSED_BY_ANALYSIS
        evidence: |
          Icons (20px) fit well in the 70px-wide buttons. Previously text labels could
          truncate on narrow screens or in languages with long translations (e.g.,
          "Excluir" in Portuguese). Icons are language-agnostic and visually cleaner.

    should_pass_total: 3
    should_pass_passed: 3
    should_pass_failed: 0

  spec_compliance:
    acceptance_criteria:
      - id: AC-F032-01
        title: "Icons replace text on swipe action buttons"
        status: SATISFIED
        evidence: |
          Edit button: U+270F Pencil at SwipeableCard.tsx:161.
          Delete button: U+1F5D1 Wastebasket at SwipeableCard.tsx:173.
          No text rendered inside buttons. Only icon characters.

      - id: AC-F032-02
        title: "Edit button onPress calls onEdit callback"
        status: SATISFIED
        evidence: "SwipeableCard.tsx:156 onPress={handleEdit}, handleEdit line 140 calls onEdit?.()"

      - id: AC-F032-03
        title: "Delete button onPress calls onDelete callback"
        status: SATISFIED
        evidence: "SwipeableCard.tsx:168 onPress={handleDelete}, handleDelete line 146 calls onDelete?.()"

      - id: AC-F032-04
        title: "Accessibility labels retained for screen readers"
        status: SATISFIED
        evidence: |
          Edit: accessibilityLabel={editLabel ?? 'Edit'} (line 158).
          Delete: accessibilityLabel={deleteLabel ?? 'Delete'} (line 170).

      - id: AC-F032-05
        title: "Icons visible with proper contrast and sizing"
        status: SATISFIED
        evidence: |
          Edit icon: colors.onPrimary on colors.primary bg. Delete icon: #FFFFFF on colors.error bg.
          fontSize: 20, textAlign: 'center'. Within spec range of 18-24px.

  verdict: passed
  verdict_rationale: |
    All 8 must_pass checks passed. All 3 should_pass checks passed (by analysis).
    All 5 acceptance criteria (AC-F032-01 through AC-F032-05) satisfied.
    Reviewer approved with 0 issues. 2716/2716 tests passing.
    Edit button uses U+270F Pencil, Delete button uses U+1F5D1 Wastebasket.
    accessibilityLabel preserved for both buttons. Icon fontSize 20 with center alignment.
    No regressions detected.

  issues_for_coder: []


# #############################################################################
# CR-88: Add explanatory text to topics screen
# #############################################################################

cr_88:
  cr_id: CR-88
  title: "Na tela de temas adicionar texto explicando o que a tela faz"
  type: feature_request
  spec: specs/SPEC_F032_F034.yaml
  qa_plan: qa/QA_PLAN_batch6_phase2.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Topics screen had no explanatory text. i18n system supports 3 locales.
      Follows same pattern as CR-80 (members description text).

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "2 of 2"
    commits:
      - hash: 98dbee2
        message: "feat(i18n): add topics.description and topics.noTopics keys in 3 locales (CR-88)"
      - hash: 8431360
        message: "feat(topics): add explanatory description text below header (CR-88)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_suite_passed: 2716
    tester_suite_total: 2716

    must_pass_results:

      - id: MP-88-01
        description: "New i18n key for topics description exists in en.json"
        status: PASSED
        evidence: |
          en.json line 180: "description": "Create custom ward topics or activate predefined
          topic collections. Ward topics can be added, edited, and deleted. Activating a
          collection makes its topics available when assigning speeches. Deactivating removes
          them from the selection list."

      - id: MP-88-02
        description: "New i18n key for topics description exists in pt-BR.json"
        status: PASSED
        evidence: |
          pt-BR.json line 180: "description": "Crie temas customizados da ala ou ative colecoes
          de temas pre-definidos. Temas da ala podem ser adicionados, editados e excluidos.
          Ativar uma colecao torna seus temas disponiveis ao designar discursos. Desativar
          remove da lista de selecao."

      - id: MP-88-03
        description: "New i18n key for topics description exists in es.json"
        status: PASSED
        evidence: |
          es.json line 180: "description": "Cree temas personalizados del barrio o active
          colecciones de temas predefinidos. Los temas del barrio se pueden agregar, editar
          y eliminar. Activar una coleccion hace que sus temas esten disponibles al asignar
          discursos. Desactivar los elimina de la lista de seleccion."

      - id: MP-88-04
        description: "Topics screen renders the description text"
        status: PASSED
        evidence: |
          topics.tsx:383-385: Renders <Text style={[styles.description, { color: colors.textSecondary }]}>
          {t('topics.description')}</Text>. Positioned between the header (lines 372-380)
          and the Ward Topics section (line 388). Uses the t() i18n function.

      - id: MP-88-05
        description: "Description text explains collections activate/deactivate functionality"
        status: PASSED
        evidence: |
          EN: "Activating a collection makes its topics available when assigning speeches.
          Deactivating removes them from the selection list."
          PT: "Ativar uma colecao torna seus temas disponiveis ao designar discursos.
          Desativar remove da lista de selecao."
          ES: "Activar una coleccion hace que sus temas esten disponibles al asignar
          discursos. Desactivar los elimina de la lista de seleccion."
          All 3 locales explicitly explain activate/deactivate semantics.

      - id: MP-88-06
        description: "All three locale files have matching keys in topics section"
        status: PASSED
        evidence: |
          Verified via script: all 3 locale files have exactly 10 identical keys in the
          "topics" section: activateCollection, addTopic, collections, deactivateCollection,
          description, noTopics, title, topicLink, topicTitle, wardTopics.
          PARITY CHECK: PASS. 2 new keys added: description and noTopics.

      - id: MP-88-07
        description: "Existing test suite passes without regressions"
        status: PASSED
        evidence: |
          npx vitest run: 56 test files, 2716/2716 tests passed.
          Zero failures, zero skipped.

    must_pass_total: 7
    must_pass_passed: 7
    must_pass_failed: 0

    should_pass_results:

      - id: SP-88-01
        description: "Description text is styled consistently with members screen description"
        status: PASSED_BY_ANALYSIS
        evidence: |
          topics.tsx:505-509: styles.description has fontSize: 13, textAlign: 'center',
          paddingHorizontal: 16, marginBottom: 8. Color is colors.textSecondary.
          This matches members.tsx styles.description exactly (fontSize 13, textAlign
          'center', paddingHorizontal 16, marginBottom 8).

      - id: SP-88-02
        description: "Description text is positioned logically on the screen"
        status: PASSED_BY_ANALYSIS
        evidence: |
          topics.tsx:382-385: Text appears below the header (line 372-380) and above the
          Ward Topics section (line 388). This is between the screen title and the first
          functional section, same logical position as members.tsx description.

      - id: SP-88-03
        description: "Portuguese translation is natural Brazilian Portuguese"
        status: PASSED_BY_ANALYSIS
        evidence: |
          "Crie temas customizados da ala ou ative colecoes de temas pre-definidos."
          Natural pt-BR: "Crie" (imperative), "customizados" (commonly used in Brazilian
          Portuguese), "da ala" (specific LDS terminology), "designar discursos" (correct
          LDS speech assignment term in Portuguese).

      - id: SP-88-04
        description: "Spanish translation is natural Spanish"
        status: PASSED_BY_ANALYSIS
        evidence: |
          "Cree temas personalizados del barrio o active colecciones de temas predefinidos."
          Natural Spanish: "Cree" (formal imperative), "personalizados" (correct Spanish
          word), "del barrio" (LDS terminology), "asignar discursos" (correct assignment
          term in Spanish).

      - id: SP-88-05
        description: "Description text does not break layout on small screens"
        status: PASSED_BY_ANALYSIS
        evidence: |
          styles.description: fontSize 13, paddingHorizontal 16. No numberOfLines constraint,
          no fixed width. Text wraps naturally within the ScrollView. Small font size (13px)
          appropriate for secondary/helper text on mobile screens.

    should_pass_total: 5
    should_pass_passed: 5
    should_pass_failed: 0

  spec_compliance:
    acceptance_criteria:
      - id: AC-F033-01
        title: "Description text visible below header"
        status: SATISFIED
        evidence: "topics.tsx:383-385 renders t('topics.description') between header and Ward Topics section."

      - id: AC-F033-02
        title: "Description explains activate/deactivate functionality"
        status: SATISFIED
        evidence: "All 3 locales mention activating/deactivating collections and speech assignment availability."

      - id: AC-F033-03
        title: "i18n key exists in all 3 locales"
        status: SATISFIED
        evidence: "topics.description key present in en.json, pt-BR.json, es.json with correct translations."

      - id: AC-F033-04
        title: "Styling follows CR-80 pattern"
        status: SATISFIED
        evidence: "fontSize 13, textAlign center, paddingHorizontal 16, color textSecondary. Identical to members."

      - id: AC-F033-06
        title: "Locale files have matching key structure"
        status: SATISFIED
        evidence: "10 identical keys in topics section across all 3 locales. 0 removals, 2 additions."

  verdict: passed
  verdict_rationale: |
    All 7 must_pass checks passed. All 5 should_pass checks passed (by analysis).
    All 5 acceptance criteria satisfied. Reviewer approved with 0 issues.
    Description text added to topics screen between header and Ward Topics section.
    Text explains ward topics CRUD and collection activate/deactivate semantics.
    i18n keys added in all 3 locales (en, pt-BR, es) with natural translations.
    Styling matches CR-80 pattern exactly. Key parity verified: 10 keys across all locales.
    2716/2716 tests passing. No regressions.

  issues_for_coder: []


# #############################################################################
# CR-89: Show collection topics on click (read-only, expand/collapse)
# #############################################################################

cr_89:
  cr_id: CR-89
  title: "Ao clicar numa colecao, mostrar todos os temas (read-only, lista simples)"
  type: feature_request
  spec: specs/SPEC_F032_F034.yaml
  qa_plan: qa/QA_PLAN_batch6_phase2.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      CollectionRow was not tappable. No way to see topics in a collection.
      Data model supports it (general_topics.collection_id FK). Recommended
      expand/collapse inline accordion pattern.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "2 of 2"
    commits:
      - hash: 445f7b7
        message: "feat(hooks): add useCollectionTopics hook for lazy-loading collection topics (CR-89)"
      - hash: d2c9c0a
        message: "feat(topics): make CollectionRow tappable with chevron indicator (CR-89)"
      - hash: 9e41fec
        message: "feat(topics): add expand/collapse collection topics view with accordion pattern (CR-89)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_suite_passed: 2716
    tester_suite_total: 2716

    must_pass_results:

      - id: MP-89-01
        description: "Tapping a collection row shows the topics belonging to that collection"
        status: PASSED
        evidence: |
          topics.tsx:188-191: CollectionRow has a Pressable wrapper with onPress prop.
          topics.tsx:356-358: handleCollectionPress toggles expandedCollectionId state.
          topics.tsx:461-463: When expandedCollectionId === item.id, renders
          <CollectionTopicsList collectionId={item.id} colors={colors} />.
          CollectionTopicsList (lines 217-261) fetches and renders the collection topics.

      - id: MP-89-02
        description: "Topics displayed are fetched from general_topics table by collection_id"
        status: PASSED
        evidence: |
          useTopics.ts:232-247: useCollectionTopics hook queries supabase
          .from('general_topics').select('*').eq('collection_id', collectionId!)
          .order('title', { ascending: true }). Returns GeneralTopic[].
          Query key: topicKeys.collectionTopics(collectionId) at line 29-30.
          Enabled only when collectionId is truthy (line 245).

      - id: MP-89-03
        description: "Topic list is read-only (no edit/delete actions)"
        status: PASSED
        evidence: |
          topics.tsx:239-261: CollectionTopicsList renders topics using simple View and
          Text elements. No SwipeableCard, no Pressable with edit/delete handlers, no
          action buttons. Each topic is a View with Text for title and optional Text
          for link. The list is purely display-only.

      - id: MP-89-04
        description: "Each topic displays at least the title"
        status: PASSED
        evidence: |
          topics.tsx:249: <Text style={[styles.collectionTopicTitle, { color: colors.textSecondary }]}>
          {topic.title}</Text>. Title is always rendered for every topic in the list.
          Additionally, if topic.link exists, it is shown at line 252-255.

      - id: MP-89-05
        description: "Collection toggle (Switch) still works independently of tap-to-view"
        status: PASSED
        evidence: |
          topics.tsx:200-205: Switch is rendered OUTSIDE the Pressable area.
          CollectionRow structure: View > [Pressable (chevron + name), Switch].
          The Pressable wraps only the chevron and collection name (line 188-199),
          while the Switch (line 200-205) is a sibling at the same level.
          Switch onValueChange={onToggle} is independent of Pressable onPress.

      - id: MP-89-06
        description: "Tapping the same collection again hides/collapses the topic list"
        status: PASSED
        evidence: |
          topics.tsx:356-358: handleCollectionPress uses toggle logic:
          setExpandedCollectionId((prev) => (prev === collectionId ? null : collectionId)).
          If the same collection is tapped again, expandedCollectionId becomes null,
          which hides the CollectionTopicsList (conditional at line 461).

      - id: MP-89-07
        description: "Existing test suite passes without regressions"
        status: PASSED
        evidence: |
          npx vitest run: 56 test files, 2716/2716 tests passed.
          Zero failures, zero skipped.

    must_pass_total: 7
    must_pass_passed: 7
    must_pass_failed: 0

    should_pass_results:

      - id: SP-89-01
        description: "Topic list has appropriate styling (indented, secondary text color)"
        status: PASSED_BY_ANALYSIS
        evidence: |
          topics.tsx:616-617: collectionTopicsContainer has paddingLeft: 32, paddingRight: 16.
          topics.tsx:620-623: collectionTopicItem has paddingVertical: 8, paddingLeft: 8.
          topics.tsx:624-625: collectionTopicTitle uses fontSize: 14, color: colors.textSecondary.
          Topics are visually nested under the collection row with larger left padding.

      - id: SP-89-02
        description: "Topic link is shown if available"
        status: PASSED_BY_ANALYSIS
        evidence: |
          topics.tsx:252-255: Conditional rendering {topic.link && (<Text style={[
          styles.collectionTopicLink, { color: colors.primary }]} numberOfLines={1}>
          {topic.link}</Text>)}. Link shown in primary color with fontSize 12 and marginTop 2.

      - id: SP-89-03
        description: "Loading state is handled while fetching topics"
        status: PASSED_BY_ANALYSIS
        evidence: |
          topics.tsx:221-227: When isLoading is true, renders:
          <View style={styles.collectionTopicsLoading}>
            <ActivityIndicator size="small" color={colors.primary} />
          </View>
          Loading style: paddingVertical 16, alignItems center (lines 631-634).

      - id: SP-89-04
        description: "Empty state is handled if collection has no topics"
        status: PASSED_BY_ANALYSIS
        evidence: |
          topics.tsx:229-236: When topics is null or empty, renders:
          <Text style={[styles.collectionTopicsEmptyText, { color: colors.textSecondary }]}>
            {t('topics.noTopics')}
          </Text>
          en.json: "No topics in this collection", pt-BR: "Nenhum tema nesta colecao",
          es: "No hay temas en esta coleccion". Styled with fontSize 13, fontStyle italic.

      - id: SP-89-05
        description: "Only one collection can be expanded at a time (accordion pattern)"
        status: PASSED_BY_ANALYSIS
        evidence: |
          topics.tsx:276: expandedCollectionId is a single string|null state.
          topics.tsx:357: handleCollectionPress sets expandedCollectionId to the tapped
          collection's ID or null (toggle). Since only one ID is stored, expanding a
          new collection automatically collapses the previous one (accordion behavior).

    should_pass_total: 5
    should_pass_passed: 5
    should_pass_failed: 0

  spec_compliance:
    acceptance_criteria:
      - id: AC-F034-01
        title: "Tapping collection shows its topics"
        status: SATISFIED
        evidence: "CollectionRow Pressable + handleCollectionPress + CollectionTopicsList renders topics."

      - id: AC-F034-02
        title: "Tapping again collapses the topic list"
        status: SATISFIED
        evidence: "Toggle logic: prev === collectionId ? null : collectionId."

      - id: AC-F034-03
        title: "Topics fetched from general_topics by collection_id"
        status: SATISFIED
        evidence: "useCollectionTopics hook: supabase.from('general_topics').select('*').eq('collection_id', id).order('title')."

      - id: AC-F034-04
        title: "Loading state shown while fetching"
        status: SATISFIED
        evidence: "ActivityIndicator rendered when isLoading is true."

      - id: AC-F034-05
        title: "Empty state shown when no topics"
        status: SATISFIED
        evidence: "t('topics.noTopics') rendered when topics array is empty."

      - id: AC-F034-06
        title: "Switch toggle works independently of tap"
        status: SATISFIED
        evidence: "Switch is sibling to Pressable, not nested inside it. Events are independent."

      - id: AC-F034-07
        title: "Accordion pattern (one expanded at a time)"
        status: SATISFIED
        evidence: "Single expandedCollectionId state variable enforces one-at-a-time expansion."

      - id: AC-F034-08
        title: "Topic list styled as nested, read-only"
        status: SATISFIED
        evidence: "paddingLeft 32, textSecondary color, no SwipeableCard, no action buttons."

  verdict: passed
  verdict_rationale: |
    All 7 must_pass checks passed. All 5 should_pass checks passed (by analysis).
    All 8 acceptance criteria (AC-F034-01 through AC-F034-08) satisfied.
    Reviewer approved with 0 issues. 2716/2716 tests passing.
    New useCollectionTopics hook added for lazy-loading collection topics by ID.
    CollectionRow made tappable with Pressable wrapper and chevron indicator.
    Expand/collapse accordion pattern implemented with single expandedCollectionId state.
    Switch toggle independent of tap (sibling elements, not nested).
    Topics rendered read-only with title and optional link. Loading and empty states handled.
    No regressions detected.

  issues_for_coder: []


# #############################################################################
# CR-91: Fix RLS policy error on notification_queue (F035)
# #############################################################################

cr_91:
  cr_id: CR-91
  title: "Fix RLS policy error on notification_queue"
  type: bugfix
  spec: specs/SPEC_F035_F039.yaml
  qa_plan: qa/QA_PLAN_batch7_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Bug confirmed via code analysis. enqueue_speech_notification() trigger
      function (003_notification_triggers.sql:12) does NOT use SECURITY DEFINER.
      notification_queue has RLS enabled with NO policies (002_rls_policies.sql:308).
      When the trigger fires on speech status change, the INSERT into notification_queue
      is blocked by RLS because it runs in the authenticated user's context.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 2"
    commits:
      - hash: bdba1aa
        message: "fix(db): add SECURITY DEFINER to enqueue_speech_notification trigger (CR-91)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_suite_passed: 2789
    tester_suite_total: 2789

    must_pass_results:

      - id: MP-F035-01
        description: "enqueue_speech_notification() function uses SECURITY DEFINER"
        status: PASSED
        evidence: |
          supabase/migrations/013_fix_notification_trigger_security_definer.sql:86:
            $$ LANGUAGE plpgsql SECURITY DEFINER;
          CREATE OR REPLACE FUNCTION enqueue_speech_notification() RETURNS TRIGGER
          now includes SECURITY DEFINER. Function body is identical to original in
          003_notification_triggers.sql.

      - id: MP-F035-02
        description: "notification_queue RLS remains enabled with NO client policies"
        status: PASSED
        evidence: |
          supabase/migrations/002_rls_policies.sql:308-310 unchanged:
            ALTER TABLE notification_queue ENABLE ROW LEVEL SECURITY;
            -- No policies = no client access. Only service_role key (Edge Functions) can access.
          No new INSERT policies added for authenticated users.

      - id: MP-F035-03
        description: "Trigger still fires on speech status changes (INSERT/UPDATE)"
        status: PASSED
        evidence: |
          Migration 013 uses CREATE OR REPLACE FUNCTION (not DROP/CREATE TRIGGER).
          The existing speech_notification_trigger (003_notification_triggers.sql:88-91)
          remains unchanged: AFTER INSERT OR UPDATE ON speeches FOR EACH ROW
          EXECUTE FUNCTION enqueue_speech_notification().

      - id: MP-F035-04
        description: "Trigger correctly inserts designation notification on assigned_not_invited"
        status: PASSED
        evidence: |
          013_fix_notification_trigger_security_definer.sql:22-36:
            IF NEW.status = 'assigned_not_invited' THEN
              INSERT INTO notification_queue (...) VALUES (..., 'designation', ..., 'secretary',
              'pending', now() + INTERVAL '5 minutes');
          Identical to original trigger body.

      - id: MP-F035-05
        description: "Trigger correctly inserts speaker_confirmed notification"
        status: PASSED
        evidence: |
          013_fix_notification_trigger_security_definer.sql:39-53:
            IF NEW.status = 'assigned_confirmed' ... THEN
              INSERT INTO notification_queue (...) VALUES (..., 'speaker_confirmed', ...,
              'secretary_and_bishopric', 'pending', now());

      - id: MP-F035-06
        description: "Trigger correctly inserts speaker_withdrew notification"
        status: PASSED
        evidence: |
          013_fix_notification_trigger_security_definer.sql:56-70:
            IF NEW.status = 'gave_up' ... THEN
              INSERT INTO notification_queue (...) VALUES (..., 'speaker_withdrew', ...,
              'bishopric', 'pending', now());

      - id: MP-F035-07
        description: "Trigger correctly cancels pending notifications on not_assigned"
        status: PASSED
        evidence: |
          013_fix_notification_trigger_security_definer.sql:73-81:
            IF NEW.status = 'not_assigned' ... THEN
              UPDATE notification_queue SET status = 'cancelled'
              WHERE ward_id = NEW.ward_id AND sunday_date = NEW.sunday_date
              AND speech_position = NEW.position AND type = 'designation'
              AND status = 'pending';

      - id: MP-F035-08
        description: "Existing test suite passes without regressions"
        status: PASSED
        evidence: |
          npx vitest run: 57 test files, 2789/2789 tests passed.
          Zero failures, zero skipped. Includes new batch7 tests.

    must_pass_total: 8
    must_pass_passed: 8
    must_pass_failed: 0

    should_pass_results:

      - id: SP-F035-01
        description: "Assigning a speaker does not produce RLS error"
        status: PASSED_BY_ANALYSIS
        evidence: |
          With SECURITY DEFINER, enqueue_speech_notification() now runs with the
          privileges of the function owner (postgres superuser), bypassing RLS on
          notification_queue. The INSERT will succeed without RLS violation.

      - id: SP-F035-02
        description: "Error dialog is not shown when assigning a speaker"
        status: PASSED_BY_ANALYSIS
        evidence: |
          The RLS violation was the root cause of the MutationCache error which
          triggered the error dialog. With SECURITY DEFINER, no RLS violation occurs,
          so no error propagates to the mutation cache, and no dialog is shown.

    should_pass_total: 2
    should_pass_passed: 2
    should_pass_failed: 0

  spec_compliance:
    acceptance_criteria:
      - id: AC-F035-01
        title: "Funcao trigger usa SECURITY DEFINER"
        status: SATISFIED
        evidence: "Migration 013 line 86: $$ LANGUAGE plpgsql SECURITY DEFINER"

      - id: AC-F035-02
        title: "notification_queue permanece sem policies de client"
        status: SATISFIED
        evidence: "002_rls_policies.sql:308-310 unchanged. No new policies added."

      - id: AC-F035-03
        title: "Trigger continua disparando corretamente"
        status: SATISFIED
        evidence: "CREATE OR REPLACE preserves existing trigger. All 4 status cases preserved."

      - id: AC-F035-04
        title: "Nenhum dialogo de erro exibido ao designar orador"
        status: SATISFIED
        evidence: "RLS violation eliminated by SECURITY DEFINER. No error propagation."

  verdict: passed
  verdict_rationale: |
    All 8 must_pass checks passed. All 2 should_pass checks passed (by analysis).
    All 4 acceptance criteria satisfied. Migration 013 adds SECURITY DEFINER to
    the trigger function without modifying the trigger itself (CREATE OR REPLACE).
    Function body identical to original. notification_queue RLS unchanged.
    2789/2789 tests passing. No regressions.

  issues_for_coder: []


# #############################################################################
# CR-92: Fix duplicate key error in country dropdown (F036)
# #############################################################################

cr_92:
  cr_id: CR-92
  title: "Fix duplicate key error in country dropdown"
  type: bugfix
  spec: specs/SPEC_F035_F039.yaml
  qa_plan: qa/QA_PLAN_batch7_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Bug confirmed. FlatList keyExtractor at members.tsx:146 used item.code which
      is not unique (+1 for US/CA, +7 for RU/KZ). Error message ".$+7" confirms
      the +7 duplicate.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 2"
    commits:
      - hash: e091833
        message: "fix(members): change keyExtractor to item.label (CR-92)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_suite_passed: 2789
    tester_suite_total: 2789

    must_pass_results:

      - id: MP-F036-01
        description: "FlatList keyExtractor uses a unique key for each country code entry"
        status: PASSED
        evidence: |
          members.tsx:146: keyExtractor={(item) => item.label}
          Changed from item.code to item.label. All 172 labels in COUNTRY_CODES are
          unique (e.g., 'United States (+1)' vs 'Canada (+1)').

      - id: MP-F036-02
        description: "No duplicate key warning when opening country code picker"
        status: PASSED
        evidence: |
          All labels verified unique via test (batch7-f035-f039.test.ts AC-F036-02).
          172 entries, 172 unique labels. No duplicate keys possible.

      - id: MP-F036-03
        description: "Both US (+1) and Canada (+1) are still selectable"
        status: PASSED
        evidence: |
          countryCodes.ts has both 'United States (+1)' and 'Canada (+1)' entries.
          FlatList renders all entries. onPress sets countryCode to item.code ('+1'
          for both). Both entries render and can be selected independently.

      - id: MP-F036-04
        description: "Both Russia (+7) and Kazakhstan (+7) are still selectable"
        status: PASSED
        evidence: |
          countryCodes.ts has both 'Russia (+7)' and 'Kazakhstan (+7)' entries.
          Same pattern as US/CA. Both selectable with item.code '+7'.

      - id: MP-F036-05
        description: "Selected country code is still highlighted correctly"
        status: PASSED
        evidence: |
          members.tsx:151: item.code === countryCode && { backgroundColor: colors.primaryContainer }
          Highlighting comparison unchanged - still uses item.code for visual highlighting.
          Note: both US and Canada highlight when +1 is selected (acceptable per EC-F036-01).

      - id: MP-F036-06
        description: "Existing test suite passes without regressions"
        status: PASSED
        evidence: |
          npx vitest run: 57 test files, 2789/2789 tests passed.
          Zero failures, zero skipped.

    must_pass_total: 6
    must_pass_passed: 6
    must_pass_failed: 0

    should_pass_results:

      - id: SP-F036-01
        description: "Country code picker scrolls and renders smoothly"
        status: PASSED_BY_ANALYSIS
        evidence: |
          keyExtractor change from item.code to item.label has no performance impact.
          item.label is a string, same as item.code. FlatList rendering unchanged.
          Virtualized list handles 172 items efficiently.

    should_pass_total: 1
    should_pass_passed: 1
    should_pass_failed: 0

  spec_compliance:
    acceptance_criteria:
      - id: AC-F036-01
        title: "FlatList usa key unico para cada pais"
        status: SATISFIED
        evidence: "keyExtractor={(item) => item.label}. All 172 labels unique."

      - id: AC-F036-02
        title: "Sem warning de duplicate key no console"
        status: SATISFIED
        evidence: "Labels unique, so no duplicate key React warning."

      - id: AC-F036-03
        title: "Ambos paises com +1 continuam selecionaveis"
        status: SATISFIED
        evidence: "US and Canada both render and can be selected."

      - id: AC-F036-04
        title: "Ambos paises com +7 continuam selecionaveis"
        status: SATISFIED
        evidence: "Russia and Kazakhstan both render and can be selected."

      - id: AC-F036-05
        title: "Pais selecionado continua sendo destacado"
        status: SATISFIED
        evidence: "item.code === countryCode comparison preserved for highlighting."

  verdict: passed
  verdict_rationale: |
    All 6 must_pass checks passed. All 1 should_pass checks passed (by analysis).
    All 5 acceptance criteria satisfied. Single-line fix: keyExtractor changed from
    item.code to item.label. 172 unique labels confirmed. Highlighting unchanged.
    2789/2789 tests passing. No regressions.

  issues_for_coder: []


# #############################################################################
# CR-93: Change deep link protocol to sacrmeetman:// (F037)
# #############################################################################

cr_93:
  cr_id: CR-93
  title: "Change deep link protocol to sacrmeetman://"
  type: bugfix
  spec: specs/SPEC_F035_F039.yaml
  qa_plan: qa/QA_PLAN_batch7_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Protocol change needed in 2 locations: app.json (scheme) and
      create-invitation Edge Function (deep link construction).
      Custom URL schemes don't work in Expo Go (expected behavior).

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 2"
    commits:
      - hash: 313dc67
        message: "fix(deeplink): change protocol wardmanager -> sacrmeetman (CR-93)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_suite_passed: 2789
    tester_suite_total: 2789

    must_pass_results:

      - id: MP-F037-01
        description: "app.json scheme is 'sacrmeetman'"
        status: PASSED
        evidence: |
          app.json:10: "scheme": "sacrmeetman"
          Changed from "wardmanager" to "sacrmeetman".

      - id: MP-F037-02
        description: "create-invitation Edge Function uses sacrmeetman:// protocol"
        status: PASSED
        evidence: |
          supabase/functions/create-invitation/index.ts:170:
            const deepLink = `sacrmeetman://invite/${invitationToken}`;
          Changed from wardmanager:// to sacrmeetman://.

      - id: MP-F037-03
        description: "No remaining references to wardmanager:// in source code"
        status: PASSED
        evidence: |
          Grep for 'wardmanager://' in src/: Only hits are in test files
          (batch7-f035-f039.test.ts) that verify wardmanager:// is NOT present.
          No non-test source files contain wardmanager://.
          Grep for 'wardmanager://' in supabase/: Zero matches.

      - id: MP-F037-04
        description: "Existing test suite passes without regressions"
        status: PASSED
        evidence: |
          npx vitest run: 57 test files, 2789/2789 tests passed.
          Zero failures, zero skipped.

    must_pass_total: 4
    must_pass_passed: 4
    must_pass_failed: 0

    should_pass_results:

      - id: SP-F037-01
        description: "iOS bundle identifier unchanged"
        status: PASSED
        evidence: |
          app.json:18: "bundleIdentifier": "com.wardmanager.app"
          Unchanged. Bundle identifier is a build config, not a URL scheme.

      - id: SP-F037-02
        description: "Android package unchanged"
        status: PASSED
        evidence: |
          app.json:26: "package": "com.wardmanager.app"
          Unchanged.

    should_pass_total: 2
    should_pass_passed: 2
    should_pass_failed: 0

  spec_compliance:
    acceptance_criteria:
      - id: AC-F037-01
        title: "app.json usa scheme sacrmeetman"
        status: SATISFIED
        evidence: "app.json:10 'scheme': 'sacrmeetman'"

      - id: AC-F037-02
        title: "Edge Function gera deep link com sacrmeetman://"
        status: SATISFIED
        evidence: "create-invitation/index.ts:170 uses sacrmeetman://invite/"

      - id: AC-F037-03
        title: "Nenhuma referencia a wardmanager:// no codigo fonte"
        status: SATISFIED
        evidence: "Zero non-test references in src/ and supabase/ directories."

      - id: AC-F037-04
        title: "Bundle identifier e package Android NAO foram alterados"
        status: SATISFIED
        evidence: "ios.bundleIdentifier and android.package both unchanged."

  verdict: passed
  verdict_rationale: |
    All 4 must_pass checks passed. All 2 should_pass checks passed.
    All 4 acceptance criteria satisfied. Two-file change: app.json scheme and
    Edge Function deep link. Zero remaining wardmanager:// references in source.
    Bundle identifier and Android package unchanged.
    2789/2789 tests passing. No regressions.

  issues_for_coder: []


# #############################################################################
# CR-95: Fix speech fields not hiding on sunday type change (F038)
# #############################################################################

cr_95:
  cr_id: CR-95
  title: "Fix speech fields not hiding when changing sunday type"
  type: bugfix
  spec: specs/SPEC_F035_F039.yaml
  qa_plan: qa/QA_PLAN_batch7_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Bug confirmed. speeches.tsx:277 used isExcludedFromAgenda() which only
      returns true for general_conference and stake_conference. Other non-speech
      types (testimony_meeting, ward_conference, primary_presentation, other)
      did NOT hide speech slots.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 2"
    commits:
      - hash: 1420ed2
        message: "fix(speeches): hide speech slots for non-speeches types (CR-95)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_suite_passed: 2789
    tester_suite_total: 2789

    must_pass_results:

      - id: MP-F038-01
        description: "Speech slots visible when sunday type is 'speeches'"
        status: PASSED
        evidence: |
          speeches.tsx:276: (!exception || exception.reason === 'speeches')
          When exception is null (default = speeches) or exception.reason === 'speeches',
          the condition is true and [1, 2, 3].map renders speech slots.

      - id: MP-F038-02
        description: "Speech slots hidden when sunday type is 'testimony_meeting'"
        status: PASSED
        evidence: |
          When exception.reason = 'testimony_meeting', the condition
          (!exception || exception.reason === 'speeches') evaluates to
          (false || false) = false. Speech slots not rendered.

      - id: MP-F038-03
        description: "Speech slots hidden when sunday type is 'general_conference'"
        status: PASSED
        evidence: |
          When exception.reason = 'general_conference', condition is false.
          Speech slots not rendered.

      - id: MP-F038-04
        description: "Speech slots hidden when sunday type is 'stake_conference'"
        status: PASSED
        evidence: |
          When exception.reason = 'stake_conference', condition is false.
          Speech slots not rendered.

      - id: MP-F038-05
        description: "Speech slots hidden when sunday type is 'ward_conference'"
        status: PASSED
        evidence: |
          When exception.reason = 'ward_conference', condition is false.
          Speech slots not rendered. (Previously NOT hidden - this was the bug.)

      - id: MP-F038-06
        description: "Speech slots hidden when sunday type is 'primary_presentation'"
        status: PASSED
        evidence: |
          When exception.reason = 'primary_presentation', condition is false.
          Speech slots not rendered. (Previously NOT hidden - this was the bug.)

      - id: MP-F038-07
        description: "Speech slots hidden when sunday type is 'other'"
        status: PASSED
        evidence: |
          When exception.reason = 'other', condition is false.
          Speech slots not rendered. (Previously NOT hidden - this was the bug.)

      - id: MP-F038-08
        description: "Existing test suite passes without regressions"
        status: PASSED
        evidence: |
          npx vitest run: 57 test files, 2789/2789 tests passed.
          Zero failures, zero skipped.

    must_pass_total: 8
    must_pass_passed: 8
    must_pass_failed: 0

    should_pass_results:

      - id: SP-F038-01
        description: "Type dropdown remains visible and functional when expanded"
        status: PASSED_BY_ANALYSIS
        evidence: |
          SundayCard.tsx renders SundayTypeDropdown inside the expanded block
          independent of the children (speech slots). The dropdown is always
          visible when the card is expanded, regardless of sunday type.

      - id: SP-F038-02
        description: "Changing type back to 'speeches' shows speech slots again"
        status: PASSED_BY_ANALYSIS
        evidence: |
          speeches.tsx:276: (!exception || exception.reason === 'speeches')
          When user changes type back to 'speeches', exception.reason becomes
          'speeches', condition is true, and [1, 2, 3].map renders speech slots.

    should_pass_total: 2
    should_pass_passed: 2
    should_pass_failed: 0

  spec_compliance:
    acceptance_criteria:
      - id: AC-F038-01
        title: "Speech slots visiveis quando tipo e 'speeches'"
        status: SATISFIED
        evidence: "(!exception || exception.reason === 'speeches') is true for speeches."

      - id: AC-F038-02
        title: "Speech slots escondidos para testimony_meeting"
        status: SATISFIED
        evidence: "Condition is false for testimony_meeting."

      - id: AC-F038-03
        title: "Speech slots escondidos para general_conference"
        status: SATISFIED
        evidence: "Condition is false for general_conference."

      - id: AC-F038-04
        title: "Speech slots escondidos para stake_conference"
        status: SATISFIED
        evidence: "Condition is false for stake_conference."

      - id: AC-F038-05
        title: "Speech slots escondidos para ward_conference"
        status: SATISFIED
        evidence: "Condition is false for ward_conference."

      - id: AC-F038-06
        title: "Speech slots escondidos para primary_presentation"
        status: SATISFIED
        evidence: "Condition is false for primary_presentation."

      - id: AC-F038-07
        title: "Speech slots escondidos para other"
        status: SATISFIED
        evidence: "Condition is false for other."

      - id: AC-F038-08
        title: "Dropdown de tipo continua visivel e funcional"
        status: SATISFIED
        evidence: "SundayTypeDropdown independent of speech slots rendering."

      - id: AC-F038-09
        title: "Trocar de volta para speeches mostra speech slots"
        status: SATISFIED
        evidence: "Condition evaluates to true when reason is 'speeches'."

  regression_check: |
    isExcludedFromAgenda is no longer imported or used in speeches.tsx.
    Verified: speeches.tsx does not contain 'isExcludedFromAgenda'.
    isExcludedFromAgenda still exists in useAgenda.ts and is still used correctly
    in agenda.tsx for the expandable check (different purpose).

  verdict: passed
  verdict_rationale: |
    All 8 must_pass checks passed. All 2 should_pass checks passed (by analysis).
    All 9 acceptance criteria satisfied. Condition changed from
    !(exception && isExcludedFromAgenda(exception.reason)) to
    (!exception || exception.reason === 'speeches'). This correctly hides speech
    slots for ALL non-speech types, not just general_conference and stake_conference.
    isExcludedFromAgenda removed from speeches.tsx import. agenda.tsx usage unchanged.
    2789/2789 tests passing. No regressions.

  issues_for_coder: []


# #############################################################################
# CR-98: Fix prayer fields not clickable (F039)
# #############################################################################

cr_98:
  cr_id: CR-98
  title: "Fix prayer fields not clickable"
  type: bugfix
  spec: specs/SPEC_F035_F039.yaml
  qa_plan: qa/QA_PLAN_batch7_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Bug confirmed. PrayerSelector did not accept visible/onClose props.
      When rendered by AgendaForm, its internal modalVisible state started as
      false, so the modal never auto-opened. User had to find and click a second
      button at the bottom of the form. Other selectors (ActorSelector,
      HymnSelectorModal) received visible={true} and opened immediately.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 2"
    commits:
      - hash: 7a60ea8
        message: "fix(prayer): add visible/onClose props to PrayerSelector (CR-98)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_suite_passed: 2789
    tester_suite_total: 2789

    must_pass_results:

      - id: MP-F039-01
        description: "Clicking 'Opening Prayer' field opens the member selector modal"
        status: PASSED
        evidence: |
          AgendaForm.tsx:513: PrayerSelector rendered with visible={true} when
          selectorModal.type === 'prayer'.
          PrayerSelector.tsx:60-62: useEffect(() => { if (visible) setModalVisible(true); }, [visible]);
          When visible={true}, the modal opens immediately via the useEffect.

      - id: MP-F039-02
        description: "Clicking 'Closing Prayer' field opens the member selector modal"
        status: PASSED
        evidence: |
          Same mechanism as opening prayer. selectorModal.field determines which
          prayer field is being edited. Both use the same PrayerSelector with visible={true}.

      - id: MP-F039-03
        description: "Selecting a member from the modal assigns them as prayer person"
        status: PASSED
        evidence: |
          PrayerSelector.tsx:66-74: handleSelectMember calls onSelect with member data,
          then setModalVisible(false), onClose?.().
          AgendaForm.tsx:522-533: onSelect callback calls updateAgenda.mutate().

      - id: MP-F039-04
        description: "Closing the modal resets the selector state"
        status: PASSED
        evidence: |
          AgendaForm.tsx:514: onClose={() => setSelectorModal(null)}
          All close paths (selection, cancel, back) call onClose to reset state.

      - id: MP-F039-05
        description: "Custom name option works for non-member prayer persons"
        status: PASSED
        evidence: |
          PrayerSelector.tsx:77-85: handleCustomName calls
          onSelect({ memberId: null, name: trimmed }), then closes modal.

      - id: MP-F039-06
        description: "Prayer fields are disabled for Observer role"
        status: PASSED
        evidence: |
          AgendaForm.tsx:536: disabled={isObserver} passed to PrayerSelector.
          PrayerSelector.tsx:95: onPress={() => !disabled && setModalVisible(true)).

      - id: MP-F039-07
        description: "Existing test suite passes without regressions"
        status: PASSED
        evidence: |
          npx vitest run: 57 test files, 2789/2789 tests passed.
          Zero failures, zero skipped.

    must_pass_total: 7
    must_pass_passed: 7
    must_pass_failed: 0

    should_pass_results:

      - id: SP-F039-01
        description: "Clear button (x) on prayer field works to remove assignment"
        status: PASSED_BY_ANALYSIS
        evidence: |
          PrayerSelector.tsx:87-89: handleClear calls onSelect(null).

      - id: SP-F039-02
        description: "Search functionality works in prayer selector modal"
        status: PASSED_BY_ANALYSIS
        evidence: |
          PrayerSelector.tsx:64: useMembers(search) fetches filtered members.
          SearchInput with autoFocus for immediate search.

      - id: SP-F039-03
        description: "Prayer selector follows same UX pattern as other selectors"
        status: PASSED_BY_ANALYSIS
        evidence: |
          PrayerSelector now accepts visible and onClose props (lines 41-43),
          matching ActorSelector and HymnSelectorModal pattern.

    should_pass_total: 3
    should_pass_passed: 3
    should_pass_failed: 0

  spec_compliance:
    acceptance_criteria:
      - id: AC-F039-01
        title: "Clicar no campo Oracao de Abertura abre o modal"
        status: SATISFIED
        evidence: "visible={true} + useEffect opens modal immediately."

      - id: AC-F039-02
        title: "Clicar no campo Oracao de Fechamento abre o modal"
        status: SATISFIED
        evidence: "Same mechanism via selectorModal.field = 'closing_prayer'."

      - id: AC-F039-03
        title: "Selecionar membro atribui como orador da oracao"
        status: SATISFIED
        evidence: "handleSelectMember calls onSelect, updateAgenda.mutate fires."

      - id: AC-F039-04
        title: "Fechar o modal reseta o estado"
        status: SATISFIED
        evidence: "onClose={() => setSelectorModal(null)} on all close paths."

      - id: AC-F039-05
        title: "Nome customizado funciona para nao-membros"
        status: SATISFIED
        evidence: "handleCustomName calls onSelect({ memberId: null, name: trimmed })."

      - id: AC-F039-06
        title: "Campos de oracao desabilitados para Observador"
        status: SATISFIED
        evidence: "disabled={isObserver} prevents modal opening."

      - id: AC-F039-07
        title: "PrayerSelector aceita prop visible e onClose"
        status: SATISFIED
        evidence: "visible?: boolean and onClose?: () => void in PrayerSelectorProps."

  verdict: passed
  verdict_rationale: |
    All 7 must_pass checks passed. All 3 should_pass checks passed (by analysis).
    All 7 acceptance criteria satisfied. PrayerSelector now accepts visible and
    onClose props, matching ActorSelector and HymnSelectorModal pattern.
    useEffect syncs internal modalVisible state with external visible prop.
    All close paths call onClose to reset state.
    2789/2789 tests passing. No regressions.

  issues_for_coder: []


# #############################################################################
# CROSS-CUTTING: Batch 7 Phase 1
# #############################################################################

batch7_phase1_cross_cutting:
  - id: CC-B7P1-01
    description: "All 5 fixes do not conflict with each other"
    status: PASSED
    evidence: |
      F035: supabase/migrations/013_fix_notification_trigger_security_definer.sql (new file)
      F036: src/app/(tabs)/settings/members.tsx (keyExtractor line only)
      F037: app.json + supabase/functions/create-invitation/index.ts
      F038: src/app/(tabs)/speeches.tsx (rendering condition only)
      F039: src/components/PrayerSelector.tsx + src/components/AgendaForm.tsx
      Zero file overlap between any pair of fixes.

  - id: CC-B7P1-02
    description: "Full test suite passes after all fixes"
    status: PASSED
    evidence: |
      npx vitest run: 57 test files, 2789/2789 tests passed.
      Zero failures, zero skipped. 73 new tests added for batch7.

  - id: CC-B7P1-03
    description: "No new dependencies introduced"
    status: PASSED
    evidence: |
      All fixes use existing code patterns. No package.json changes.
      New migration file follows existing migration numbering convention (013).


# #############################################################################
# BATCH 7 PHASE 2 - PRE VALIDATION
# CR-94, CR-96, CR-97, CR-99, CR-100
# #############################################################################

batch7_phase2_pre:
  batch: 7
  phase: 2
  type: feature_request
  features: [F040, F041, F042, F043, F044]
  change_requests: [CR-94, CR-96, CR-97, CR-99, CR-100]
  qa_plan_ref: "docs/qa/QA_PLAN_batch7_phase2.yaml"
  pre_validation_timestamp: "2026-02-18"
  pre_validation_status: passed
  baseline_tests: "57 test files, 2789/2789 tests passed"

  cr_94_f040:
    title: "WhatsApp template with speech position, topic, and link"
    type: feature_request
    pre_status: validated
    finding: |
      Template already includes {posicao}, {colecao}, {titulo}, {link} placeholders.
      User wants to CHANGE the default template text. Development needed to update
      DEFAULT_TEMPLATE_PT_BR to the desired format.
    validation_checks_count: 7
    must_pass_count: 5

  cr_96_f041:
    title: "Search fields fixed at top filling available space"
    type: feature_request
    pre_status: validated
    finding: |
      Modal-based selectors already have search fixed at top. Settings screens
      (members, topics) have search that scrolls with content. Development needed
      to fix search at top in settings screens.
    validation_checks_count: 6
    must_pass_count: 4

  cr_97_f042:
    title: "Multi-select for Reconhecendo a Presenca"
    type: feature_request
    pre_status: validated
    finding: |
      Database supports string[] but current UI replaces array with single selection.
      Development needed to implement multi-select toggle behavior in ActorSelector
      or create new multi-select component.
    validation_checks_count: 7
    must_pass_count: 5

  cr_99_f043:
    title: "Speech labels Orador -> Discurso"
    type: feature_request
    pre_status: validated
    finding: |
      Currently labels show 'Orador'/'Speaker'/'Orador' in pt-BR/en/es. Need to
      change to 'Discurso'/'Speech'/'Discurso'. Used in AgendaForm and
      usePresentationMode. Must be careful with i18n key reuse.
    validation_checks_count: 6
    must_pass_count: 4

  cr_100_f044:
    title: "Read-only speaker field with edit icon for last-minute swap"
    type: feature_request
    pre_status: validated
    finding: |
      Feature does not exist. Speaker fields are currently simple clickable selectors.
      Full development needed: read-only display, edit icon, manual text input,
      X icon for revert, original value tracking.
    validation_checks_count: 8
    must_pass_count: 6


# #############################################################################
# BATCH 7 PHASE 2 - POST VALIDATION
# CR-94, CR-96, CR-97, CR-99, CR-100
# #############################################################################

batch7_phase2_post:
  batch: 7
  phase: 2
  type: feature_request
  features: [F040, F041, F042, F043, F044]
  change_requests: [CR-94, CR-96, CR-97, CR-99, CR-100]
  qa_plan_ref: "docs/qa/QA_PLAN_batch7_phase2.yaml"
  post_validation_timestamp: "2026-02-18"
  post_validation_status: passed
  verdict: passed
  final_tests: "58 test files, 2923/2923 tests passed (was 57/2789 at baseline)"
  new_tests_added: 134
  commits_validated: 18

  # ---------------------------------------------------------------------------
  # F040 / CR-94: WhatsApp template with speech position, topic, and link
  # ---------------------------------------------------------------------------
  f040_cr94:
    title: "WhatsApp template with speech position, topic, and link"
    verdict: passed
    checks:
      VC-040-01:
        status: PASS
        evidence: "whatsappUtils.ts:8-9 - DEFAULT_TEMPLATE_PT_BR includes {posicao}"
      VC-040-02:
        status: PASS
        evidence: "whatsappUtils.ts:8-9 - DEFAULT_TEMPLATE_PT_BR includes {titulo}"
      VC-040-03:
        status: PASS
        evidence: "whatsappUtils.ts:8-9 - DEFAULT_TEMPLATE_PT_BR includes {link}"
      VC-040-04:
        status: PASS
        evidence: "resolveTemplate replaces all 6 placeholders. 58 test files pass including whatsapp tests."
      VC-040-05:
        status: PASS
        evidence: "whatsapp.tsx:19-26 - PLACEHOLDERS array has all 6: {nome}, {data}, {posicao}, {colecao}, {titulo}, {link}"
      VC-040-06:
        status: PASS
        evidence: |
          Template text clearly includes position, topic, and link.
          NEW: DEFAULT_TEMPLATE_EN (line 12) and DEFAULT_TEMPLATE_ES (line 14) added.
          getDefaultTemplate() function (line 21-31) selects template by language.
          buildWhatsAppUrl() accepts language param (line 75, default 'pt-BR').
          InviteManagementSection.tsx passes locale to buildWhatsAppUrl (line 60, 92, 102).
      VC-040-07:
        status: PASS
        evidence: "58 test files, 2923 tests pass. New tests in batch7-f040-f044.test.ts cover getDefaultTemplate and buildWhatsAppUrl language param."

  # ---------------------------------------------------------------------------
  # F041 / CR-96: Search fields fixed at top
  # ---------------------------------------------------------------------------
  f041_cr96:
    title: "Search fields fixed at top filling available space"
    verdict: passed
    checks:
      VC-041-01:
        status: PASS
        evidence: |
          members.tsx:552-559 - SearchInput in searchContainer OUTSIDE and ABOVE the FlatList (line 607).
          Layout: header -> description -> searchContainer -> csvActions -> FlatList.
          SearchInput is NOT inside ScrollView/FlatList, so it stays fixed while list scrolls.
      VC-041-02:
        status: PASS
        evidence: |
          topics.tsx:399-405 - SearchInput in searchContainer OUTSIDE and ABOVE the ScrollView (line 408).
          Layout: header -> description -> sectionHeader -> searchContainer -> ScrollView.
          SearchInput is NOT inside ScrollView, so it stays fixed while content scrolls.
      VC-041-03:
        status: PASS
        evidence: |
          SearchInput component itself has height:40 and fills container width.
          In ActorSelector: searchInput style has flex:1 (line 304).
          In AgendaForm HymnSelector: searchInput style has flex:1 (line 869).
          In settings screens: SearchInput fills searchContainer via full width.
      VC-041-04:
        status: PASS
        evidence: |
          ActorSelector: closeBtn at right of searchRow (line 215-217).
          HymnSelectorModal: sheetCloseBtn at right of sheetSearchRow (line 728-730).
          MemberSelectorModal/TopicSelectorModal: already have close buttons.
          Settings screens: no close button needed (have back button in header).
      VC-041-05:
        status: PASS
        evidence: |
          SearchInput.tsx:44 - renders clear X Pressable when value.length > 0.
          Calls onChangeText('') on press (line 48). Clear button works correctly.
      VC-041-06:
        status: PASS
        evidence: "58 test files, 2923 tests pass. No search-related regressions."

  # ---------------------------------------------------------------------------
  # F042 / CR-97: Multi-select for Reconhecendo a Presenca
  # ---------------------------------------------------------------------------
  f042_cr97:
    title: "Multi-select for Reconhecendo a Presenca"
    verdict: passed
    checks:
      VC-042-01:
        status: PASS
        evidence: |
          AgendaForm.tsx:444-451 - When field === 'recognizing':
            const current = agenda?.recognized_names ?? [];
            const exists = current.includes(actor.name);
            const updated = exists ? current.filter(n => n !== actor.name) : [...current, actor.name];
            updateField('recognized_names', updated.length > 0 ? updated : null);
          This is proper toggle (add/remove) behavior instead of replacing the array.
      VC-042-02:
        status: PASS
        evidence: "AgendaForm.tsx:193 - value={agenda.recognized_names?.join(', ') || ''} displays comma-separated list."
      VC-042-03:
        status: PASS
        evidence: |
          ActorSelector.tsx:146 - const isSelected = multiSelect && selectedNames?.includes(item.name);
          ActorSelector.tsx:163 - Renders checkmark prefix: {isSelected ? '\u2713 ' : ''}{item.name}
          Selected actors show a checkmark indicator.
      VC-042-04:
        status: PASS
        evidence: |
          AgendaForm.tsx:447-448 - Toggle logic: if actor already in array, it's filtered out.
          const exists = current.includes(actor.name);
          const updated = exists ? current.filter(n => n !== actor.name) : [...current, actor.name];
      VC-042-05:
        status: PASS
        evidence: |
          AgendaForm.tsx:450 - updateField('recognized_names', updated.length > 0 ? updated : null);
          Saves full array via updateAgenda.mutate which persists to DB.
          When all removed, saves null.
      VC-042-06:
        status: PASS
        evidence: |
          usePresentationMode.ts:80-86 - recognized_names.join(', ') used in presentation cards.
          No changes needed; array join works for any number of names.
      VC-042-07:
        status: PASS
        evidence: "58 test files, 2923 tests pass. Agenda tests updated for multi-select."

  # ---------------------------------------------------------------------------
  # F043 / CR-99: Speech labels Orador -> Discurso
  # ---------------------------------------------------------------------------
  f043_cr99:
    title: "Change speech labels from Orador to Discurso"
    verdict: passed
    checks:
      VC-043-01:
        status: PASS
        evidence: |
          pt-BR.json:188 - "speaker": "Discurso" (was "Orador").
          AgendaForm.tsx:325,334,378 - Uses t('speeches.speaker') in labels.
          Labels now render as "1o Discurso", "2o Discurso", "3o Discurso" in pt-BR.
      VC-043-02:
        status: PASS
        evidence: |
          en.json:188 - "speaker": "Speech" (was "Speaker").
          Labels render as "1st Speech", "2nd Speech", "3rd Speech" in English.
      VC-043-03:
        status: PASS
        evidence: |
          es.json:188 - "speaker": "Discurso" (was "Orador").
          Labels render as "1er Discurso", "2do Discurso", "3er Discurso" in Spanish.
      VC-043-04:
        status: PASS
        evidence: |
          usePresentationMode.ts:139-140,162 - Uses t('speeches.speaker') in presentation cards.
          Since i18n values changed, presentation labels now show "Discurso"/"Speech"/"Discurso".
      VC-043-05:
        status: PASS
        evidence: |
          All usages of t('speeches.speaker') are in:
          - AgendaForm.tsx (3 usages, lines 325, 334, 378)
          - usePresentationMode.ts (3 usages, lines 139, 140, 162)
          - phase04-agenda-presentation.test.ts (1 usage, line 320)
          - batch7-f040-f044.test.ts (multiple test checks)
          No other usages found. All references correctly resolve to "Discurso"/"Speech".
      VC-043-06:
        status: PASS
        evidence: "58 test files, 2923 tests pass. Tests updated for new label values."

  # ---------------------------------------------------------------------------
  # F044 / CR-100: Read-only speaker field with edit icon for last-minute swap
  # ---------------------------------------------------------------------------
  f044_cr100:
    title: "Read-only speaker field with edit icon for last-minute swap"
    verdict: passed
    checks:
      VC-044-01:
        status: PASS
        evidence: |
          AgendaForm.tsx:631-653 - SpeakerField in read-only mode:
          Renders speakerReadRow with speakerReadText (read-only Text, not Pressable).
          Name is displayed as non-editable text via Text component (line 633-641).
          Not clickable by default (no onPress on the row).
      VC-044-02:
        status: PASS
        evidence: |
          AgendaForm.tsx:642-646 - Pencil icon rendered when hasSpeaker && !disabled:
          <Pressable hitSlop={12} onPress={handleStartEdit}>
            <Text style={speakerIcon}>{'\u270F'}</Text>
          </Pressable>
          Unicode U+270F is the pencil/edit icon.
      VC-044-03:
        status: PASS
        evidence: |
          AgendaForm.tsx:593-596 - handleStartEdit sets isEditing=true:
          setEditValue(displayName); setIsEditing(true);
          Line 616-630: When isEditing is true, renders TextInput instead of read-only view.
      VC-044-04:
        status: PASS
        evidence: |
          AgendaForm.tsx:618-626 - TextInput in edit mode:
          value={editValue}, onChangeText={setEditValue}, autoFocus.
          On submit/blur, handleSave stores override via onEditOverride(trimmed).
          Lines 598-607: handleSave calls onEditOverride with trimmed value.
      VC-044-05:
        status: PASS
        evidence: |
          AgendaForm.tsx:647-651 - X icon appears when hasOverride && !disabled:
          hasOverride = overrideName !== null && overrideName !== speakerName (line 590).
          <Pressable hitSlop={12} onPress={handleRevert}>
            <Text style={[speakerIcon, {color: colors.error}]}>{'\u2716'}</Text>
          </Pressable>
          Unicode U+2716 is the X icon, rendered in error color (red).
      VC-044-06:
        status: PASS
        evidence: |
          AgendaForm.tsx:609-612 - handleRevert:
          onEditOverride(null); setIsEditing(false);
          This clears the override, restoring original speaker_name from speech record.
          Lines 328,337,381: onEditOverride calls updateField('speaker_N_override', name).
          Setting to null removes override, falling back to speech.speaker_name.
      VC-044-07:
        status: PASS
        evidence: |
          MemberSelectorModal still exists and used for initial speaker assignment.
          SpeakerField now shows read-only with edit icon (for override), but initial
          assignment flow via speeches tab is unchanged.
      VC-044-08:
        status: PASS
        evidence: |
          58 test files, 2923 tests pass. New tests in batch7-f040-f044.test.ts validate
          speaker_override fields in DB type, SpeakerField override rendering, presentation
          mode override usage. No regressions.

  # ---------------------------------------------------------------------------
  # Additional verifications (SPEC acceptance criteria)
  # ---------------------------------------------------------------------------
  spec_verification:
    AC-F040-01: PASS  # pt-BR template has all 6 placeholders
    AC-F040-02: PASS  # DEFAULT_TEMPLATE_EN exists (whatsappUtils.ts:11-12)
    AC-F040-03: PASS  # DEFAULT_TEMPLATE_ES exists (whatsappUtils.ts:14-15)
    AC-F040-04: PASS  # buildWhatsAppUrl uses getDefaultTemplate(language) as fallback (line 90)
    AC-F040-05: PASS  # resolveTemplate replaces all 6 placeholders (lines 49-58)
    AC-F040-06: PASS  # All whatsapp tests pass
    AC-F042-05: PASS  # Multi-select modal stays open (ActorSelector:70 - if !multiSelect then close)
    AC-F042-09: PASS  # Single-select fields unaffected (multiSelect prop only set for recognizing)
    AC-F044-07: PASS  # Override persisted via speaker_N_override fields in sunday_agendas
    AC-F044-08: PASS  # usePresentationMode.ts:135-136,160 uses speaker_N_override ?? speech.speaker_name
    AC-F044-09: PASS  # Pencil icon only shown when hasSpeaker && !disabled (observer check)
    AC-F044-10: PASS  # Empty field shows label as placeholder, no pencil when !hasSpeaker

  # ---------------------------------------------------------------------------
  # DB migration verification
  # ---------------------------------------------------------------------------
  db_migration:
    file: "supabase/migrations/014_add_speaker_overrides.sql"
    verified: true
    fields_added:
      - "speaker_1_override TEXT DEFAULT NULL"
      - "speaker_2_override TEXT DEFAULT NULL"
      - "speaker_3_override TEXT DEFAULT NULL"
    type_updated: "src/types/database.ts:199-201 - speaker_1/2/3_override: string | null"

# #############################################################################
# CR-101: Hide 3 LED status on non-speech Sundays (F045)
# #############################################################################

cr_101:
  cr_id: CR-101
  title: "Hide 3 LED status indicators when Sunday has no speeches"
  type: bugfix
  spec: specs/SPEC_F045_F049.yaml
  qa_plan: qa/QA_PLAN_batch8_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Root cause confirmed: SundayCard.tsx rendered LEDs unconditionally.
      isSpeechesType flag existed but was not used to gate LED rendering.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 2"
    commits:
      - hash: 63a72ea
        message: "fix(sunday-card): conditionally render LEDs only for speeches type (CR-101)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 60
    tester_tests_total: 60
    tester_suite_passed: 2983
    tester_suite_total: 2983

    must_pass_results:
      - id: CR101-MP-01
        description: "SundayCard only renders LEDs when isSpeechesType is true"
        status: PASSED
        evidence: |
          src/components/SundayCard.tsx:322-338: LEDs section wrapped in
          {isSpeechesType && (<View style={styles.leds}>...</View>)}.
          When isSpeechesType is false (non-speech Sundays), no StatusLED renders.

      - id: CR101-MP-02
        description: "Non-speech Sundays show no LEDs in Speeches tab"
        status: PASSED
        evidence: |
          SundayCard.tsx:269: const isSpeechesType = currentType === SUNDAY_TYPE_SPEECHES;
          SundayCard.tsx:266-267: currentType derived from exception?.reason ?? SUNDAY_TYPE_SPEECHES.
          When exception.reason !== 'speeches', isSpeechesType is false, LEDs not rendered.

      - id: CR101-MP-03
        description: "Speech Sundays still show 3 LEDs"
        status: PASSED
        evidence: |
          SundayCard.tsx:322-338: When isSpeechesType is true, the View with
          styles.leds renders 3 StatusLED components via speechStatuses.map().
          Speech status array still computed at lines 272-275 for positions 1, 2, 3.

    must_pass_total: 3
    must_pass_passed: 3

    should_pass_results:
      - id: CR101-SP-01
        description: "Home tab NextSundaysSection inherits LED fix from SundayCard"
        status: PASSED
        evidence: |
          NextSundaysSection.tsx:168 uses <SundayCard> component.
          Fix in SundayCard.tsx propagates automatically. No additional
          changes needed in NextSundaysSection for LED visibility.

    should_pass_total: 1
    should_pass_passed: 1

# #############################################################################
# CR-102: Hide yellow label on contracted card for speech Sundays (F046)
# #############################################################################

cr_102:
  cr_id: CR-102
  title: "Hide yellow exception label on contracted agenda card for speech Sundays"
  type: bugfix
  spec: specs/SPEC_F045_F049.yaml
  qa_plan: qa/QA_PLAN_batch8_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Root cause confirmed: agenda.tsx computed exceptionLabel for ALL exceptions
      including reason='speeches', showing redundant yellow "Discursos" label.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 2"
    commits:
      - hash: 81c4181
        message: "fix(agenda): hide exception label for speeches type sundays (CR-102)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 60
    tester_tests_total: 60
    tester_suite_passed: 2983
    tester_suite_total: 2983

    must_pass_results:
      - id: CR102-MP-01
        description: "Agenda card does not show yellow label for speech Sundays"
        status: PASSED
        evidence: |
          agenda.tsx:265-267:
            const exceptionLabel = (exception && exception.reason !== 'speeches')
              ? t(`sundayExceptions.${exception.reason}`, exception.reason)
              : null;
          When exception.reason === 'speeches', exceptionLabel is null, no label rendered.

      - id: CR102-MP-02
        description: "Non-speech exception Sundays still show yellow label"
        status: PASSED
        evidence: |
          agenda.tsx:265: condition (exception && exception.reason !== 'speeches')
          is true for testimony_meeting, general_conference, stake_conference, etc.
          Lines 292-299 render the yellow label when exceptionLabel is truthy.

    must_pass_total: 2
    must_pass_passed: 2

    should_pass_results:
      - id: CR102-SP-01
        description: "SundayCard in Speeches tab already handles this correctly"
        status: PASSED
        evidence: |
          SundayCard.tsx:308: {!isSpeechesType && (...)} already gates exception
          text rendering. This was correct before CR-102 and remains unchanged.

    should_pass_total: 1
    should_pass_passed: 1

# #############################################################################
# CR-103: WhatsApp template shows old version in settings (F047)
# #############################################################################

cr_103:
  cr_id: CR-103
  title: "WhatsApp settings page shows old template instead of current default"
  type: bugfix
  spec: specs/SPEC_F045_F049.yaml
  qa_plan: qa/QA_PLAN_batch8_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Root cause confirmed: settings/whatsapp.tsx initialized template only
      from DB value, no fallback to getDefaultTemplate() for null DB values.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 2"
    commits:
      - hash: 6ac1c9d
        message: "fix(settings): initialize WhatsApp template with language-aware default fallback (CR-103)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 60
    tester_tests_total: 60
    tester_suite_passed: 2983
    tester_suite_total: 2983

    must_pass_results:
      - id: CR103-MP-01
        description: "Settings page imports getDefaultTemplate from whatsappUtils"
        status: PASSED
        evidence: |
          settings/whatsapp.tsx:18:
            import { getDefaultTemplate } from '../../../lib/whatsappUtils';

      - id: CR103-MP-02
        description: "Settings page falls back to default template when DB is empty"
        status: PASSED
        evidence: |
          settings/whatsapp.tsx:76-86:
            if (ward.whatsapp_template === null || ward.whatsapp_template === undefined) {
              setTemplate(getDefaultTemplate(ward.language ?? 'pt-BR'));
            } else if (ward.whatsapp_template === '') {
              setTemplate('');  // user intentionally cleared
            } else {
              setTemplate(ward.whatsapp_template);  // DB has custom value
            }
          Correctly handles null (default), empty (respected), and custom values.

      - id: CR103-MP-03
        description: "Settings page shows current default, not empty string"
        status: PASSED
        evidence: |
          settings/whatsapp.tsx:62: Query now selects 'whatsapp_template, language'
          (added 'language' to .select()). Line 79: uses ward.language ?? 'pt-BR'
          for getDefaultTemplate fallback. Template state never starts as ''
          when DB has null (uses default template instead).

    must_pass_total: 3
    must_pass_passed: 3

    should_pass_results:
      - id: CR103-SP-01
        description: "Preview section reflects the correct template"
        status: PASSED
        evidence: |
          settings/whatsapp.tsx:124: const preview = resolveTemplate(template);
          Since template is now correctly initialized with the default template
          (when DB is null), preview shows the correct resolved content.

    should_pass_total: 1
    should_pass_passed: 1

# #############################################################################
# CR-104: WhatsApp template missing quotes, collection name, link (F048)
# #############################################################################

cr_104:
  cr_id: CR-104
  title: "WhatsApp message missing quotes around title, collection name, and link"
  type: bugfix
  spec: specs/SPEC_F045_F049.yaml
  qa_plan: qa/QA_PLAN_batch8_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Root cause confirmed: WhatsAppVariables missing collection/link fields,
      and templates missing quotes around {titulo}.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 2"
    commits:
      - hash: 0ccc825
        message: "fix(whatsapp): add quotes around {titulo} placeholder in default templates (CR-104)"
      - hash: 8e2cc8f
        message: "fix(invite): add collection/link vars and human-readable date to WhatsApp message (CR-104, CR-108)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 60
    tester_tests_total: 60
    tester_suite_passed: 2983
    tester_suite_total: 2983

    must_pass_results:
      - id: CR104-MP-01
        description: "InviteManagementSection passes collection to WhatsApp variables"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:69: collection: speech.topic_collection ?? '',
          InviteManagementSection.tsx:103: collection: speech.topic_collection ?? '',
          Both handleNotInvitedAction and handleInvitedAction include collection.

      - id: CR104-MP-02
        description: "InviteManagementSection passes link to WhatsApp variables"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:70: link: speech.topic_link ?? '',
          InviteManagementSection.tsx:104: link: speech.topic_link ?? '',
          Both handlers include link in the WhatsAppVariables object.

      - id: CR104-MP-03
        description: "Default templates have quotes around {titulo}"
        status: PASSED
        evidence: |
          whatsappUtils.ts:9: DEFAULT_TEMPLATE_PT_BR contains '"{titulo}"'
            '...com o ttulo "{titulo}" {link}...'
          whatsappUtils.ts:12: DEFAULT_TEMPLATE_EN contains '"{titulo}"'
            '...titled "{titulo}" {link}...'
          whatsappUtils.ts:15: DEFAULT_TEMPLATE_ES contains '"{titulo}"'
            '...con el titulo "{titulo}" {link}...'
          All 3 templates have double quotes around {titulo}.

    must_pass_total: 3
    must_pass_passed: 3

    should_pass_results:
      - id: CR104-SP-01
        description: "Speech type has topic_collection and topic_link fields"
        status: PASSED
        evidence: |
          src/types/database.ts:141-142:
            topic_link: string | null;
            topic_collection: string | null;
          Both fields exist in the Speech type interface.

    should_pass_total: 1
    should_pass_passed: 1

# #############################################################################
# CR-108: Invite management {data} placeholder locale-aware format (F048)
# #############################################################################

cr_108:
  cr_id: CR-108
  title: "Invite management date placeholder uses locale-aware formatting"
  type: bugfix
  spec: specs/SPEC_F045_F049.yaml
  qa_plan: qa/QA_PLAN_batch8_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Root cause confirmed: formatDate() returned compact "22 FEV" instead
      of locale-aware formatDateHumanReadable().

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 2"
    commits:
      - hash: 8e2cc8f
        message: "fix(invite): add collection/link vars and human-readable date to WhatsApp message (CR-104, CR-108)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 60
    tester_tests_total: 60
    tester_suite_passed: 2983
    tester_suite_total: 2983

    must_pass_results:
      - id: CR108-MP-01
        description: "WhatsApp date uses locale-aware human-readable format"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:66:
            date: formatDateHumanReadable(speech.sunday_date, locale as SupportedLanguage),
          Uses formatDateHumanReadable instead of formatDate. Produces
          "22 de Fevereiro de 2026" (pt-BR) instead of "22 FEV".

      - id: CR108-MP-02
        description: "Both WhatsApp actions use updated date format"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:66: handleNotInvitedAction uses formatDateHumanReadable
          InviteManagementSection.tsx:100: handleInvitedAction uses formatDateHumanReadable
          Both handlers use the locale-aware date format.

    must_pass_total: 2
    must_pass_passed: 2

    should_pass_results:
      - id: CR108-SP-01
        description: "formatDateHumanReadable is imported from dateUtils"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:21:
            import { getNextSundays, toISODateString, formatDate, formatDateHumanReadable } from '../lib/dateUtils';
          formatDateHumanReadable is imported alongside existing imports.

    should_pass_total: 1
    should_pass_passed: 1

# #############################################################################
# CR-109: Home next assignments card expand for speech Sundays (F049)
# #############################################################################

cr_109:
  cr_id: CR-109
  title: "Next Assignments card does not expand to show 3 speeches on speech Sundays"
  type: bugfix
  spec: specs/SPEC_F045_F049.yaml
  qa_plan: qa/QA_PLAN_batch8_phase1.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Root cause confirmed: NextSundaysSection.tsx used !entry.exception
      which is always false after CR-56 auto-assignment. Pattern from
      speeches.tsx needed replication.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "1 of 2"
    commits:
      - hash: 781eb7d
        message: "fix(home): fix SpeechSlots condition to render for speeches type sundays (CR-109)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 60
    tester_tests_total: 60
    tester_suite_passed: 2983
    tester_suite_total: 2983

    must_pass_results:
      - id: CR109-MP-01
        description: "NextSundaysSection renders SpeechSlots for speech Sundays"
        status: PASSED
        evidence: |
          NextSundaysSection.tsx:181:
            (!entry.exception || entry.exception.reason === 'speeches') &&
          Changed from !entry.exception to allow speech Sundays with
          auto-assigned exception entries (reason='speeches').

      - id: CR109-MP-02
        description: "Non-speech Sundays do not show SpeechSlots in NextSundaysSection"
        status: PASSED
        evidence: |
          NextSundaysSection.tsx:181: When entry.exception.reason !== 'speeches'
          (e.g., 'testimony_meeting'), the condition
          (!entry.exception || entry.exception.reason === 'speeches')
          evaluates to false, preventing SpeechSlot rendering.

      - id: CR109-MP-03
        description: "Speeches tab condition remains correct"
        status: PASSED
        evidence: |
          speeches.tsx:276:
            (!exception || exception.reason === 'speeches') &&
          Condition unchanged from pre-validation. Still correctly gates
          SpeechSlot rendering in the Speeches tab.

    must_pass_total: 3
    must_pass_passed: 3

    should_pass_results:
      - id: CR109-SP-01
        description: "NextAssignmentsSection speech slot rendering is appropriate"
        status: PASSED
        evidence: |
          NextAssignmentsSection.tsx:159-173: Renders SpeechSlots unconditionally
          when expanded. This is acceptable because findNextPendingSunday (from
          speechUtils.ts) only returns speech-type Sundays with pending assignments.
          The function filters by entry where speeches need assignment, which
          inherently means speech-type Sundays.

    should_pass_total: 1
    should_pass_passed: 1

# #############################################################################
# BATCH 8 PHASE 2 - PRE-VALIDATION
# CRs: CR-105, CR-106, CR-107, CR-110, CR-111
# Features: F050, F051, F052, F053, F054
# #############################################################################

# #############################################################################
# CR-105: Replace WhatsApp text with icon & status button with three-dots (F050)
# #############################################################################

cr_105:
  cr_id: CR-105
  title: "Replace WhatsApp text button with icon and status button with three-dots"
  type: feature_request
  spec: specs/SPEC_F050.yaml
  qa_plan: qa/QA_PLAN_batch8_phase2.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Confirmed: InviteManagementSection.tsx uses text-based buttons.
      Line 203 renders literal 'WhatsApp' text for not-invited status and
      t('speeches.changeStatus') text for invited status. No icons are used.
      No icon library installed - project uses Unicode/emoji for all icons.
      Feature does not exist. 4 must_pass + 1 should_pass checks planned.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "phase-002"
    verdict: passed

    reviewer_verdict: approved
    tester_verdict: approved
    tester_tests_passed: 3061
    tester_tests_total: 3061

    must_pass_results:
      - id: CR105-VC-01
        description: "WhatsApp button shows WhatsApp icon instead of text 'WhatsApp'"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:37-46 defines WhatsAppIcon component using
          react-native-svg (Svg + Path). Lines 207-208 render <WhatsAppIcon size={18}
          color={colors.onPrimary} /> for isNotInvited branch. No literal 'WhatsApp'
          text appears in the button.

      - id: CR105-VC-02
        description: "Status change button shows three-dots (ellipsis) icon instead of text"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:210-217 renders Unicode '\u22EE' (vertical
          ellipsis) character for invited status. The t('speeches.changeStatus') text
          is no longer rendered in the button. The actionIcon style has fontSize 18.

      - id: CR105-VC-03
        description: "WhatsApp icon button retains original onPress behavior"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:199-203: onPress calls handleNotInvitedAction(speech)
          when isNotInvited is true. handleNotInvitedAction (lines 71-97) still calls
          buildWhatsAppUrl, openWhatsApp, and changeStatus.mutate to 'assigned_invited'.

      - id: CR105-VC-04
        description: "Three-dots button retains status change behavior"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:199-203: onPress calls handleInvitedAction(speech)
          when isNotInvited is false. handleInvitedAction (lines 99-103) sets
          dropdownSpeech state which opens InviteActionDropdown component.

    should_pass_results:
      - id: CR105-VC-05
        description: "Buttons have appropriate accessibility labels"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:204-205: accessibilityRole="button" and
          accessibilityLabel={isNotInvited ? 'WhatsApp' : t('speeches.changeStatus')}
          Both buttons have meaningful labels for screen readers.

    summary: |
      All 4 must_pass and 1 should_pass checks passed. WhatsApp SVG icon replaces
      text, vertical ellipsis replaces status text, behaviors retained, accessibility
      labels present.

# #############################################################################
# CR-106: Replace Alert with custom dropdown for status actions (F051)
# #############################################################################

cr_106:
  cr_id: CR-106
  title: "Replace Alert with custom dropdown for invite status actions"
  type: feature_request
  spec: specs/SPEC_F051.yaml
  qa_plan: qa/QA_PLAN_batch8_phase2.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Confirmed: InviteManagementSection.tsx handleInvitedAction (lines 84-136)
      uses Alert.alert() native dialog with 4 options (WhatsApp, Confirmado,
      Desistiu, Cancelar). User wants custom dropdown with 5 options including
      'Ver conversa' and 'Designado/Nao-Convidado' (reset to not-invited).
      Feature does not exist. 6 must_pass + 1 should_pass checks planned.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "phase-002"
    verdict: passed

    reviewer_verdict: approved
    tester_verdict: approved
    tester_tests_passed: 3061
    tester_tests_total: 3061

    must_pass_results:
      - id: CR106-VC-01
        description: "Alert.alert is no longer used for invited speech status change"
        status: PASSED
        evidence: |
          Grep for 'Alert' in InviteManagementSection.tsx returns 0 matches.
          Alert is NOT imported from react-native (line 9-14: View, Text, StyleSheet,
          Pressable only). handleInvitedAction (lines 99-103) now calls
          setDropdownSpeech(speech) to open the InviteActionDropdown modal component.

      - id: CR106-VC-02
        description: "Custom dropdown contains 'Ver conversa' option"
        status: PASSED
        evidence: |
          InviteActionDropdown.tsx:78-93 renders 'Ver conversa' option with WhatsApp
          icon. Uses t('home.viewConversation') i18n key. pt-BR.json has
          "viewConversation": "Ver conversa", en.json has "View conversation",
          es.json has "Ver conversacion". onPress calls onOpenWhatsApp(speech).

      - id: CR106-VC-03
        description: "Custom dropdown contains 'Designado/Confirmado' option"
        status: PASSED
        evidence: |
          InviteActionDropdown.tsx:96-113 renders option with green indicator
          (STATUS_INDICATOR_COLORS.assigned_confirmed) and label
          t('speechStatus.assigned_confirmed'). onPress calls
          onChangeStatus(speech.id, 'assigned_confirmed').

      - id: CR106-VC-04
        description: "Custom dropdown contains 'Designado/Nao-Convidado' option"
        status: PASSED
        evidence: |
          InviteActionDropdown.tsx:116-133 renders option with yellow indicator
          (STATUS_INDICATOR_COLORS.assigned_not_invited) and label
          t('speechStatus.assigned_not_invited'). onPress calls
          onChangeStatus(speech.id, 'assigned_not_invited'). This is a NEW option
          not present in the old Alert. VALID_TRANSITIONS in useSpeeches.ts line 62
          supports assigned_invited -> assigned_not_invited.

      - id: CR106-VC-05
        description: "Custom dropdown contains 'Desistiu' option"
        status: PASSED
        evidence: |
          InviteActionDropdown.tsx:136-153 renders option with red indicator
          (STATUS_INDICATOR_COLORS.gave_up) and label t('speechStatus.gave_up').
          onPress calls onChangeStatus(speech.id, 'gave_up').

      - id: CR106-VC-06
        description: "Custom dropdown contains 'Cancelar' option (close/dismiss)"
        status: PASSED
        evidence: |
          InviteActionDropdown.tsx:156-163 renders cancel button with
          t('common.cancel') label. onPress calls onClose() which dismisses
          the dropdown without status change. Also, overlay Pressable (line 70)
          onPress={onClose} allows tapping outside to dismiss.

    should_pass_results:
      - id: CR106-VC-07
        description: "Custom dropdown is visually styled (not native Alert)"
        status: PASSED
        evidence: |
          InviteActionDropdown.tsx uses React Native Modal (line 64) with
          transparent background. Content has borderRadius: 12 (line 179),
          backgroundColor: colors.card, elevation: 5, shadow styling (lines 184-187).
          Follows the visual pattern of StatusChangeModal. Imports
          STATUS_INDICATOR_COLORS from StatusChangeModal for consistency.

    summary: |
      All 6 must_pass and 1 should_pass checks passed. Alert.alert completely
      replaced by custom InviteActionDropdown modal. All 5 options present:
      Ver conversa (WhatsApp), Designado/Confirmado, Designado/Nao-Convidado (new),
      Desistiu, Cancelar. VALID_TRANSITIONS updated to support reverse transition.

# #############################################################################
# CR-107: Show speech position + LED + status name in second line (F052)
# #############################################################################

cr_107:
  cr_id: CR-107
  title: "Show speech number with LED and status name in invite card second line"
  type: feature_request
  spec: specs/SPEC_F052.yaml
  qa_plan: qa/QA_PLAN_batch8_phase2.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Confirmed: InviteManagementSection.tsx second line (lines 178-180) only
      shows "{position}o" (e.g. "1o"). No StatusLED component rendered, no
      status name text. User wants "1o Discurso - <LED> <status name>".
      Feature does not exist. 3 must_pass + 1 should_pass checks planned.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "phase-002"
    verdict: passed

    reviewer_verdict: approved
    tester_verdict: approved
    tester_tests_passed: 3061
    tester_tests_total: 3061

    must_pass_results:
      - id: CR107-VC-01
        description: "Second line shows speech position label (e.g. '1o Discurso')"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:179-181 renders speechNum Text with
          t('speeches.slot', { number: `${speech.position}\u00BA` }) which produces
          "1o Discurso", "2o Discurso", etc. using the speeches.slot i18n key.

      - id: CR107-VC-02
        description: "Second line includes StatusLED component"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:21 imports StatusLED from './StatusLED'.
          Line 185 renders <StatusLED status={speech.status} size={10} /> inline
          in the speechInfoRow View (flexDirection: 'row', alignItems: 'center').
          Size is 10px, appropriate for inline text rendering.

      - id: CR107-VC-03
        description: "Second line includes translated status name"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:186-188 renders a Text with
          t(`speechStatus.${speech.status}`) which provides the translated
          status name (e.g. "Designado/Nao convidado" for assigned_not_invited).
          The statusName style has fontSize: 12 and flex: 1.

    should_pass_results:
      - id: CR107-VC-04
        description: "Format matches requested pattern: 'No Discurso - LED StatusName'"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:178-189 renders speechInfoRow View with:
          1. Text with slot label (e.g. "1o Discurso")
          2. Text with ' - ' separator (lines 182-184)
          3. StatusLED size={10} (line 185)
          4. Text with ' ' + translated status name (lines 186-188)
          All in flexDirection: 'row' with alignItems: 'center'. The full
          rendering is: "1o Discurso - [LED] Designado/Nao convidado".

    summary: |
      All 3 must_pass and 1 should_pass checks passed. Second line now shows
      full slot label + separator + StatusLED inline + translated status name.

# #############################################################################
# CR-110: Show invite management for bishopric role (F053)
# #############################################################################

cr_110:
  cr_id: CR-110
  title: "Show invite management section for bishopric role"
  type: feature_request
  spec: specs/SPEC_F053.yaml
  qa_plan: qa/QA_PLAN_batch8_phase2.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Confirmed: InviteManagementSection.tsx line 139 guards with
      hasPermission('home:invite_mgmt'). In permissions.ts, bishopric role
      (lines 16-40) does NOT have 'home:invite_mgmt'. Only secretary (line 56)
      has it. Bishopric has 'invite:manage' but not 'home:invite_mgmt'.
      Feature does not exist. 3 must_pass + 1 should_pass checks planned.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "phase-002"
    verdict: passed

    reviewer_verdict: approved
    tester_verdict: approved
    tester_tests_passed: 3061
    tester_tests_total: 3061

    must_pass_results:
      - id: CR110-VC-01
        description: "Bishopric role has 'home:invite_mgmt' permission"
        status: PASSED
        evidence: |
          permissions.ts:16-41 defines bishopric role permissions. Line 33
          contains 'home:invite_mgmt' in the Set. This permission was added
          between 'home:next_assignments' (line 32) and 'agenda:read' (line 34).

      - id: CR110-VC-02
        description: "InviteManagementSection permission guard still works for both roles"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:139 still uses:
          if (!hasPermission('home:invite_mgmt')) return null;
          This guard now passes for both bishopric (line 33 in permissions.ts)
          and secretary (line 57 in permissions.ts) since both have the permission.

      - id: CR110-VC-03
        description: "Observer role still cannot see invite management section"
        status: PASSED
        evidence: |
          permissions.ts:67-71 defines observer role with only 3 permissions:
          'member:read', 'agenda:read', 'presentation:start'. The observer Set
          does NOT include 'home:invite_mgmt'. hasPermission('observer',
          'home:invite_mgmt') returns false.

    should_pass_results:
      - id: CR110-VC-04
        description: "Existing permission tests still pass"
        status: PASSED
        evidence: |
          All 3061 tests pass across 60 test files including permissions.test.ts.
          The permission test file was updated with batch8-phase2 tests that
          verify bishopric has 'home:invite_mgmt', secretary retains it, and
          observer does not have it.

    summary: |
      All 3 must_pass and 1 should_pass checks passed. Bishopric role now has
      'home:invite_mgmt' permission. Both bishopric and secretary see the invite
      management section. Observer remains excluded.

# #############################################################################
# CR-111: Increase LED-X spacing and X icon size in expanded card (F054)
# #############################################################################

cr_111:
  cr_id: CR-111
  title: "Increase spacing between LED and X button, increase X icon size"
  type: feature_request
  spec: specs/SPEC_F054.yaml
  qa_plan: qa/QA_PLAN_batch8_phase2.yaml

  pre_validation:
    timestamp: "2026-02-18"
    status: passed
    summary: |
      Confirmed: SpeechSlot.tsx row style has gap: 8 (line 229) between all
      items (speaker field, LED, X button). X button fontSize is 20, fontWeight
      300, paddingHorizontal 4 (lines 248-252). User wants more spacing between
      LED and X, and larger X icon. Feature does not exist.
      2 must_pass + 2 should_pass checks planned.

  post_validation:
    timestamp: "2026-02-18"
    status: passed
    phase: "phase-002"
    verdict: passed

    reviewer_verdict: approved
    tester_verdict: approved
    tester_tests_passed: 3061
    tester_tests_total: 3061

    must_pass_results:
      - id: CR111-VC-01
        description: "Gap between LED and X button is increased"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:229 row style now has gap: 12 (was 8). This increases
          spacing between all row elements including LED and X button from 8px
          to 12px, a 50% increase.

      - id: CR111-VC-02
        description: "X icon size is increased"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:249 removeButton style now has fontSize: 24 (was 20).
          The X icon character ('\u00D7') is rendered at 24px, 20% larger than
          before.

    should_pass_results:
      - id: CR111-VC-03
        description: "X button hitSlop is still adequate for touch target"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:168 Pressable wrapping the X button still has hitSlop={8}.
          Combined with the larger fontSize (24) and paddingHorizontal: 4 (line 251),
          the touch target is adequate.

      - id: CR111-VC-04
        description: "Layout does not break with increased spacing"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:231-232 field style retains flex: 1 which allows the
          speaker name text field to shrink/grow. The increased gap (12) and
          larger X icon (24) do not cause layout issues since the speaker
          field accommodates via flex and numberOfLines={1} truncation.

    summary: |
      All 2 must_pass and 2 should_pass checks passed. Row gap increased from
      8 to 12, X fontSize increased from 20 to 24. Touch target and layout
      remain functional.

# #############################################################################
# CR-112: Ver Conversa without resending invite (F055)
# #############################################################################

cr_112:
  cr_id: CR-112
  title: "Ver Conversa should open WhatsApp conversation without resending invite message"
  type: bugfix
  spec: specs/SPEC_F055_F059.yaml
  qa_plan: qa/QA_PLAN_batch9_phase1.yaml

  pre_validation:
    timestamp: "2026-02-19"
    status: passed
    summary: |
      Root cause confirmed: handleDropdownWhatsApp calls buildWhatsAppUrl()
      with full template variables, generating wa.me URL with ?text= message.
      Should open conversation-only URL without message text.

  post_validation:
    timestamp: "2026-02-19"
    status: passed
    phase: "1 of 3"
    commits:
      - hash: 3160210
        message: "feat(whatsapp): add buildWhatsAppConversationUrl for opening chat without message (CR-112)"
      - hash: 6ff6d4c
        message: "fix(invite): use buildWhatsAppConversationUrl for View Conversation action (CR-112)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 67
    tester_tests_total: 67
    tester_suite_passed: 3128
    tester_suite_total: 3128

    must_pass_results:
      - id: CR112-MP-01
        description: "handleDropdownWhatsApp opens WhatsApp WITHOUT invite message"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:106-115 handleDropdownWhatsApp now calls
          buildWhatsAppConversationUrl(speech.speaker_phone) instead of
          buildWhatsAppUrl() with template variables.

      - id: CR112-MP-02
        description: "handleNotInvitedAction still sends invite message (unchanged)"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:71-97 handleNotInvitedAction still calls
          buildWhatsAppUrl() with full template variables (speakerName, date,
          topic, position, collection, link). Unchanged from baseline.

      - id: CR112-MP-03
        description: "WhatsApp conversation URL has no text parameter"
        status: PASSED
        evidence: |
          whatsappUtils.ts:101-111 buildWhatsAppConversationUrl returns
          `https://wa.me/${cleanPhone}` without any ?text= query parameter.

    should_pass_results:
      - id: CR112-SP-01
        description: "Phone number is properly cleaned for wa.me URL"
        status: PASSED
        evidence: |
          whatsappUtils.ts:103-108 buildWhatsAppConversationUrl cleans phone:
          removes spaces/dashes/parentheses via regex, strips leading +.
          Same cleaning logic as buildWhatsAppUrl.

    summary: |
      All 3 must_pass and 1 should_pass checks passed. New function
      buildWhatsAppConversationUrl added to whatsappUtils.ts. handleDropdownWhatsApp
      now opens conversation without pre-filled message. Initial invite flow unchanged.

# #############################################################################
# CR-113: Dialog title "Alterar status" i18n (F056)
# #############################################################################

cr_113:
  cr_id: CR-113
  title: "Change InviteActionDropdown title from speaker name to i18n changeStatus"
  type: ui_change
  spec: specs/SPEC_F055_F059.yaml
  qa_plan: qa/QA_PLAN_batch9_phase1.yaml

  pre_validation:
    timestamp: "2026-02-19"
    status: passed
    summary: |
      Root cause confirmed: InviteActionDropdown.tsx:73-75 showed speaker name
      as title. i18n keys speeches.changeStatus already exist in all 3 locales.

  post_validation:
    timestamp: "2026-02-19"
    status: passed
    phase: "1 of 3"
    commits:
      - hash: cf1c8cf
        message: "fix(invite): change InviteActionDropdown title to i18n changeStatus label (CR-113)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 67
    tester_tests_total: 67
    tester_suite_passed: 3128
    tester_suite_total: 3128

    must_pass_results:
      - id: CR113-MP-01
        description: "Dialog title uses i18n key instead of speaker name"
        status: PASSED
        evidence: |
          InviteActionDropdown.tsx:73-75 now shows {t('speeches.changeStatus')}
          instead of {speech?.speaker_name ?? ''}.

      - id: CR113-MP-02
        description: "i18n keys exist for all 3 locales"
        status: PASSED
        evidence: |
          pt-BR.json:187 "changeStatus": "Alterar status"
          en.json:187 "changeStatus": "Change status"
          es.json:187 "changeStatus": "Cambiar estado"

    should_pass_results:
      - id: CR113-SP-01
        description: "Speaker name is not displayed anywhere in dialog title"
        status: PASSED
        evidence: |
          InviteActionDropdown.tsx title Text element has no reference to
          speech?.speaker_name. Only {t('speeches.changeStatus')} is used.

    summary: |
      All 2 must_pass and 1 should_pass checks passed. Title changed from
      speaker name to i18n changeStatus key. No new i18n keys needed.

# #############################################################################
# CR-117: +1 country code shows Canada instead of USA (F057)
# #############################################################################

cr_117:
  cr_id: CR-117
  title: "Fix +1 country code showing Canada flag instead of USA flag"
  type: bugfix
  spec: specs/SPEC_F055_F059.yaml
  qa_plan: qa/QA_PLAN_batch9_phase1.yaml

  pre_validation:
    timestamp: "2026-02-19"
    status: passed
    summary: |
      Root cause confirmed: Canada (+1) listed before USA (+1) in alphabetical
      order. getFlagForCode uses .find() returning first match. Picker highlights
      both countries sharing code.

  post_validation:
    timestamp: "2026-02-19"
    status: passed
    phase: "1 of 3"
    commits:
      - hash: 017b7a5
        message: "fix(country): reorder USA before Canada for +1 default and add getCountryByLabel (CR-117)"
      - hash: fe1bfba
        message: "fix(members): highlight country by label instead of code to resolve +1 ambiguity (CR-117)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 67
    tester_tests_total: 67
    tester_suite_passed: 3128
    tester_suite_total: 3128

    must_pass_results:
      - id: CR117-MP-01
        description: "+1 country code shows USA flag by default"
        status: PASSED
        evidence: |
          countryCodes.ts:47 USA is now listed BEFORE Canada (line 48).
          getFlagForCode('+1') uses .find() and returns USA flag first.
          Comment on line 46: "USA before Canada: +1 defaults to US flag (ADR-043)".

      - id: CR117-MP-02
        description: "Country picker does not highlight both CA and US simultaneously"
        status: PASSED
        evidence: |
          members.tsx:154 now uses item.label === countryLabel for highlighting
          instead of item.code === countryCode. Since labels are unique
          ("United States (+1)" vs "Canada (+1)"), only selected country highlights.

      - id: CR117-MP-03
        description: "Selecting USA persists USA selection (not reverted to Canada)"
        status: PASSED
        evidence: |
          members.tsx:157-158 setCountryCode(item.code) + setCountryLabel(item.label)
          stores both code and label. countryLabel state (line 58) initialized from
          COUNTRY_CODES.find() which now returns USA first for +1. Flag display
          (line 98) uses getFlagForCode(countryCode) which returns USA flag.

    should_pass_results:
      - id: CR117-SP-01
        description: "Other shared codes (+7 RU/KZ, etc.) also work correctly"
        status: PASSED
        evidence: |
          countryCodes.ts:100 Kazakhstan (+7) listed before Russia (+7, line 151).
          Same label-based highlighting in picker applies. Labels are unique
          ("Kazakhstan (+7)" vs "Russia (+7)").

      - id: CR117-SP-02
        description: "splitPhoneNumber still works for +1 numbers"
        status: PASSED
        evidence: |
          splitPhoneNumber uses CODE_SETS_BY_LENGTH built from Sets (deduplicates).
          Reordering does not affect Set membership. splitPhoneNumber('+12025551234')
          correctly returns { countryCode: '+1', phone: '2025551234' }.

    summary: |
      All 3 must_pass and 2 should_pass checks passed. USA reordered before
      Canada in COUNTRY_CODES. New getCountryByLabel helper added. Picker
      highlights by unique label instead of ambiguous code. splitPhoneNumber
      unaffected.

# #############################################################################
# CR-122: 3o Discurso -> Ultimo Discurso (F058)
# #############################################################################

cr_122:
  cr_id: CR-122
  title: "Change third speech label from ordinal to 'Ultimo Discurso' (Last Speech)"
  type: ui_change
  spec: specs/SPEC_F055_F059.yaml
  qa_plan: qa/QA_PLAN_batch9_phase1.yaml

  pre_validation:
    timestamp: "2026-02-19"
    status: passed
    summary: |
      Root cause confirmed: getPositionLabel() always uses ordinal format.
      No special case for position 3. Affects SpeechSlot, AgendaForm,
      InviteManagementSection.

  post_validation:
    timestamp: "2026-02-19"
    status: passed
    phase: "1 of 3"
    commits:
      - hash: 0005ea6
        message: "feat(i18n): add speeches.lastSpeech key and update 4 locations for position 3 (CR-122)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 67
    tester_tests_total: 67
    tester_suite_passed: 3128
    tester_suite_total: 3128

    must_pass_results:
      - id: CR122-MP-01
        description: "Position 3 label shows 'Ultimo Discurso' / 'Last Speech'"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:51-57 getPositionLabel now has special case:
          if (position === 3) return t('speeches.lastSpeech');
          Falls through to ordinal format for other positions.

      - id: CR122-MP-02
        description: "Positions 1 and 2 still use ordinal labels"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:56 for positions != 3, returns
          t('speeches.slot', { number: `${position}\u00BA` }).
          Produces "1o Discurso", "2o Discurso" as before.

      - id: CR122-MP-03
        description: "AgendaForm 3rd speaker label uses 'Ultimo' instead of '3o'"
        status: PASSED
        evidence: |
          AgendaForm.tsx:378 now uses
          `${t('speeches.lastSpeech')} - ${t('speeches.speaker')}`
          instead of `3\u00BA ${t('speeches.speaker')}`.

      - id: CR122-MP-04
        description: "InviteManagement also uses 'Ultimo' for position 3"
        status: PASSED
        evidence: |
          InviteManagementSection.tsx:167 uses conditional:
          speech.position === 3
            ? t('speeches.lastSpeech')
            : t('speeches.slot', { number: `${speech.position}\u00BA` })

      - id: CR122-MP-05
        description: "i18n keys exist for all 3 locales"
        status: PASSED
        evidence: |
          pt-BR.json:193 "lastSpeech": "Ultimo Discurso"
          en.json:193 "lastSpeech": "Final Speech"
          es.json:193 "lastSpeech": "Ultimo Discurso"

    should_pass_results:
      - id: CR122-SP-01
        description: "Presentation mode also uses 'Ultimo' for last speech"
        status: PASSED
        evidence: |
          usePresentationMode.ts:162 already uses
          t('speeches.lastSpeech') - ${t('speeches.speaker')} for position 3.

    summary: |
      All 5 must_pass and 1 should_pass checks passed. New i18n key
      speeches.lastSpeech added to all 3 locales. Updated in 4 locations:
      SpeechSlot, AgendaForm, InviteManagementSection, usePresentationMode.

# #############################################################################
# CR-125: Bug duplicacao oracao de encerramento (F059)
# #############################################################################

cr_125:
  cr_id: CR-125
  title: "Fix closing prayer field visual duplication in AgendaForm"
  type: bugfix
  spec: specs/SPEC_F055_F059.yaml
  qa_plan: qa/QA_PLAN_batch9_phase1.yaml

  pre_validation:
    timestamp: "2026-02-19"
    status: passed
    summary: |
      Root cause confirmed: PrayerSelector renders inline Pressable button
      alongside Modal when used in controlled mode from AgendaForm. This causes
      visual duplication of the prayer field.

  post_validation:
    timestamp: "2026-02-19"
    status: passed
    phase: "1 of 3"
    commits:
      - hash: d3ec6a6
        message: "feat(prayer): add modalOnly prop to PrayerSelector to suppress inline button (CR-125)"
      - hash: abfda79
        message: "fix(agenda): pass modalOnly={true} to PrayerSelector to fix field duplication (CR-125)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 67
    tester_tests_total: 67
    tester_suite_passed: 3128
    tester_suite_total: 3128

    must_pass_results:
      - id: CR125-MP-01
        description: "No visual duplication when closing prayer field is tapped"
        status: PASSED
        evidence: |
          PrayerSelector.tsx:96 wraps inline Pressable with {!modalOnly && (...)}.
          When modalOnly={true}, the inline selector button is not rendered.
          Only the Modal (lines 122-207) renders.

      - id: CR125-MP-02
        description: "Only one search modal opens on tap"
        status: PASSED
        evidence: |
          AgendaForm.tsx:483 passes modalOnly={true} to PrayerSelector.
          Only PrayerSelector's Modal renders (no duplicate inline button).
          The original SelectorField (lines 424-436) remains as the trigger.

      - id: CR125-MP-03
        description: "Opening prayer also fixed (same pattern)"
        status: PASSED
        evidence: |
          AgendaForm.tsx:480-507 renders a single PrayerSelector for both
          opening_prayer and closing_prayer via selectorModal.field. Both
          use modalOnly={true} via the same render block.

      - id: CR125-MP-04
        description: "PrayerSelector standalone usage still works"
        status: PASSED
        evidence: |
          PrayerSelector.tsx:55 defaults modalOnly = false. Without the prop,
          the inline Pressable button renders normally at lines 97-120.
          Standalone usage is preserved.

    should_pass_results:
      - id: CR125-SP-01
        description: "Modal closes properly and state resets"
        status: PASSED
        evidence: |
          PrayerSelector.tsx:126 onRequestClose calls setModalVisible(false)
          and onClose?(). Lines 144-148 cancel button resets search and
          customName state. AgendaForm.tsx:484 onClose sets
          setSelectorModal(null).

    summary: |
      All 4 must_pass and 1 should_pass checks passed. New modalOnly prop
      added to PrayerSelector. AgendaForm passes modalOnly={true} to suppress
      inline button. Standalone PrayerSelector usage preserved.

# #############################################################################
# CR-114: Adicionar X ao lado do campo de temas para remover tema (F060)
# #############################################################################

cr_114:
  cr_id: CR-114
  title: "Add X button next to topic field to remove assigned topic"
  type: feature_request
  spec: specs/SPEC_F060_F064.yaml
  qa_plan: qa/QA_PLAN_batch9_phase2.yaml

  pre_validation:
    timestamp: "2026-02-19"
    status: passed
    summary: |
      Feature does not exist. SpeechSlot.tsx renders topic field (lines 183-204)
      with no X/clear button. Speaker row has X (lines 167-179) but topic row
      does not. No onClearTopic or onRemoveTopic callback exists. QA plan created
      with 5 validation checks (4 must_pass, 1 should_pass).

  post_validation:
    timestamp: "2026-02-19"
    status: passed
    phase: "2 of 3"
    commits:
      - hash: 5500894
        message: "feat(speech-slot): add onClearTopic prop and X button to topic field (CR-114)"
      - hash: 6d80369
        message: "feat(speeches): wire onClearTopic in speeches.tsx and NextSundaysSection (CR-114)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 3216
    tester_tests_total: 3216
    tester_suite_passed: 3216
    tester_suite_total: 3216

    must_pass_results:
      - id: CR114-VC-01
        description: "X button appears next to topic field when a topic is assigned"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:212-220 renders a Pressable with X (U+00D7) inside the topicField,
          conditionally: {topicDisplay && canAssign && (<Pressable onPress={handleClearTopic}>...)}.
          X only appears when topicDisplay is truthy (topic_title exists) AND canAssign is true.

      - id: CR114-VC-02
        description: "Pressing the X button clears the topic assignment"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:125-128 handleClearTopic calls onClearTopic?.(speech.id).
          speeches.tsx:216-226 handleClearTopic calls assignTopic.mutate({speechId, topicTitle: null,
          topicLink: null, topicCollection: null}). All 3 fields cleared.
          NextSundaysSection.tsx:128-138 has identical wiring.

      - id: CR114-VC-04
        description: "X button respects permission checks (Bishopric only)"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:212 condition is {topicDisplay && canAssign && (...)}.
          canAssign = hasPermission('speech:assign') (line 80). Observers and Secretary
          do not have speech:assign permission, so X is not rendered for them.

      - id: CR114-VC-05
        description: "Existing topic assignment flow still works"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:196-226 topic field Pressable with onPress={handleTopicPress} is unchanged.
          handleTopicPress (line 94-97) calls onOpenTopicSelector. The X button is a separate
          Pressable inside the topicField, not replacing the field press handler.

    should_pass_results:
      - id: CR114-VC-03
        description: "Confirmation dialog shown before clearing topic"
        status: PASSED
        evidence: |
          No confirmation dialog is used. Per SPEC ASM-F060-01, this is intentional:
          topic can be easily re-assigned via TopicSelectorModal (unlike speaker which
          has invite lifecycle). Direct removal without confirmation is the designed behavior.

# #############################################################################
# CR-115: Confirmacao ao mudar tipo de domingo (F061)
# #############################################################################

cr_115:
  cr_id: CR-115
  title: "Show confirmation dialog when changing sunday type with assigned speakers/topics"
  type: feature_request
  spec: specs/SPEC_F060_F064.yaml
  qa_plan: qa/QA_PLAN_batch9_phase2.yaml

  pre_validation:
    timestamp: "2026-02-19"
    status: passed
    summary: |
      Feature does not exist. SundayTypeDropdown.handleSelect (SundayCard.tsx:104-116)
      immediately calls onSelect/onRevertToSpeeches with NO confirmation dialog.
      No Alert.alert or confirmation Modal before type change. Changing from 'speeches'
      to another type orphans assigned speeches without warning. QA plan created
      with 6 validation checks (5 must_pass, 1 should_pass).

  post_validation:
    timestamp: "2026-02-19"
    status: passed
    phase: "2 of 3"
    commits:
      - hash: c95e1d3
        message: "feat(sunday-card): add confirmation dialog when changing type with assignments (CR-115)"
      - hash: 8ec4f3a
        message: "feat(i18n): add changeConfirmTitle/Message and lastMinuteAssignment keys in 3 locales (CR-115, CR-121)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 3216
    tester_tests_total: 3216
    tester_suite_passed: 3216
    tester_suite_total: 3216

    must_pass_results:
      - id: CR115-VC-01
        description: "Confirmation dialog shown when changing FROM 'speeches' type with assigned speakers/topics"
        status: PASSED
        evidence: |
          SundayCard.tsx:113 const hasAssignments = speeches.some(s => !!s.speaker_name || !!s.topic_title);
          SundayCard.tsx:114 if (currentType === SUNDAY_TYPE_SPEECHES && hasAssignments) {
          SundayCard.tsx:115-133 Alert.alert with changeConfirmTitle/changeConfirmMessage is shown.
          Confirmation fires only when changing FROM speeches AND assignments exist.

      - id: CR115-VC-02
        description: "No confirmation when changing type with NO assigned speakers/topics"
        status: PASSED
        evidence: |
          SundayCard.tsx:114 condition requires hasAssignments to be true.
          If speeches.some(s => !!s.speaker_name || !!s.topic_title) is false,
          the code falls through to line 136-141 which proceeds directly
          (either opens 'other' modal or calls onSelect immediately).

      - id: CR115-VC-03
        description: "Cancel in confirmation dialog does NOT change the type"
        status: PASSED
        evidence: |
          SundayCard.tsx:119 first button in Alert.alert is
          { text: t('common.cancel'), style: 'cancel' } with no onPress handler.
          Cancel simply dismisses the alert without calling onSelect or onRevertToSpeeches.

      - id: CR115-VC-04
        description: "Confirm in dialog proceeds with the type change"
        status: PASSED
        evidence: |
          SundayCard.tsx:120-131 second button has style: 'destructive' and onPress
          that either opens 'other' modal (type === 'other') or calls
          onSelect(type as SundayExceptionReason). This correctly proceeds with the change.

      - id: CR115-VC-05
        description: "SundayCard receives speeches data to check for assignments"
        status: PASSED
        evidence: |
          SundayCard.tsx:91 SundayTypeDropdownProps includes speeches: Speech[].
          SundayCard.tsx:94 function SundayTypeDropdown destructures speeches.
          SundayCard.tsx:375 <SundayTypeDropdown speeches={speeches} /> passes the prop.
          SundayCardProps already had speeches: Speech[] (line 35).

    should_pass_results:
      - id: CR115-VC-06
        description: "Changing FROM a non-speech type to speeches does not show confirmation"
        status: PASSED
        evidence: |
          SundayCard.tsx:108-110 if (type === SUNDAY_TYPE_SPEECHES) { onRevertToSpeeches(); return; }
          This early return bypasses the confirmation check entirely.
          Reverting to speeches type proceeds directly.

# #############################################################################
# CR-116: Clicar no LED mostra opcoes confirmado e desistiu (F062)
# #############################################################################

cr_116:
  cr_id: CR-116
  title: "Clicking on LED shows confirmed and gave_up options directly"
  type: feature_request
  spec: specs/SPEC_F060_F064.yaml
  qa_plan: qa/QA_PLAN_batch9_phase2.yaml

  pre_validation:
    timestamp: "2026-02-19"
    status: passed
    summary: |
      Feature does not exist. StatusLED.onPress triggers StatusChangeModal which
      shows ALL valid transitions (getAvailableStatuses). From assigned_invited,
      it shows 4 options: assigned_confirmed, assigned_not_invited, gave_up,
      not_assigned. No filtering to show only confirmed/gave_up on LED click.
      QA plan created with 5 validation checks (4 must_pass, 1 should_pass).

  post_validation:
    timestamp: "2026-02-19"
    status: passed
    phase: "2 of 3"
    commits:
      - hash: 429915d
        message: "feat(status-modal): add optional allowedStatuses prop for filtering transitions (CR-116)"
      - hash: 97e8725
        message: "feat(speech-slot): filter LED click to confirmed/gave_up for assigned_invited (CR-116)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 3216
    tester_tests_total: 3216
    tester_suite_passed: 3216
    tester_suite_total: 3216

    must_pass_results:
      - id: CR116-VC-01
        description: "LED click shows only 'confirmed' and 'gave up' options for assigned_invited"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:138-140 const ledAllowedStatuses = status === 'assigned_invited'
            ? ['assigned_confirmed', 'gave_up'] as SpeechStatus[] : undefined;
          SpeechSlot.tsx:234 <StatusChangeModal allowedStatuses={ledAllowedStatuses} />
          StatusChangeModal.tsx:59-61 const filtered = allowedStatuses
            ? availableStatuses.filter(s => allowedStatuses.includes(s)) : availableStatuses;
          For assigned_invited: availableStatuses = [assigned_confirmed, assigned_not_invited,
          gave_up, not_assigned]. After filter: [assigned_confirmed, gave_up]. Correct.

      - id: CR116-VC-03
        description: "LED click works correctly for assigned_not_invited status"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:138-140 ledAllowedStatuses is undefined when status !== 'assigned_invited'.
          For assigned_not_invited, allowedStatuses is undefined, so StatusChangeModal.tsx:59-61
          uses the unfiltered availableStatuses: [assigned_invited, not_assigned]. All transitions shown.

      - id: CR116-VC-04
        description: "StatusChangeModal integration with i18n labels"
        status: PASSED
        evidence: |
          StatusChangeModal.tsx:63-68 getStatusLabel uses t(`speechStatus.${status}`, status).
          i18n keys speechStatus.assigned_confirmed and speechStatus.gave_up exist in all 3 locales
          (these are pre-existing keys from the original status implementation, not new).

      - id: CR116-VC-05
        description: "LED remains non-interactive for not_assigned status"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:153 disabled={isObserver || status === 'not_assigned'}.
          StatusLED disabled prop prevents onPress from firing when not_assigned.

    should_pass_results:
      - id: CR116-VC-02
        description: "Full status change modal still accessible via alternative interaction"
        status: PASSED
        evidence: |
          StatusChangeModal.tsx:33 allowedStatuses is optional prop (allowedStatuses?: SpeechStatus[]).
          When not passed (e.g., from InviteActionDropdown or other contexts), all transitions
          are shown. The filtering only applies when SpeechSlot passes the prop for assigned_invited.
          For other statuses (assigned_not_invited, assigned_confirmed, gave_up), SpeechSlot
          passes undefined, so full transitions are shown.

# #############################################################################
# CR-119: Redesign dos cards de designacao de discursos (F063)
# #############################################################################

cr_119:
  cr_id: CR-119
  title: "Redesign speech card layout (LED left, X right, same component)"
  type: feature_request
  spec: specs/SPEC_F060_F064.yaml
  qa_plan: qa/QA_PLAN_batch9_phase2.yaml

  pre_validation:
    timestamp: "2026-02-19"
    status: passed
    summary: |
      Layout needs change. Current SpeechSlot.tsx row order is:
      [Speaker Field] [LED] [X]. User wants [LED] [Speaker Field] [X].
      JSX render order (lines 134-180): Pressable(field) -> StatusLED -> Pressable(X).
      All 3 positions already use same SpeechSlot component. QA plan created
      with 6 validation checks (5 must_pass, 1 should_pass).

  post_validation:
    timestamp: "2026-02-19"
    status: passed
    phase: "2 of 3"
    commits:
      - hash: ec285bd
        message: "feat(speech-slot): reorder layout to [LED][Field][X] and align topic field (CR-119)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 3216
    tester_tests_total: 3216
    tester_suite_passed: 3216
    tester_suite_total: 3216

    must_pass_results:
      - id: CR119-VC-01
        description: "LED is positioned on the LEFT side of the speech card row"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:147-193 View(styles.row) children order:
          1. StatusLED (line 149-154) - FIRST element
          2. Pressable(styles.field) speaker field (line 157-178) - SECOND
          3. Pressable remove button X (line 181-192) - THIRD
          Layout is [LED] [Speaker Field] [X]. Correct.

      - id: CR119-VC-02
        description: "X button remains on the RIGHT side of the speech card row"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:181-192 Remove button (X) is the last element in styles.row.
          Conditional render: {hasSpeaker && canUnassign && (...)}.

      - id: CR119-VC-03
        description: "All 3 speech positions use the same component layout"
        status: PASSED
        evidence: |
          SpeechSlot is a single component parameterized by position (1, 2, 3).
          speeches.tsx:290-302 renders SpeechSlot for positions [1, 2, 3].
          NextSundaysSection.tsx:194-206 renders same SpeechSlot for positions [1, 2, 3].
          No position-specific rendering differences in the card structure.

      - id: CR119-VC-04
        description: "LED is still functional (pressable for status change)"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:152 onPress={handleStatusPress}.
          handleStatusPress (line 99-102) calls setStatusModalVisible(true).
          StatusChangeModal (line 229-235) wired with visible={statusModalVisible}.

      - id: CR119-VC-05
        description: "Speaker field still fills available space (flex:1)"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:257-265 styles.field has flex: 1.
          Speaker field Pressable at line 158 uses style={[styles.field, ...]}.

    should_pass_results:
      - id: CR119-VC-06
        description: "Topic field layout is not broken by the row reorder"
        status: PASSED
        evidence: |
          SpeechSlot.tsx:196-226 topic field (styles.topicField) renders below the speaker row.
          styles.topicField (line 279-288) has marginLeft: 28 (LED 16px + gap 12px = 28px)
          to align topic text start with speaker text start. marginTop: 6 provides spacing.

# #############################################################################
# CR-121: Label "(Designacao de ultima hora)" na agenda (F064)
# #############################################################################

cr_121:
  cr_id: CR-121
  title: "Show last-minute assignment label when speaker is overridden in agenda"
  type: feature_request
  spec: specs/SPEC_F060_F064.yaml
  qa_plan: qa/QA_PLAN_batch9_phase2.yaml

  pre_validation:
    timestamp: "2026-02-19"
    status: passed
    summary: |
      Feature does not exist. AgendaForm.tsx SpeakerField (lines 572-657) shows
      speaker name with override mechanism but no visual indicator distinguishing
      normal assignments from overrides. No i18n keys for lastMinute/ultimaHora
      in any locale. Grep for last.minute|ultima.hora|lastMinute returns zero
      results. QA plan created with 5 validation checks (4 must_pass, 1 should_pass).

  post_validation:
    timestamp: "2026-02-19"
    status: passed
    phase: "2 of 3"
    commits:
      - hash: 162c74b
        message: "feat(agenda): show last-minute assignment label on speaker override (CR-121)"
      - hash: 8ec4f3a
        message: "feat(i18n): add changeConfirmTitle/Message and lastMinuteAssignment keys in 3 locales (CR-115, CR-121)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 3216
    tester_tests_total: 3216
    tester_suite_passed: 3216
    tester_suite_total: 3216

    must_pass_results:
      - id: CR121-VC-01
        description: "'(Last-minute assignment)' label shown when speaker has override name"
        status: PASSED
        evidence: |
          AgendaForm.tsx:656-660 {hasOverride && !isEditing && (
            <Text style={[styles.lastMinuteLabel, { color: colors.textTertiary }]}>
              {t('agenda.lastMinuteAssignment')}
            </Text>
          )}
          hasOverride = overrideName !== null && overrideName !== speakerName (line 592).
          Label renders when override is active AND not in editing mode.

      - id: CR121-VC-02
        description: "Label NOT shown when speaker comes from normal assignment flow"
        status: PASSED
        evidence: |
          AgendaForm.tsx:592 hasOverride = overrideName !== null && overrideName !== speakerName.
          When overrideName is null (normal flow), hasOverride is false.
          When overrideName equals speakerName, hasOverride is false.
          Line 656 condition {hasOverride && !isEditing} prevents label render in both cases.

      - id: CR121-VC-03
        description: "i18n keys exist for all 3 locales"
        status: PASSED
        evidence: |
          pt-BR.json:227 "lastMinuteAssignment": "(Designao de ltima hora)"
          en.json:227 "lastMinuteAssignment": "(Last-minute assignment)"
          es.json:227 "lastMinuteAssignment": "(Designacin de ltima hora)"
          All 3 locales have the key under agenda namespace.

      - id: CR121-VC-04
        description: "Label disappears when override is cleared (reverted to original)"
        status: PASSED
        evidence: |
          AgendaForm.tsx:611-614 handleRevert calls onEditOverride(null) and setIsEditing(false).
          When override is cleared, overrideName becomes null, hasOverride becomes false,
          and the condition at line 656 {hasOverride && !isEditing} evaluates to false.
          Label is removed from render.

    should_pass_results:
      - id: CR121-VC-05
        description: "Label styling is visually distinct but non-intrusive"
        status: PASSED
        evidence: |
          AgendaForm.tsx:915-920 styles.lastMinuteLabel = {
            fontSize: 11, fontStyle: 'italic', marginTop: 2, marginLeft: 2
          }. Color is colors.textTertiary (muted/tertiary color).
          fontSize 11 is smaller than field text (14). fontStyle italic provides
          visual distinction. textTertiary color is subdued. Non-intrusive styling confirmed.

# #############################################################################
# CR-118: SearchInput flex:1 + close button in Settings screens
# #############################################################################

cr_118:
  cr_id: CR-118
  title: "SearchInput flex:1 defensivo + close button in 4 Settings screens"
  type: feature_request
  spec: specs/SPEC_F065_F068.yaml
  qa_plan: qa/QA_PLAN_batch9_phase3.yaml

  pre_validation:
    timestamp: "2026-02-19"
    status: passed
    summary: |
      SearchInput component already used with flex:1 via consumer style props.
      All 6 modal contexts have correct layout pattern. Settings screens
      (members, topics, history, timezone) need flexDirection:row + close button.

  post_validation:
    timestamp: "2026-02-19"
    status: passed
    phase: "3 of 3"
    commits:
      - hash: ff29a6a
        message: "fix(search-input): add flex:1 defensivo to SearchInput container (CR-118)"
      - hash: 244b6e3
        message: "feat(settings): add close button and row layout to search in 4 Settings screens (CR-118)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 3296
    tester_tests_total: 3296

    must_pass_results:
      - id: MP-118-01
        description: "SearchInput container style includes flex:1"
        status: PASSED
        evidence: |
          src/components/SearchInput.tsx:62-66 styles.container = {
            flex: 1, position: 'relative', justifyContent: 'center'
          }. flex:1 confirmed.

      - id: MP-118-02
        description: "MemberSelectorModal search row has SearchInput with flex:1 and Close button"
        status: PASSED
        evidence: |
          src/components/MemberSelectorModal.tsx:62-76: header style has
          flexDirection:'row', alignItems:'center', gap:12. SearchInput with
          searchInput style (flex:1). Close Pressable at right.

      - id: MP-118-03
        description: "TopicSelectorModal search row has SearchInput with flex:1 and Close button"
        status: PASSED
        evidence: |
          src/components/TopicSelectorModal.tsx:79-92: header style has
          flexDirection:'row'. SearchInput with flex:1. Close button at right.

      - id: MP-118-04
        description: "ActorSelector search row has SearchInput with flex:1 and Close button"
        status: PASSED
        evidence: |
          src/components/ActorSelector.tsx:207-218: searchRow style has
          flexDirection:'row', alignItems:'center', gap:12. SearchInput
          with flex:1. Close button at right.

      - id: MP-118-05
        description: "HymnSelector search row has SearchInput with flex:1 and Close button"
        status: PASSED
        evidence: |
          src/components/HymnSelector.tsx:102-121: modalHeader style has
          flexDirection:'row'. SearchInput with flex:1. Cancel/close button at right.

      - id: MP-118-06
        description: "PrayerSelector search row has SearchInput with flex:1 and Close button"
        status: PASSED
        evidence: |
          src/components/PrayerSelector.tsx:130-155: modalHeader style has
          flexDirection:'row', gap:12. SearchInput with flex:1. Close button at right.

      - id: MP-118-07
        description: "AgendaForm HymnSelectorModal search row has SearchInput with flex:1 and Close"
        status: PASSED
        evidence: |
          src/components/AgendaForm.tsx:740-750: sheetSearchRow style has
          flexDirection:'row', alignItems:'center', gap:12. SearchInput with
          searchInput style (flex:1). Close button at right.

      - id: MP-118-08
        description: "Settings members.tsx has close button in search row"
        status: PASSED
        evidence: |
          src/app/(tabs)/settings/members.tsx:557-567: searchContainer has
          flexDirection:'row', alignItems:'center', gap:12.
          Pressable with t('common.close') and onPress setSearch('').

      - id: MP-118-09
        description: "Settings topics.tsx has close button in search row"
        status: PASSED
        evidence: |
          src/app/(tabs)/settings/topics.tsx:399-410: searchContainer has
          flexDirection:'row', alignItems:'center', gap:12.
          Pressable with t('common.close') and onPress setSearch('').

      - id: MP-118-10
        description: "Settings history.tsx has close button in search row"
        status: PASSED
        evidence: |
          src/app/(tabs)/settings/history.tsx:106-117: searchContainer has
          flexDirection:'row', alignItems:'center', gap:12.
          Pressable with t('common.close') and onPress updateSearch('').

      - id: MP-118-11
        description: "Settings timezone.tsx has close button in search row"
        status: PASSED
        evidence: |
          src/app/(tabs)/settings/timezone.tsx:206-217: searchContainer has
          flexDirection:'row', alignItems:'center', gap:12.
          Pressable with t('common.close') and onPress setSearch('').

    should_pass_results:
      - id: SP-118-01
        description: "SearchInput clear (X) button still appears when text is entered"
        status: PASSED
        evidence: |
          SearchInput.tsx:44 - value.length > 0 renders clearButton Pressable.
          Unchanged from pre-validation.

      - id: SP-118-02
        description: "All existing tests pass"
        status: PASSED
        evidence: |
          npx vitest run: 63 test files, 3296/3296 tests passed.

# #############################################################################
# CR-120: Auto-scroll on card expand
# #############################################################################

cr_120:
  cr_id: CR-120
  title: "Auto-scroll to show expanded card after toggle"
  type: feature_request
  spec: specs/SPEC_F065_F068.yaml
  qa_plan: qa/QA_PLAN_batch9_phase3.yaml

  pre_validation:
    timestamp: "2026-02-19"
    status: passed
    summary: |
      Neither speeches.tsx nor agenda.tsx had auto-scroll logic after card expand.
      FlatList refs existed. Implementation via scrollToIndex with viewPosition:0
      and setTimeout(300ms) was planned.

  post_validation:
    timestamp: "2026-02-19"
    status: passed
    phase: "3 of 3"
    commits:
      - hash: e7bd14e
        message: "feat(speeches): auto-scroll to expanded card on toggle (CR-120)"
      - hash: 8a8e56e
        message: "feat(agenda): auto-scroll to expanded card on toggle (CR-120)"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 3296
    tester_tests_total: 3296

    must_pass_results:
      - id: MP-120-01
        description: "speeches.tsx handleToggle calls scrollToIndex after expansion"
        status: PASSED
        evidence: |
          src/app/(tabs)/speeches.tsx:166-178: After setExpandedDate(date) in else
          branch, finds index via listItems.findIndex, then setTimeout(300ms) calls
          flatListRef.current?.scrollToIndex({ index, animated: true, viewPosition: 0 }).

      - id: MP-120-02
        description: "agenda.tsx handleToggle calls scrollToIndex after expansion"
        status: PASSED
        evidence: |
          src/app/(tabs)/agenda.tsx:128-140: After setExpandedDate(date) in else
          branch, finds index via listItems.findIndex, then setTimeout(300ms) calls
          flatListRef.current?.scrollToIndex({ index, animated: true, viewPosition: 0 }).

      - id: MP-120-03
        description: "Auto-scroll uses viewPosition:0 to align card top with screen top"
        status: PASSED
        evidence: |
          speeches.tsx:175 - viewPosition: 0.
          agenda.tsx:137 - viewPosition: 0.
          Both use viewPosition:0 which aligns item top with viewport top.

      - id: MP-120-04
        description: "Auto-scroll only triggers on expand, not on collapse"
        status: PASSED
        evidence: |
          speeches.tsx:160-161: if (expandedDate === date) { setExpandedDate(null); }
          - collapse branch has NO scrollToIndex.
          speeches.tsx:162-178: else branch has scrollToIndex - expand only.
          agenda.tsx:123-124: collapse branch has NO scrollToIndex.
          agenda.tsx:125-140: else branch has scrollToIndex - expand only.

    should_pass_results:
      - id: SP-120-01
        description: "setTimeout used to defer scroll after render"
        status: PASSED
        evidence: |
          speeches.tsx:171 - setTimeout(() => { scrollToIndex... }, 300).
          agenda.tsx:133 - setTimeout(() => { scrollToIndex... }, 300).
          300ms delay allows layout to complete before scrolling.

      - id: SP-120-02
        description: "All existing tests pass"
        status: PASSED
        evidence: |
          npx vitest run: 63 test files, 3296/3296 tests passed.

# #############################################################################
# CR-123: Recognizing field proportional height with one actor per line
# #############################################################################

cr_123:
  cr_id: CR-123
  title: "Recognizing field proportional height with one actor per line"
  type: feature_request
  spec: specs/SPEC_F065_F068.yaml
  qa_plan: qa/QA_PLAN_batch9_phase3.yaml

  pre_validation:
    timestamp: "2026-02-19"
    status: passed
    summary: |
      Recognizing field used SelectorField with numberOfLines={1} and join(', ').
      Truncated multiple actor names. Needed to display one actor per line with
      proportional height growth.

  post_validation:
    timestamp: "2026-02-19"
    status: passed
    phase: "3 of 3"
    commits:
      - hash: 96fdc83
        message: "feat(agenda): replace SelectorField with Pressable for recognizing field (CR-123)"
      - hash: 97f1e5f
        message: "fix(tests): update recognizing field tests for CR-123 Pressable change"
      - hash: b9a010b
        message: "fix(tests): update batch7 recognizing field test for CR-123 change"

    reviewer_verdict: approved
    reviewer_issues: 0

    tester_verdict: approved
    tester_tests_passed: 3296
    tester_tests_total: 3296

    must_pass_results:
      - id: MP-123-01
        description: "Recognizing field displays actors on separate lines"
        status: PASSED
        evidence: |
          src/components/AgendaForm.tsx:199-208: recognized_names are rendered
          via .map((name, idx) => <Text>) with individual Text elements per name.
          Each name gets its own line via recognizingName style with paddingVertical:2.
          No join(', ') - each name is a separate element.

      - id: MP-123-02
        description: "Recognizing field allows multi-line (not truncated by numberOfLines={1} on container)"
        status: PASSED
        evidence: |
          src/components/AgendaForm.tsx:192-214: The recognizing field uses a
          Pressable (not SelectorField). Each individual name Text has
          numberOfLines={1} for single-name truncation, but the container
          Pressable has no numberOfLines limit. Container grows with each name.

      - id: MP-123-03
        description: "Field height grows proportionally with number of selected actors"
        status: PASSED
        evidence: |
          src/components/AgendaForm.tsx:811-816: selectorField style has
          paddingVertical:8 but NO fixed height or maxHeight.
          AgendaForm.tsx:820-823: recognizingName style has fontSize:15,
          paddingVertical:2. Each name adds ~19px. Container grows naturally.

    should_pass_results:
      - id: SP-123-01
        description: "Empty state shows placeholder text correctly"
        status: PASSED
        evidence: |
          AgendaForm.tsx:199: (agenda.recognized_names?.length ?? 0) > 0 ? ... :
          AgendaForm.tsx:210-212: placeholder Text with t('agenda.recognizing')
          in colors.textTertiary color when no names selected.

      - id: SP-123-02
        description: "Presentation mode NOT affected (keeps comma format)"
        status: PASSED
        evidence: |
          src/hooks/usePresentationMode.ts:83: still uses
          agenda.recognized_names.join(', '). Presentation mode unchanged.

      - id: SP-123-03
        description: "All existing tests pass"
        status: PASSED
        evidence: |
          npx vitest run: 63 test files, 3296/3296 tests passed.
