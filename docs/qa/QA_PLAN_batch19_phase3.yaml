# QA_PLAN - Batch 19 Phase 3
# Navigation & Home redesign: CR-184, CR-185, CR-186, CR-188
# Generated by: QA agent (PRE mode)
# Date: 2026-02-22

metadata:
  batch: 19
  phase: 3
  type: feature_request
  crs: [CR-184, CR-185, CR-186, CR-188]
  status: validated
  validated_at: "2026-02-22"

# ============================================================
# PRE-VALIDATION EVIDENCE
# ============================================================
pre_validation:
  validated: true
  evidence:
    # -- CR-184: Pencil icon on Presentation Screen header --
    - cr: CR-184
      description: "Add pencil icon next to font-size toggle on Presentation Screen header, navigating to Agenda tab with card open for editing"
      current_state:
        file: src/app/presentation.tsx
        lines: "86-118"
        observation: |
          PresentationScreen header has: titleContainer (left), fontToggleButton (Aa/AA), closeButton (X).
          No pencil/edit icon currently exists. No navigation to Agenda tab.
          The screen uses getTodaySundayDate() to determine which sunday to show.
        navigation_pattern: "Currently only router.back() is used (closeButton)"
      what_needs_to_change:
        - "Add a pencil button (U+270F) between fontToggleButton and closeButton in the header"
        - "Pencil onPress navigates to Agenda tab with expandDate param for the selected sunday"
        - "Agenda tab (src/app/(tabs)/agenda.tsx) does NOT currently support expandDate query param (unlike Speeches tab which does via ADR-082)"
        - "Must add useLocalSearchParams and expandDate handling to agenda.tsx similar to speeches.tsx:177-202"

    # -- CR-185: Play button on expanded agenda card header --
    - cr: CR-185
      description: "In expanded agenda card, add play button next to collapse arrow, navigating to Presentation Screen with the selected sunday"
      current_state:
        file: src/app/(tabs)/agenda.tsx
        lines: "340-510"
        observation: |
          AgendaSundayCard expanded header has: dateBlock (left), cardCenter (middle), chevron arrow (right).
          When expanded, shows SundayTypeDropdown + AgendaForm inside expandedContent.
          No play button exists currently.
          PresentationScreen (src/app/presentation.tsx) uses getTodaySundayDate() hardcoded - does NOT accept a date param.
        navigation_pattern: "No outbound navigation from agenda cards currently"
      what_needs_to_change:
        - "Add play button (U+25B6 or similar) next to the chevron in the card header (visible only when expanded)"
        - "Play button onPress navigates to /presentation with the selected sunday date"
        - "PresentationScreen must be updated to accept an optional sundayDate query param, falling back to getTodaySundayDate()"
        - "Or: navigate to /presentation?date=YYYY-MM-DD and PresentationScreen reads it"

    # -- CR-186: Home redesign - Agenda section with sunday card + play icon on Iniciar button --
    - cr: CR-186
      description: "Home - 'Agenda da Reuniao Sacramental' section: add collapsed sunday card below Iniciar button + pencil edit button + play icon on Iniciar button"
      current_state:
        file: src/app/(tabs)/index.tsx
        lines: "20-56"
        observation: |
          HomeTabContent has: sectionTitle ('home.meetingAgendaTitle'), meetingButton ('home.startMeeting' -> /presentation).
          No sunday card is shown. Button is text-only ("Iniciar Reuniao Sacramental"), no play icon.
          Below that: NextSundaysSection, NextAssignmentsSection, InviteManagementSection.
        next_sunday_logic: |
          NextSundaysSection uses getNextSundays(today, 3) to get next 3 sundays.
          Need to determine "next sunday" = if today is Mon-Sat, next sunday; if today is Sunday, today.
          This matches getTodaySundayDate() logic in usePresentationMode.ts:52-60.
      what_needs_to_change:
        - "Add play icon (U+25B6) before 'Iniciar Reuniao Sacramental' text in the button"
        - "Below the button, add a collapsed SundayCard-style card (non-expandable) showing the next sunday"
        - "Card shows: dateBlock (day/month), status lines (same as agenda.tsx collapsed card)"
        - "Right side of card: square pencil button that navigates to Agenda tab with expandDate"
        - "Need to fetch agenda data for the displayed sunday to show status"
        - "Card is for next sunday (Mon-Sat) or today (if Sunday)"

    # -- CR-188: Home - 'Proximos Discursos' section redesign --
    - cr: CR-188
      description: "Home - 'Proximos Discursos': cards become non-expandable, each with pencil edit button navigating to Speeches tab"
      current_state:
        file: src/components/NextSundaysSection.tsx
        lines: "222-284"
        observation: |
          NextSundaysSection renders SundayCard for each of next 3 sundays.
          Cards are EXPANDABLE (onToggle -> setExpandedDate, shows SpeechSlot children when expanded).
          Uses MemberSelectorModal and TopicSelectorModal for inline editing.
          Section title uses 'home.nextAssignments' key (already renamed to "Proximos Discursos" in Phase 2).
        cards_behavior: "Currently fully expandable with full speech editing inline"
      what_needs_to_change:
        - "Make SundayCards non-expandable (remove onToggle, never expand)"
        - "Add a square pencil button to the right of each card (same style as CR-186)"
        - "Pencil onPress navigates to Speeches tab with expandDate param for that sunday"
        - "Remove all inline editing capabilities (MemberSelectorModal, TopicSelectorModal, SpeechSlot children)"
        - "Cards become read-only summary cards showing LEDs + speaker names"

# ============================================================
# ACCEPTANCE CRITERIA (derived from CRs)
# ============================================================
acceptance_criteria:
  # --- CR-184 ---
  - id: AC-184-01
    cr: CR-184
    description: "Pencil icon (U+270F) visible in PresentationScreen header, next to font size toggle"
    priority: must_pass

  - id: AC-184-02
    cr: CR-184
    description: "Pencil icon has accessibilityRole='button' and appropriate accessibilityLabel"
    priority: should_pass

  - id: AC-184-03
    cr: CR-184
    description: "Pressing pencil navigates to Agenda tab with expandDate param set to the current sunday date"
    priority: must_pass

  - id: AC-184-04
    cr: CR-184
    description: "Agenda tab receives expandDate param, expands the corresponding card, and scrolls to it"
    priority: must_pass

  - id: AC-184-05
    cr: CR-184
    description: "expandDate param is cleared after handling to prevent re-triggering on tab refocus"
    priority: must_pass

  - id: AC-184-06
    cr: CR-184
    description: "Pencil button styling matches existing header buttons (36x36 circle, surfaceVariant background)"
    priority: should_pass

  # --- CR-185 ---
  - id: AC-185-01
    cr: CR-185
    description: "Play button (U+25B6 or similar play icon) visible in expanded agenda card header, next to collapse arrow"
    priority: must_pass

  - id: AC-185-02
    cr: CR-185
    description: "Play button only visible when the card is expanded (not in collapsed state)"
    priority: must_pass

  - id: AC-185-03
    cr: CR-185
    description: "Pressing play navigates to PresentationScreen with the selected sunday date"
    priority: must_pass

  - id: AC-185-04
    cr: CR-185
    description: "PresentationScreen can receive and use a sundayDate param instead of always using getTodaySundayDate()"
    priority: must_pass

  - id: AC-185-05
    cr: CR-185
    description: "Play button has accessibilityRole='button' and appropriate accessibilityLabel"
    priority: should_pass

  - id: AC-185-06
    cr: CR-185
    description: "Play button not shown for non-expandable cards (Gen Conf, Stake Conf)"
    priority: should_pass

  # --- CR-186 ---
  - id: AC-186-01
    cr: CR-186
    description: "Play icon (U+25B6) appears before the word 'Iniciar' in the meeting button on Home"
    priority: must_pass

  - id: AC-186-02
    cr: CR-186
    description: "Collapsed sunday card appears below the Iniciar button in the 'Agenda da Reuniao Sacramental' section"
    priority: must_pass

  - id: AC-186-03
    cr: CR-186
    description: "Sunday card shows the next sunday (Mon-Sat) or today's date (if Sunday)"
    priority: must_pass

  - id: AC-186-04
    cr: CR-186
    description: "Sunday card is identical visual style to collapsed cards in Agenda tab (dateBlock + status lines)"
    priority: must_pass

  - id: AC-186-05
    cr: CR-186
    description: "Sunday card is NOT expandable (no onToggle, no expansion)"
    priority: must_pass

  - id: AC-186-06
    cr: CR-186
    description: "Square pencil button on the right side of the sunday card"
    priority: must_pass

  - id: AC-186-07
    cr: CR-186
    description: "Pencil button navigates to Agenda tab with expandDate param for that sunday"
    priority: must_pass

  - id: AC-186-08
    cr: CR-186
    description: "Pencil button style is identical to the one in CR-188 (consistent design)"
    priority: should_pass

  # --- CR-188 ---
  - id: AC-188-01
    cr: CR-188
    description: "SundayCards in 'Proximos Discursos' section are no longer expandable"
    priority: must_pass

  - id: AC-188-02
    cr: CR-188
    description: "Each card has a pencil button (U+270F) on the right side"
    priority: must_pass

  - id: AC-188-03
    cr: CR-188
    description: "Pencil button navigates to Speeches tab with expandDate param for that sunday"
    priority: must_pass

  - id: AC-188-04
    cr: CR-188
    description: "Inline editing removed: no MemberSelectorModal, TopicSelectorModal, or SpeechSlot children in NextSundaysSection"
    priority: must_pass

  - id: AC-188-05
    cr: CR-188
    description: "Cards still display collapsed summary (LEDs + speaker names) as read-only"
    priority: must_pass

  - id: AC-188-06
    cr: CR-188
    description: "Pencil button style identical to CR-186 pencil button"
    priority: should_pass

# ============================================================
# EDGE CASES
# ============================================================
edge_cases:
  - id: EC-P3-01
    cr: CR-184
    description: "Agenda tab expandDate for a date that is Gen Conf / Stake Conf (non-expandable card)"
    expected: "Card is not expanded since it has no agenda form; param is cleared"
    priority: should_pass

  - id: EC-P3-02
    cr: CR-185
    description: "Play button on agenda card for a past sunday"
    expected: "PresentationScreen loads and displays data for that past sunday"
    priority: should_pass

  - id: EC-P3-03
    cr: CR-186
    description: "Home sunday card when today is Sunday"
    expected: "Card shows today's date (not next Sunday)"
    priority: must_pass

  - id: EC-P3-04
    cr: CR-186
    description: "Home sunday card when today is a weekday"
    expected: "Card shows next Sunday's date"
    priority: must_pass

  - id: EC-P3-05
    cr: CR-188
    description: "Observer role sees cards but pencil button behavior"
    expected: "Observer should see cards. Pencil may be hidden or disabled for observer since they cannot edit"
    priority: should_pass

  - id: EC-P3-06
    cr: CR-185
    description: "PresentationScreen date param fallback"
    expected: "If no date param provided, falls back to getTodaySundayDate() (backward compatible)"
    priority: must_pass

  - id: EC-P3-07
    cr: CR-186
    description: "Home sunday card shows correct status for special meeting types"
    expected: "Card shows exception label (e.g., 'Reuniao de Testemunhos') instead of speech LEDs"
    priority: should_pass

  - id: EC-P3-08
    cr: CR-188
    description: "NextSundaysSection cleanup: no unused modal state or handlers"
    expected: "Removed MemberSelectorModal, TopicSelectorModal, speakerModalSpeechId, topicModalSpeechId state"
    priority: should_pass

# ============================================================
# VALIDATION CHECKS (for POST mode)
# ============================================================
validation_checks:
  # --- CR-184: Pencil in Presentation header ---
  - id: VC-184-01
    type: code_search
    description: "PresentationScreen has pencil button in header"
    target_file: src/app/presentation.tsx
    search_pattern: "\\u270F|pencil|edit.*icon"
    criteria: must_pass
    maps_to: [AC-184-01]

  - id: VC-184-02
    type: code_search
    description: "PresentationScreen pencil navigates to agenda tab with expandDate"
    target_file: src/app/presentation.tsx
    search_pattern: "agenda.*expandDate|pathname.*agenda.*params"
    criteria: must_pass
    maps_to: [AC-184-03]

  - id: VC-184-03
    type: code_search
    description: "Agenda tab accepts expandDate query param"
    target_file: src/app/(tabs)/agenda.tsx
    search_pattern: "useLocalSearchParams.*expandDate|params\\.expandDate"
    criteria: must_pass
    maps_to: [AC-184-04]

  - id: VC-184-04
    type: code_search
    description: "Agenda tab clears expandDate after handling"
    target_file: src/app/(tabs)/agenda.tsx
    search_pattern: "setParams.*expandDate.*undefined|expandDate.*undefined"
    criteria: must_pass
    maps_to: [AC-184-05]

  - id: VC-184-05
    type: code_search
    description: "Pencil button has accessibility attributes"
    target_file: src/app/presentation.tsx
    search_pattern: "accessibilityRole.*button"
    criteria: should_pass
    maps_to: [AC-184-02]

  # --- CR-185: Play button in expanded agenda card ---
  - id: VC-185-01
    type: code_search
    description: "Agenda card has play button"
    target_file: src/app/(tabs)/agenda.tsx
    search_pattern: "\\u25B6|play|\\u25BA"
    criteria: must_pass
    maps_to: [AC-185-01]

  - id: VC-185-02
    type: code_search
    description: "Play button only in expanded state"
    target_file: src/app/(tabs)/agenda.tsx
    search_pattern: "isExpanded.*play|play.*isExpanded"
    criteria: must_pass
    maps_to: [AC-185-02]

  - id: VC-185-03
    type: code_search
    description: "Play navigates to presentation with date param"
    target_file: src/app/(tabs)/agenda.tsx
    search_pattern: "presentation.*date|router\\.push.*presentation"
    criteria: must_pass
    maps_to: [AC-185-03]

  - id: VC-185-04
    type: code_search
    description: "PresentationScreen accepts sundayDate/date param"
    target_file: src/app/presentation.tsx
    search_pattern: "useLocalSearchParams|searchParams|params\\.date|params\\.sundayDate"
    criteria: must_pass
    maps_to: [AC-185-04]

  # --- CR-186: Home section redesign ---
  - id: VC-186-01
    type: code_search
    description: "Play icon in Iniciar button"
    target_file: src/app/(tabs)/index.tsx
    search_pattern: "\\u25B6|\\u25BA|play.*icon|play.*Iniciar"
    criteria: must_pass
    maps_to: [AC-186-01]

  - id: VC-186-02
    type: code_search
    description: "Home shows a collapsed sunday card component"
    target_file: src/app/(tabs)/index.tsx
    search_pattern: "SundayCard|sundayCard|AgendaSundayCard|HomeSundayCard|dateBlock|dateDay"
    criteria: must_pass
    maps_to: [AC-186-02]

  - id: VC-186-03
    type: code_search
    description: "Home sunday card uses getTodaySundayDate or getNextSundays for date selection"
    target_file: src/app/(tabs)/index.tsx
    search_pattern: "getTodaySundayDate|getNextSundays|nextSunday"
    criteria: must_pass
    maps_to: [AC-186-03]

  - id: VC-186-04
    type: code_search
    description: "Home sunday card is not expandable"
    target_file: src/app/(tabs)/index.tsx
    search_pattern: "expandable.*false|onToggle.*undefined|no.*expand"
    criteria: must_pass
    maps_to: [AC-186-05]

  - id: VC-186-05
    type: code_search
    description: "Pencil button on home sunday card navigates to agenda tab"
    target_file: src/app/(tabs)/index.tsx
    search_pattern: "\\u270F|pencil.*agenda|agenda.*expandDate"
    criteria: must_pass
    maps_to: [AC-186-06, AC-186-07]

  # --- CR-188: Proximos Discursos non-expandable ---
  - id: VC-188-01
    type: code_search
    description: "NextSundaysSection cards are non-expandable"
    target_file: src/components/NextSundaysSection.tsx
    search_pattern: "expandedDate|setExpandedDate|onToggle"
    criteria: must_pass
    maps_to: [AC-188-01]
    note: "These should be REMOVED or not wired to expansion. onToggle should be undefined or absent."

  - id: VC-188-02
    type: code_search
    description: "NextSundaysSection has pencil button per card"
    target_file: src/components/NextSundaysSection.tsx
    search_pattern: "\\u270F|pencil|edit.*button"
    criteria: must_pass
    maps_to: [AC-188-02]

  - id: VC-188-03
    type: code_search
    description: "Pencil navigates to Speeches tab with expandDate"
    target_file: src/components/NextSundaysSection.tsx
    search_pattern: "speeches.*expandDate|pathname.*speeches.*params"
    criteria: must_pass
    maps_to: [AC-188-03]

  - id: VC-188-04
    type: code_search
    description: "Inline editing removed from NextSundaysSection"
    target_file: src/components/NextSundaysSection.tsx
    search_pattern: "MemberSelectorModal|TopicSelectorModal|SpeechSlot"
    criteria: must_pass
    maps_to: [AC-188-04]
    note: "These should NOT be present (or should be removed). Inverse check."

  - id: VC-188-05
    type: code_search
    description: "Cards still show collapsed summary with LEDs"
    target_file: src/components/NextSundaysSection.tsx
    search_pattern: "SundayCard|StatusLED|speakerName|speechRow"
    criteria: must_pass
    maps_to: [AC-188-05]

# ============================================================
# IMPLEMENTATION DEPENDENCIES & RISKS
# ============================================================
dependencies:
  - source: CR-185
    target: CR-184
    description: "Both need PresentationScreen to accept date param (CR-185 sends it, CR-184 reads from the sunday shown)"

  - source: CR-184
    target: agenda_expandDate
    description: "CR-184 needs agenda.tsx to support expandDate param (new capability, similar to speeches.tsx ADR-082)"

  - source: CR-186
    target: CR-184
    description: "CR-186 pencil also navigates to Agenda tab with expandDate, same mechanism as CR-184"

risks:
  - id: RISK-01
    description: "PresentationScreen currently hardcodes getTodaySundayDate(). Changing to accept a param needs careful fallback."
    mitigation: "Use useLocalSearchParams with optional date, fallback to getTodaySundayDate() when not provided"

  - id: RISK-02
    description: "Agenda tab does not currently support expandDate (unlike Speeches tab). Need to add full handling."
    mitigation: "Follow same pattern as speeches.tsx:177-202 (ADR-082)"

  - id: RISK-03
    description: "NextSundaysSection removal of expandable cards is a significant refactor removing substantial code"
    mitigation: "Carefully remove state, modals, handlers; ensure SundayCard still renders collapsed summary correctly"

  - id: RISK-04
    description: "Home tab sunday card needs agenda data fetched. Currently index.tsx does not fetch any agenda data."
    mitigation: "Add useAgenda or useAgendaRange hook call for the displayed sunday date"
